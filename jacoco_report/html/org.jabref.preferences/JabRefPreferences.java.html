<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JabRefPreferences.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JabRef</a> &gt; <a href="index.source.html" class="el_package">org.jabref.preferences</a> &gt; <span class="el_source">JabRefPreferences.java</span></div><h1>JabRefPreferences.java</h1><pre class="source lang-java linenums">package org.jabref.preferences;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.Reader;
import java.io.StringReader;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.EnumSet;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.Set;
import java.util.TreeSet;
import java.util.UUID;
import java.util.prefs.BackingStoreException;
import java.util.prefs.InvalidPreferencesFormatException;
import java.util.prefs.Preferences;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import javafx.beans.InvalidationListener;
import javafx.collections.ListChangeListener;
import javafx.collections.ObservableList;
import javafx.collections.SetChangeListener;
import javafx.scene.control.TableColumn.SortType;

import org.jabref.gui.Globals;
import org.jabref.gui.autocompleter.AutoCompleteFirstNameMode;
import org.jabref.gui.autocompleter.AutoCompletePreferences;
import org.jabref.gui.duplicationFinder.DuplicateResolverDialog;
import org.jabref.gui.entryeditor.EntryEditorPreferences;
import org.jabref.gui.externalfiletype.ExternalFileType;
import org.jabref.gui.externalfiletype.ExternalFileTypes;
import org.jabref.gui.groups.GroupViewMode;
import org.jabref.gui.groups.GroupsPreferences;
import org.jabref.gui.keyboard.KeyBindingRepository;
import org.jabref.gui.maintable.ColumnPreferences;
import org.jabref.gui.maintable.MainTableColumnModel;
import org.jabref.gui.maintable.MainTablePreferences;
import org.jabref.gui.maintable.NameDisplayPreferences;
import org.jabref.gui.maintable.NameDisplayPreferences.AbbreviationStyle;
import org.jabref.gui.maintable.NameDisplayPreferences.DisplayStyle;
import org.jabref.gui.mergeentries.DiffMode;
import org.jabref.gui.push.PushToApplications;
import org.jabref.gui.search.SearchDisplayMode;
import org.jabref.gui.sidepane.SidePaneType;
import org.jabref.gui.specialfields.SpecialFieldsPreferences;
import org.jabref.gui.theme.Theme;
import org.jabref.logic.JabRefException;
import org.jabref.logic.bibtex.FieldPreferences;
import org.jabref.logic.citationkeypattern.CitationKeyPatternPreferences;
import org.jabref.logic.citationkeypattern.GlobalCitationKeyPattern;
import org.jabref.logic.citationstyle.CitationStyle;
import org.jabref.logic.citationstyle.CitationStylePreviewLayout;
import org.jabref.logic.cleanup.FieldFormatterCleanups;
import org.jabref.logic.exporter.BibDatabaseWriter;
import org.jabref.logic.exporter.MetaDataSerializer;
import org.jabref.logic.exporter.SelfContainedSaveConfiguration;
import org.jabref.logic.exporter.TemplateExporter;
import org.jabref.logic.importer.ImportFormatPreferences;
import org.jabref.logic.importer.ImporterPreferences;
import org.jabref.logic.importer.fetcher.ACMPortalFetcher;
import org.jabref.logic.importer.fetcher.DBLPFetcher;
import org.jabref.logic.importer.fetcher.DoiFetcher;
import org.jabref.logic.importer.fetcher.GrobidPreferences;
import org.jabref.logic.importer.fetcher.IEEE;
import org.jabref.logic.importer.fetcher.SpringerFetcher;
import org.jabref.logic.importer.fileformat.CustomImporter;
import org.jabref.logic.importer.util.MetaDataParser;
import org.jabref.logic.journals.JournalAbbreviationPreferences;
import org.jabref.logic.l10n.Language;
import org.jabref.logic.l10n.Localization;
import org.jabref.logic.layout.LayoutFormatterPreferences;
import org.jabref.logic.layout.TextBasedPreviewLayout;
import org.jabref.logic.layout.format.NameFormatterPreferences;
import org.jabref.logic.net.ProxyPreferences;
import org.jabref.logic.net.ssl.SSLPreferences;
import org.jabref.logic.net.ssl.TrustStoreManager;
import org.jabref.logic.openoffice.OpenOfficePreferences;
import org.jabref.logic.openoffice.style.StyleLoader;
import org.jabref.logic.preferences.DOIPreferences;
import org.jabref.logic.preferences.FetcherApiKey;
import org.jabref.logic.preferences.OwnerPreferences;
import org.jabref.logic.preferences.TimestampPreferences;
import org.jabref.logic.preview.PreviewLayout;
import org.jabref.logic.protectedterms.ProtectedTermsLoader;
import org.jabref.logic.protectedterms.ProtectedTermsPreferences;
import org.jabref.logic.push.CitationCommandString;
import org.jabref.logic.remote.RemotePreferences;
import org.jabref.logic.shared.prefs.SharedDatabasePreferences;
import org.jabref.logic.shared.security.Password;
import org.jabref.logic.util.OS;
import org.jabref.logic.util.Version;
import org.jabref.logic.util.io.AutoLinkPreferences;
import org.jabref.logic.util.io.FileHistory;
import org.jabref.logic.xmp.XmpPreferences;
import org.jabref.model.database.BibDatabaseMode;
import org.jabref.model.entry.BibEntryType;
import org.jabref.model.entry.BibEntryTypesManager;
import org.jabref.model.entry.field.Field;
import org.jabref.model.entry.field.FieldFactory;
import org.jabref.model.entry.field.InternalField;
import org.jabref.model.entry.field.StandardField;
import org.jabref.model.entry.types.EntryType;
import org.jabref.model.entry.types.EntryTypeFactory;
import org.jabref.model.groups.GroupHierarchyType;
import org.jabref.model.metadata.SaveOrder;
import org.jabref.model.metadata.SelfContainedSaveOrder;
import org.jabref.model.search.rules.SearchRules;
import org.jabref.model.strings.StringUtil;

import com.github.javakeyring.Keyring;
import com.github.javakeyring.PasswordAccessException;
import com.tobiasdiez.easybind.EasyBind;
import jakarta.inject.Singleton;
import org.jvnet.hk2.annotations.Service;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * The {@code JabRefPreferences} class provides the preferences and their defaults using the JDK {@code java.util.prefs}
 * class.
 * &lt;p&gt;
 * Internally it defines symbols used to pick a value from the {@code java.util.prefs} interface and keeps a hashmap
 * with all the default values.
 * &lt;p&gt;
 * There are still some similar preferences classes ({@link org.jabref.logic.openoffice.OpenOfficePreferences} and {@link org.jabref.logic.shared.prefs.SharedDatabasePreferences}) which also use
 * the {@code java.util.prefs} API.
 */
@Singleton
@Service
public class JabRefPreferences implements PreferencesService {

    // Push to application preferences
    public static final String PUSH_EMACS_PATH = &quot;emacsPath&quot;;
    public static final String PUSH_EMACS_ADDITIONAL_PARAMETERS = &quot;emacsParameters&quot;;
    public static final String PUSH_LYXPIPE = &quot;lyxpipe&quot;;
    public static final String PUSH_TEXSTUDIO_PATH = &quot;TeXstudioPath&quot;;
    public static final String PUSH_WINEDT_PATH = &quot;winEdtPath&quot;;
    public static final String PUSH_TEXMAKER_PATH = &quot;texmakerPath&quot;;
    public static final String PUSH_VIM_SERVER = &quot;vimServer&quot;;
    public static final String PUSH_VIM = &quot;vim&quot;;
    public static final String PUSH_SUBLIME_TEXT_PATH = &quot;sublimeTextPath&quot;;

    /* contents of the defaults HashMap that are defined in this class.
     * There are more default parameters in this map which belong to separate preference classes.
     */
    public static final String EXTERNAL_FILE_TYPES = &quot;externalFileTypes&quot;;
    public static final String THEME = &quot;fxTheme&quot;;
    public static final String THEME_SYNC_OS = &quot;themeSyncOs&quot;;
    public static final String LANGUAGE = &quot;language&quot;;
    public static final String NAMES_LAST_ONLY = &quot;namesLastOnly&quot;;
    public static final String ABBR_AUTHOR_NAMES = &quot;abbrAuthorNames&quot;;
    public static final String NAMES_NATBIB = &quot;namesNatbib&quot;;
    public static final String NAMES_FIRST_LAST = &quot;namesFf&quot;;
    public static final String BIBLATEX_DEFAULT_MODE = &quot;biblatexMode&quot;;
    public static final String NAMES_AS_IS = &quot;namesAsIs&quot;;
    public static final String ENTRY_EDITOR_HEIGHT = &quot;entryEditorHeightFX&quot;;
    public static final String AUTO_RESIZE_MODE = &quot;autoResizeMode&quot;;
    public static final String WINDOW_MAXIMISED = &quot;windowMaximised&quot;;
    public static final String WINDOW_FULLSCREEN = &quot;windowFullscreen&quot;;

    public static final String REFORMAT_FILE_ON_SAVE_AND_EXPORT = &quot;reformatFileOnSaveAndExport&quot;;
    public static final String EXPORT_IN_ORIGINAL_ORDER = &quot;exportInOriginalOrder&quot;;
    public static final String EXPORT_IN_SPECIFIED_ORDER = &quot;exportInSpecifiedOrder&quot;;

    public static final String EXPORT_PRIMARY_SORT_FIELD = &quot;exportPriSort&quot;;
    public static final String EXPORT_PRIMARY_SORT_DESCENDING = &quot;exportPriDescending&quot;;
    public static final String EXPORT_SECONDARY_SORT_FIELD = &quot;exportSecSort&quot;;
    public static final String EXPORT_SECONDARY_SORT_DESCENDING = &quot;exportSecDescending&quot;;
    public static final String EXPORT_TERTIARY_SORT_FIELD = &quot;exportTerSort&quot;;
    public static final String EXPORT_TERTIARY_SORT_DESCENDING = &quot;exportTerDescending&quot;;
    public static final String NEWLINE = &quot;newline&quot;;

    // Variable names have changed to ensure backward compatibility with pre 5.0 releases of JabRef
    // Pre 5.1: columnNames, columnWidths, columnSortTypes, columnSortOrder
    public static final String COLUMN_NAMES = &quot;mainTableColumnNames&quot;;
    public static final String COLUMN_WIDTHS = &quot;mainTableColumnWidths&quot;;
    public static final String COLUMN_SORT_TYPES = &quot;mainTableColumnSortTypes&quot;;
    public static final String COLUMN_SORT_ORDER = &quot;mainTableColumnSortOrder&quot;;

    public static final String SEARCH_DIALOG_COLUMN_WIDTHS = &quot;searchTableColumnWidths&quot;;
    public static final String SEARCH_DIALOG_COLUMN_SORT_TYPES = &quot;searchDialogColumnSortTypes&quot;;
    public static final String SEARCH_DIALOG_COLUMN_SORT_ORDER = &quot;searchDalogColumnSortOrder&quot;;

    public static final String SIDE_PANE_COMPONENT_PREFERRED_POSITIONS = &quot;sidePaneComponentPreferredPositions&quot;;
    public static final String SIDE_PANE_COMPONENT_NAMES = &quot;sidePaneComponentNames&quot;;
    public static final String XMP_PRIVACY_FILTERS = &quot;xmpPrivacyFilters&quot;;
    public static final String USE_XMP_PRIVACY_FILTER = &quot;useXmpPrivacyFilter&quot;;
    public static final String DEFAULT_SHOW_SOURCE = &quot;defaultShowSource&quot;;
    // Window sizes
    public static final String SIZE_Y = &quot;mainWindowSizeY&quot;;
    public static final String SIZE_X = &quot;mainWindowSizeX&quot;;
    public static final String POS_Y = &quot;mainWindowPosY&quot;;
    public static final String POS_X = &quot;mainWindowPosX&quot;;

    public static final String LAST_EDITED = &quot;lastEdited&quot;;
    public static final String OPEN_LAST_EDITED = &quot;openLastEdited&quot;;
    public static final String LAST_FOCUSED = &quot;lastFocused&quot;;
    public static final String AUTO_OPEN_FORM = &quot;autoOpenForm&quot;;
    public static final String IMPORT_WORKING_DIRECTORY = &quot;importWorkingDirectory&quot;;
    public static final String LAST_USED_EXPORT = &quot;lastUsedExport&quot;;
    public static final String EXPORT_WORKING_DIRECTORY = &quot;exportWorkingDirectory&quot;;
    public static final String WORKING_DIRECTORY = &quot;workingDirectory&quot;;
    public static final String BACKUP_DIRECTORY = &quot;backupDirectory&quot;;
    public static final String CREATE_BACKUP = &quot;createBackup&quot;;

    public static final String KEYWORD_SEPARATOR = &quot;groupKeywordSeparator&quot;;
    public static final String AUTO_ASSIGN_GROUP = &quot;autoAssignGroup&quot;;
    public static final String DISPLAY_GROUP_COUNT = &quot;displayGroupCount&quot;;
    public static final String EXTRA_FILE_COLUMNS = &quot;extraFileColumns&quot;;
    public static final String OVERRIDE_DEFAULT_FONT_SIZE = &quot;overrideDefaultFontSize&quot;;
    public static final String MAIN_FONT_SIZE = &quot;mainFontSize&quot;;

    public static final String RECENT_DATABASES = &quot;recentDatabases&quot;;
    public static final String MEMORY_STICK_MODE = &quot;memoryStickMode&quot;;
    public static final String SHOW_ADVANCED_HINTS = &quot;showAdvancedHints&quot;;
    public static final String DEFAULT_ENCODING = &quot;defaultEncoding&quot;;

    public static final String BASE_DOI_URI = &quot;baseDOIURI&quot;;
    public static final String USE_CUSTOM_DOI_URI = &quot;useCustomDOIURI&quot;;

    public static final String USE_OWNER = &quot;useOwner&quot;;
    public static final String DEFAULT_OWNER = &quot;defaultOwner&quot;;
    public static final String OVERWRITE_OWNER = &quot;overwriteOwner&quot;;

    // Required for migration from pre-v5.3 only
    public static final String UPDATE_TIMESTAMP = &quot;updateTimestamp&quot;;
    public static final String TIME_STAMP_FIELD = &quot;timeStampField&quot;;
    public static final String TIME_STAMP_FORMAT = &quot;timeStampFormat&quot;;

    public static final String ADD_CREATION_DATE = &quot;addCreationDate&quot;;
    public static final String ADD_MODIFICATION_DATE = &quot;addModificationDate&quot;;

    public static final String WARN_ABOUT_DUPLICATES_IN_INSPECTION = &quot;warnAboutDuplicatesInInspection&quot;;
    public static final String NON_WRAPPABLE_FIELDS = &quot;nonWrappableFields&quot;;
    public static final String RESOLVE_STRINGS_FOR_FIELDS = &quot;resolveStringsForFields&quot;;
    public static final String DO_NOT_RESOLVE_STRINGS = &quot;doNotResolveStrings&quot;;

    // merge related
    public static final String MERGE_ENTRIES_DIFF_MODE = &quot;mergeEntriesDiffMode&quot;;
    public static final String MERGE_ENTRIES_SHOULD_SHOW_DIFF = &quot;mergeEntriesShouldShowDiff&quot;;
    public static final String MERGE_ENTRIES_SHOULD_SHOW_UNIFIED_DIFF = &quot;mergeEntriesShouldShowUnifiedDiff&quot;;
    public static final String MERGE_ENTRIES_HIGHLIGHT_WORDS = &quot;mergeEntriesHighlightWords&quot;;

    public static final String MERGE_SHOW_ONLY_CHANGED_FIELDS = &quot;mergeShowOnlyChangedFields&quot;;

    public static final String SHOW_USER_COMMENTS_FIELDS = &quot;showUserCommentsFields&quot;;

    public static final String MERGE_APPLY_TO_ALL_ENTRIES = &quot;mergeApplyToAllEntries&quot;;

    public static final String DUPLICATE_RESOLVER_DECISION_RESULT_ALL_ENTRIES = &quot;duplicateResolverDecisionResult&quot;;

    public static final String CUSTOM_EXPORT_FORMAT = &quot;customExportFormat&quot;;
    public static final String CUSTOM_IMPORT_FORMAT = &quot;customImportFormat&quot;;
    public static final String KEY_PATTERN_REGEX = &quot;KeyPatternRegex&quot;;
    public static final String KEY_PATTERN_REPLACEMENT = &quot;KeyPatternReplacement&quot;;
    public static final String CONSOLE_COMMAND = &quot;consoleCommand&quot;;
    public static final String USE_DEFAULT_CONSOLE_APPLICATION = &quot;useDefaultConsoleApplication&quot;;
    public static final String USE_DEFAULT_FILE_BROWSER_APPLICATION = &quot;userDefaultFileBrowserApplication&quot;;
    public static final String FILE_BROWSER_COMMAND = &quot;fileBrowserCommand&quot;;
    public static final String MAIN_FILE_DIRECTORY = &quot;fileDirectory&quot;;

    public static final String SEARCH_DISPLAY_MODE = &quot;searchDisplayMode&quot;;
    public static final String SEARCH_CASE_SENSITIVE = &quot;caseSensitiveSearch&quot;;
    public static final String SEARCH_REG_EXP = &quot;regExpSearch&quot;;
    public static final String SEARCH_FULLTEXT = &quot;fulltextSearch&quot;;
    public static final String SEARCH_KEEP_SEARCH_STRING = &quot;keepSearchString&quot;;
    public static final String SEARCH_KEEP_GLOBAL_WINDOW_ON_TOP = &quot;keepOnTop&quot;;
    public static final String SEARCH_WINDOW_HEIGHT = &quot;searchWindowHeight&quot;;
    public static final String SEARCH_WINDOW_WIDTH = &quot;searchWindowWidth&quot;;
    public static final String SEARCH_CATALOGS = &quot;searchCatalogs&quot;;
    public static final String IMPORTERS_ENABLED = &quot;importersEnabled&quot;;
    public static final String GENERATE_KEY_ON_IMPORT = &quot;generateKeyOnImport&quot;;
    public static final String GROBID_ENABLED = &quot;grobidEnabled&quot;;
    public static final String GROBID_OPT_OUT = &quot;grobidOptOut&quot;;
    public static final String GROBID_URL = &quot;grobidURL&quot;;

    public static final String JOURNAL_POPUP = &quot;journalPopup&quot;;

    public static final String DEFAULT_CITATION_KEY_PATTERN = &quot;defaultBibtexKeyPattern&quot;;
    public static final String UNWANTED_CITATION_KEY_CHARACTERS = &quot;defaultUnwantedBibtexKeyCharacters&quot;;
    public static final String CONFIRM_DELETE = &quot;confirmDelete&quot;;
    public static final String WARN_BEFORE_OVERWRITING_KEY = &quot;warnBeforeOverwritingKey&quot;;
    public static final String AVOID_OVERWRITING_KEY = &quot;avoidOverwritingKey&quot;;
    public static final String AUTOLINK_EXACT_KEY_ONLY = &quot;autolinkExactKeyOnly&quot;;
    public static final String AUTOLINK_FILES_ENABLED = &quot;autoLinkFilesEnabled&quot;;
    public static final String SIDE_PANE_WIDTH = &quot;sidePaneWidthFX&quot;;

    public static final String CITE_COMMAND = &quot;citeCommand&quot;;

    public static final String GENERATE_KEYS_BEFORE_SAVING = &quot;generateKeysBeforeSaving&quot;;
    public static final String EMAIL_SUBJECT = &quot;emailSubject&quot;;
    public static final String KINDLE_EMAIL = &quot;kindleEmail&quot;;
    public static final String OPEN_FOLDERS_OF_ATTACHED_FILES = &quot;openFoldersOfAttachedFiles&quot;;
    public static final String KEY_GEN_ALWAYS_ADD_LETTER = &quot;keyGenAlwaysAddLetter&quot;;
    public static final String KEY_GEN_FIRST_LETTER_A = &quot;keyGenFirstLetterA&quot;;
    public static final String ALLOW_INTEGER_EDITION_BIBTEX = &quot;allowIntegerEditionBibtex&quot;;
    public static final String LOCAL_AUTO_SAVE = &quot;localAutoSave&quot;;
    public static final String AUTOLINK_REG_EXP_SEARCH_EXPRESSION_KEY = &quot;regExpSearchExpression&quot;;
    public static final String AUTOLINK_USE_REG_EXP_SEARCH_KEY = &quot;useRegExpSearch&quot;;
    // bibLocAsPrimaryDir is a misleading antique variable name, we keep it for reason of compatibility
    public static final String STORE_RELATIVE_TO_BIB = &quot;bibLocAsPrimaryDir&quot;;
    public static final String SELECTED_FETCHER_INDEX = &quot;selectedFetcherIndex&quot;;
    public static final String WEB_SEARCH_VISIBLE = &quot;webSearchVisible&quot;;
    public static final String GROUP_SIDEPANE_VISIBLE = &quot;groupSidepaneVisible&quot;;
    public static final String CUSTOM_TAB_NAME = &quot;customTabName_&quot;;
    public static final String CUSTOM_TAB_FIELDS = &quot;customTabFields_&quot;;
    public static final String ASK_AUTO_NAMING_PDFS_AGAIN = &quot;AskAutoNamingPDFsAgain&quot;;
    public static final String CLEANUP_JOBS = &quot;CleanUpJobs&quot;;
    public static final String CLEANUP_FIELD_FORMATTERS_ENABLED = &quot;CleanUpFormattersEnabled&quot;;
    public static final String CLEANUP_FIELD_FORMATTERS = &quot;CleanUpFormatters&quot;;
    public static final String IMPORT_FILENAMEPATTERN = &quot;importFileNamePattern&quot;;
    public static final String IMPORT_FILEDIRPATTERN = &quot;importFileDirPattern&quot;;
    public static final String NAME_FORMATTER_VALUE = &quot;nameFormatterFormats&quot;;
    public static final String NAME_FORMATER_KEY = &quot;nameFormatterNames&quot;;
    public static final String PUSH_TO_APPLICATION = &quot;pushToApplication&quot;;
    public static final String SHOW_RECOMMENDATIONS = &quot;showRecommendations&quot;;
    public static final String ACCEPT_RECOMMENDATIONS = &quot;acceptRecommendations&quot;;
    public static final String SHOW_LATEX_CITATIONS = &quot;showLatexCitations&quot;;
    public static final String SEND_LANGUAGE_DATA = &quot;sendLanguageData&quot;;
    public static final String SEND_OS_DATA = &quot;sendOSData&quot;;
    public static final String SEND_TIMEZONE_DATA = &quot;sendTimezoneData&quot;;
    public static final String VALIDATE_IN_ENTRY_EDITOR = &quot;validateInEntryEditor&quot;;
    public static final String SHOW_SCITE_TAB = &quot;showSciteTab&quot;;

    /**
     * The OpenOffice/LibreOffice connection preferences are: OO_PATH main directory for OO/LO installation, used to detect location on Win/macOS when using manual connect OO_EXECUTABLE_PATH path to soffice-file OO_JARS_PATH directory that contains juh.jar, jurt.jar, ridl.jar, unoil.jar OO_SYNC_WHEN_CITING true if the reference list is updated when adding a new citation OO_SHOW_PANEL true if the OO panel is shown on startup OO_USE_ALL_OPEN_DATABASES true if all databases should be used when citing OO_BIBLIOGRAPHY_STYLE_FILE path to the used style file OO_EXTERNAL_STYLE_FILES list with paths to external style files STYLES_*_* size and position of &quot;Select style&quot; dialog
     */
    public static final String OO_EXECUTABLE_PATH = &quot;ooExecutablePath&quot;;
    public static final String OO_SHOW_PANEL = &quot;showOOPanel&quot;;
    public static final String OO_SYNC_WHEN_CITING = &quot;syncOOWhenCiting&quot;;
    public static final String OO_USE_ALL_OPEN_BASES = &quot;useAllOpenBases&quot;;
    public static final String OO_BIBLIOGRAPHY_STYLE_FILE = &quot;ooBibliographyStyleFile&quot;;
    public static final String OO_EXTERNAL_STYLE_FILES = &quot;ooExternalStyleFiles&quot;;

    // Special field preferences
    public static final String SPECIALFIELDSENABLED = &quot;specialFieldsEnabled&quot;;

    // Prefs node for CitationKeyPatterns
    public static final String CITATION_KEY_PATTERNS_NODE = &quot;bibtexkeypatterns&quot;;
    // Prefs node for customized entry types
    public static final String CUSTOMIZED_BIBTEX_TYPES = &quot;customizedBibtexTypes&quot;;
    public static final String CUSTOMIZED_BIBLATEX_TYPES = &quot;customizedBiblatexTypes&quot;;
    // Version
    public static final String VERSION_IGNORED_UPDATE = &quot;versionIgnoreUpdate&quot;;
    public static final String VERSION_CHECK_ENABLED = &quot;versionCheck&quot;;
    // KeyBindings - keys - public because needed for pref migration
    public static final String BINDINGS = &quot;bindings&quot;;

    // AutcompleteFields - public because needed for pref migration
    public static final String AUTOCOMPLETER_COMPLETE_FIELDS = &quot;autoCompleteFields&quot;;

    // Id Entry Generator Preferences
    public static final String ID_ENTRY_GENERATOR = &quot;idEntryGenerator&quot;;

    // String delimiter
<span class="fc" id="L371">    public static final Character STRINGLIST_DELIMITER = ';';</span>

    // Preview - public for pref migrations
    public static final String PREVIEW_STYLE = &quot;previewStyle&quot;;
    public static final String CYCLE_PREVIEW_POS = &quot;cyclePreviewPos&quot;;
    public static final String CYCLE_PREVIEW = &quot;cyclePreview&quot;;
    public static final String PREVIEW_AS_TAB = &quot;previewAsTab&quot;;

    // UI
    private static final String FONT_FAMILY = &quot;fontFamily&quot;;

    // Proxy
    private static final String PROXY_PORT = &quot;proxyPort&quot;;
    private static final String PROXY_HOSTNAME = &quot;proxyHostname&quot;;
    private static final String PROXY_USE = &quot;useProxy&quot;;
    private static final String PROXY_USE_AUTHENTICATION = &quot;useProxyAuthentication&quot;;
    private static final String PROXY_USERNAME = &quot;proxyUsername&quot;;
    private static final String PROXY_PASSWORD = &quot;proxyPassword&quot;;
    private static final String PROXY_PERSIST_PASSWORD = &quot;persistPassword&quot;;

    // Web search
    private static final String FETCHER_CUSTOM_KEY_NAMES = &quot;fetcherCustomKeyNames&quot;;
    private static final String FETCHER_CUSTOM_KEY_USES = &quot;fetcherCustomKeyUses&quot;;
    private static final String FETCHER_CUSTOM_KEY_PERSIST = &quot;fetcherCustomKeyPersist&quot;;

    // SSL
    private static final String TRUSTSTORE_PATH = &quot;truststorePath&quot;;

    // Auto completion
    private static final String AUTO_COMPLETE = &quot;autoComplete&quot;;
    private static final String AUTOCOMPLETER_FIRSTNAME_MODE = &quot;autoCompFirstNameMode&quot;;
    private static final String AUTOCOMPLETER_LAST_FIRST = &quot;autoCompLF&quot;;
    private static final String AUTOCOMPLETER_FIRST_LAST = &quot;autoCompFF&quot;;

    private static final String BIND_NAMES = &quot;bindNames&quot;;
    // User
    private static final String USER_ID = &quot;userId&quot;;

    // Journal
    private static final String EXTERNAL_JOURNAL_LISTS = &quot;externalJournalLists&quot;;
    private static final String USE_AMS_FJOURNAL = &quot;useAMSFJournal&quot;;

    // Telemetry collection
    private static final String COLLECT_TELEMETRY = &quot;collectTelemetry&quot;;
    private static final String ALREADY_ASKED_TO_COLLECT_TELEMETRY = &quot;askedCollectTelemetry&quot;;
    private static final String PROTECTED_TERMS_ENABLED_EXTERNAL = &quot;protectedTermsEnabledExternal&quot;;
    private static final String PROTECTED_TERMS_DISABLED_EXTERNAL = &quot;protectedTermsDisabledExternal&quot;;
    private static final String PROTECTED_TERMS_ENABLED_INTERNAL = &quot;protectedTermsEnabledInternal&quot;;
    private static final String PROTECTED_TERMS_DISABLED_INTERNAL = &quot;protectedTermsDisabledInternal&quot;;

    // GroupViewMode
    private static final String GROUP_INTERSECT_UNION_VIEW_MODE = &quot;groupIntersectUnionViewModes&quot;;
    private static final String DEFAULT_HIERARCHICAL_CONTEXT = &quot;defaultHierarchicalContext&quot;;

    // Dialog states
    private static final String PREFS_EXPORT_PATH = &quot;prefsExportPath&quot;;
    private static final String DOWNLOAD_LINKED_FILES = &quot;downloadLinkedFiles&quot;;
    private static final String FULLTEXT_INDEX_LINKED_FILES = &quot;fulltextIndexLinkedFiles&quot;;

    // Helper string
<span class="fc" id="L431">    private static final String USER_HOME = System.getProperty(&quot;user.home&quot;);</span>

    // Indexes for Strings within stored custom export entries
    private static final int EXPORTER_NAME_INDEX = 0;
    private static final int EXPORTER_FILENAME_INDEX = 1;
    private static final int EXPORTER_EXTENSION_INDEX = 2;

    // Remote
    private static final String USE_REMOTE_SERVER = &quot;useRemoteServer&quot;;
    private static final String REMOTE_SERVER_PORT = &quot;remoteServerPort&quot;;

<span class="fc" id="L442">    private static final Logger LOGGER = LoggerFactory.getLogger(JabRefPreferences.class);</span>
<span class="fc" id="L443">    private static final Preferences PREFS_NODE = Preferences.userRoot().node(&quot;/org/jabref&quot;);</span>

    // The only instance of this class:
    private static JabRefPreferences singleton;
    /**
     * HashMap that contains all preferences which are set by default
     */
<span class="nc" id="L450">    public final Map&lt;String, Object&gt; defaults = new HashMap&lt;&gt;();</span>

    private final Preferences prefs;

    /**
     * Cache variables
     */
    private String userAndHost;

    private LibraryPreferences libraryPreferences;
    private TelemetryPreferences telemetryPreferences;
    private DOIPreferences doiPreferences;
    private OwnerPreferences ownerPreferences;
    private TimestampPreferences timestampPreferences;
    private PreviewPreferences previewPreferences;
    private OpenOfficePreferences openOfficePreferences;
    private SidePanePreferences sidePanePreferences;
    private WorkspacePreferences workspacePreferences;
    private ImporterPreferences importerPreferences;
    private GrobidPreferences grobidPreferences;
    private ProtectedTermsPreferences protectedTermsPreferences;
    private MrDlibPreferences mrDlibPreferences;
    private EntryEditorPreferences entryEditorPreferences;
    private FilePreferences filePreferences;
    private GuiPreferences guiPreferences;
    private RemotePreferences remotePreferences;
    private ProxyPreferences proxyPreferences;
    private SSLPreferences sslPreferences;
    private SearchPreferences searchPreferences;
    private AutoLinkPreferences autoLinkPreferences;
    private ExportPreferences exportPreferences;
    private NameFormatterPreferences nameFormatterPreferences;
    private BibEntryPreferences bibEntryPreferences;
    private InternalPreferences internalPreferences;
    private SpecialFieldsPreferences specialFieldsPreferences;
    private GroupsPreferences groupsPreferences;
    private XmpPreferences xmpPreferences;
    private AutoCompletePreferences autoCompletePreferences;
    private CleanupPreferences cleanupPreferences;
    private PushToApplicationPreferences pushToApplicationPreferences;
    private ExternalApplicationsPreferences externalApplicationsPreferences;
    private CitationKeyPatternPreferences citationKeyPatternPreferences;
    private NameDisplayPreferences nameDisplayPreferences;
    private MainTablePreferences mainTablePreferences;
    private ColumnPreferences mainTableColumnPreferences;
    private ColumnPreferences searchDialogColumnPreferences;
    private JournalAbbreviationPreferences journalAbbreviationPreferences;
    private FieldPreferences fieldPreferences;
    private MergeDialogPreferences mergeDialogPreferences;

    // The constructor is made private to enforce this as a singleton class:
<span class="nc" id="L501">    private JabRefPreferences() {</span>
        try {
<span class="nc bnc" id="L503" title="All 2 branches missed.">            if (new File(&quot;jabref.xml&quot;).exists()) {</span>
<span class="nc" id="L504">                importPreferences(Path.of(&quot;jabref.xml&quot;));</span>
            }
<span class="nc" id="L506">        } catch (JabRefException e) {</span>
<span class="nc" id="L507">            LOGGER.warn(&quot;Could not import preferences from jabref.xml: &quot; + e.getMessage(), e);</span>
<span class="nc" id="L508">        }</span>

        // load user preferences
<span class="nc" id="L511">        prefs = PREFS_NODE;</span>

        // Since some of the preference settings themselves use localized strings, we cannot set the language after
        // the initialization of the preferences in main
        // Otherwise that language framework will be instantiated and more importantly, statically initialized preferences
        // like the SearchDisplayMode will never be translated.
<span class="nc" id="L517">        Localization.setLanguage(getLanguage());</span>

<span class="nc" id="L519">        defaults.put(SEARCH_DISPLAY_MODE, SearchDisplayMode.FILTER.toString());</span>
<span class="nc" id="L520">        defaults.put(SEARCH_CASE_SENSITIVE, Boolean.FALSE);</span>
<span class="nc" id="L521">        defaults.put(SEARCH_REG_EXP, Boolean.FALSE);</span>
<span class="nc" id="L522">        defaults.put(SEARCH_FULLTEXT, Boolean.FALSE);</span>
<span class="nc" id="L523">        defaults.put(SEARCH_KEEP_SEARCH_STRING, Boolean.FALSE);</span>
<span class="nc" id="L524">        defaults.put(SEARCH_KEEP_GLOBAL_WINDOW_ON_TOP, Boolean.TRUE);</span>
<span class="nc" id="L525">        defaults.put(SEARCH_WINDOW_HEIGHT, 176.0);</span>
<span class="nc" id="L526">        defaults.put(SEARCH_WINDOW_WIDTH, 600.0);</span>
<span class="nc" id="L527">        defaults.put(SEARCH_CATALOGS, convertListToString(List.of(</span>
                ACMPortalFetcher.FETCHER_NAME,
                SpringerFetcher.FETCHER_NAME,
                DBLPFetcher.FETCHER_NAME,
                IEEE.FETCHER_NAME)));
<span class="nc" id="L532">        defaults.put(IMPORTERS_ENABLED, Boolean.TRUE);</span>
<span class="nc" id="L533">        defaults.put(GENERATE_KEY_ON_IMPORT, Boolean.TRUE);</span>
<span class="nc" id="L534">        defaults.put(GROBID_ENABLED, Boolean.FALSE);</span>
<span class="nc" id="L535">        defaults.put(GROBID_OPT_OUT, Boolean.FALSE);</span>
<span class="nc" id="L536">        defaults.put(GROBID_URL, &quot;http://grobid.jabref.org:8070&quot;);</span>

<span class="nc" id="L538">        defaults.put(JOURNAL_POPUP, EntryEditorPreferences.JournalPopupEnabled.FIRST_START.toString());</span>

<span class="nc" id="L540">        defaults.put(PUSH_TEXMAKER_PATH, OS.getNativeDesktop().detectProgramPath(&quot;texmaker&quot;, &quot;Texmaker&quot;));</span>
<span class="nc" id="L541">        defaults.put(PUSH_WINEDT_PATH, OS.getNativeDesktop().detectProgramPath(&quot;WinEdt&quot;, &quot;WinEdt Team\\WinEdt&quot;));</span>
<span class="nc" id="L542">        defaults.put(PUSH_TEXSTUDIO_PATH, OS.getNativeDesktop().detectProgramPath(&quot;texstudio&quot;, &quot;TeXstudio&quot;));</span>
<span class="nc" id="L543">        defaults.put(PUSH_SUBLIME_TEXT_PATH, OS.getNativeDesktop().detectProgramPath(&quot;subl&quot;, &quot;Sublime&quot;));</span>
<span class="nc" id="L544">        defaults.put(PUSH_LYXPIPE, USER_HOME + File.separator + &quot;.lyx/lyxpipe&quot;);</span>
<span class="nc" id="L545">        defaults.put(PUSH_VIM, &quot;vim&quot;);</span>
<span class="nc" id="L546">        defaults.put(PUSH_VIM_SERVER, &quot;vim&quot;);</span>
<span class="nc" id="L547">        defaults.put(PUSH_EMACS_ADDITIONAL_PARAMETERS, &quot;-n -e&quot;);</span>

<span class="nc" id="L549">        defaults.put(BIBLATEX_DEFAULT_MODE, Boolean.FALSE);</span>

        // Set DOI to be the default ID entry generator
<span class="nc" id="L552">        defaults.put(ID_ENTRY_GENERATOR, DoiFetcher.NAME);</span>

<span class="nc" id="L554">        defaults.put(USE_CUSTOM_DOI_URI, Boolean.FALSE);</span>
<span class="nc" id="L555">        defaults.put(BASE_DOI_URI, &quot;https://doi.org&quot;);</span>

<span class="nc bnc" id="L557" title="All 2 branches missed.">        if (OS.OS_X) {</span>
<span class="nc" id="L558">            defaults.put(FONT_FAMILY, &quot;SansSerif&quot;);</span>
<span class="nc" id="L559">            defaults.put(PUSH_EMACS_PATH, &quot;emacsclient&quot;);</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">        } else if (OS.WINDOWS) {</span>
<span class="nc" id="L561">            defaults.put(PUSH_EMACS_PATH, &quot;emacsclient.exe&quot;);</span>
        } else {
            // Linux
<span class="nc" id="L564">            defaults.put(FONT_FAMILY, &quot;SansSerif&quot;);</span>
<span class="nc" id="L565">            defaults.put(PUSH_EMACS_PATH, &quot;emacsclient&quot;);</span>
        }

<span class="nc" id="L568">        defaults.put(PUSH_TO_APPLICATION, &quot;TeXstudio&quot;);</span>

<span class="nc" id="L570">        defaults.put(RECENT_DATABASES, &quot;&quot;);</span>
<span class="nc" id="L571">        defaults.put(EXTERNAL_FILE_TYPES, &quot;&quot;);</span>
<span class="nc" id="L572">        defaults.put(KEY_PATTERN_REGEX, &quot;&quot;);</span>
<span class="nc" id="L573">        defaults.put(KEY_PATTERN_REPLACEMENT, &quot;&quot;);</span>

        // Proxy
<span class="nc" id="L576">        defaults.put(PROXY_USE, Boolean.FALSE);</span>
<span class="nc" id="L577">        defaults.put(PROXY_HOSTNAME, &quot;&quot;);</span>
<span class="nc" id="L578">        defaults.put(PROXY_PORT, &quot;80&quot;);</span>
<span class="nc" id="L579">        defaults.put(PROXY_USE_AUTHENTICATION, Boolean.FALSE);</span>
<span class="nc" id="L580">        defaults.put(PROXY_USERNAME, &quot;&quot;);</span>
<span class="nc" id="L581">        defaults.put(PROXY_PASSWORD, &quot;&quot;);</span>
<span class="nc" id="L582">        defaults.put(PROXY_PERSIST_PASSWORD, Boolean.FALSE);</span>

        // SSL
<span class="nc" id="L585">        defaults.put(TRUSTSTORE_PATH, OS.getNativeDesktop()</span>
<span class="nc" id="L586">                                        .getSslDirectory()</span>
<span class="nc" id="L587">                                        .resolve(&quot;truststore.jks&quot;).toString());</span>

<span class="nc" id="L589">        defaults.put(POS_X, 0);</span>
<span class="nc" id="L590">        defaults.put(POS_Y, 0);</span>
<span class="nc" id="L591">        defaults.put(SIZE_X, 1024);</span>
<span class="nc" id="L592">        defaults.put(SIZE_Y, 768);</span>
<span class="nc" id="L593">        defaults.put(WINDOW_MAXIMISED, Boolean.TRUE);</span>
<span class="nc" id="L594">        defaults.put(WINDOW_FULLSCREEN, Boolean.FALSE);</span>
<span class="nc" id="L595">        defaults.put(AUTO_RESIZE_MODE, Boolean.FALSE); // By default disable &quot;Fit table horizontally on the screen&quot;</span>
<span class="nc" id="L596">        defaults.put(ENTRY_EDITOR_HEIGHT, 0.65);</span>
<span class="nc" id="L597">        defaults.put(NAMES_AS_IS, Boolean.FALSE); // &quot;Show names unchanged&quot;</span>
<span class="nc" id="L598">        defaults.put(NAMES_FIRST_LAST, Boolean.FALSE); // &quot;Show 'Firstname Lastname'&quot;</span>
<span class="nc" id="L599">        defaults.put(NAMES_NATBIB, Boolean.TRUE); // &quot;Natbib style&quot;</span>
<span class="nc" id="L600">        defaults.put(ABBR_AUTHOR_NAMES, Boolean.TRUE); // &quot;Abbreviate names&quot;</span>
<span class="nc" id="L601">        defaults.put(NAMES_LAST_ONLY, Boolean.TRUE); // &quot;Show last names only&quot;</span>
        // system locale as default
<span class="nc" id="L603">        defaults.put(LANGUAGE, Locale.getDefault().getLanguage());</span>

<span class="nc" id="L605">        defaults.put(REFORMAT_FILE_ON_SAVE_AND_EXPORT, Boolean.FALSE);</span>

        // export order
<span class="nc" id="L608">        defaults.put(EXPORT_IN_ORIGINAL_ORDER, Boolean.TRUE);</span>
<span class="nc" id="L609">        defaults.put(EXPORT_IN_SPECIFIED_ORDER, Boolean.FALSE);</span>

        // export order: if EXPORT_IN_SPECIFIED_ORDER, then use following criteria
<span class="nc" id="L612">        defaults.put(EXPORT_PRIMARY_SORT_FIELD, InternalField.KEY_FIELD.getName());</span>
<span class="nc" id="L613">        defaults.put(EXPORT_PRIMARY_SORT_DESCENDING, Boolean.FALSE);</span>
<span class="nc" id="L614">        defaults.put(EXPORT_SECONDARY_SORT_FIELD, StandardField.AUTHOR.getName());</span>
<span class="nc" id="L615">        defaults.put(EXPORT_SECONDARY_SORT_DESCENDING, Boolean.FALSE);</span>
<span class="nc" id="L616">        defaults.put(EXPORT_TERTIARY_SORT_FIELD, StandardField.TITLE.getName());</span>
<span class="nc" id="L617">        defaults.put(EXPORT_TERTIARY_SORT_DESCENDING, Boolean.FALSE);</span>

<span class="nc" id="L619">        defaults.put(NEWLINE, System.lineSeparator());</span>

<span class="nc" id="L621">        defaults.put(SIDE_PANE_COMPONENT_NAMES, &quot;&quot;);</span>
<span class="nc" id="L622">        defaults.put(SIDE_PANE_COMPONENT_PREFERRED_POSITIONS, &quot;&quot;);</span>

<span class="nc" id="L624">        defaults.put(COLUMN_NAMES, &quot;groups;group_icons;files;linked_id;field:entrytype;field:author/editor;field:title;field:year;field:journal/booktitle;special:ranking;special:readstatus;special:priority&quot;);</span>
<span class="nc" id="L625">        defaults.put(COLUMN_WIDTHS, &quot;28;40;28;28;75;300;470;60;130;50;50;50&quot;);</span>

<span class="nc" id="L627">        defaults.put(XMP_PRIVACY_FILTERS, &quot;pdf;timestamp;keywords;owner;note;review&quot;);</span>
<span class="nc" id="L628">        defaults.put(USE_XMP_PRIVACY_FILTER, Boolean.FALSE);</span>
<span class="nc" id="L629">        defaults.put(WORKING_DIRECTORY, USER_HOME);</span>
<span class="nc" id="L630">        defaults.put(EXPORT_WORKING_DIRECTORY, USER_HOME);</span>

<span class="nc" id="L632">        defaults.put(CREATE_BACKUP, Boolean.TRUE);</span>

        // Remembers working directory of last import
<span class="nc" id="L635">        defaults.put(IMPORT_WORKING_DIRECTORY, USER_HOME);</span>
<span class="nc" id="L636">        defaults.put(PREFS_EXPORT_PATH, USER_HOME);</span>
<span class="nc" id="L637">        defaults.put(AUTO_OPEN_FORM, Boolean.TRUE);</span>
<span class="nc" id="L638">        defaults.put(OPEN_LAST_EDITED, Boolean.TRUE);</span>
<span class="nc" id="L639">        defaults.put(LAST_EDITED, &quot;&quot;);</span>
<span class="nc" id="L640">        defaults.put(LAST_FOCUSED, &quot;&quot;);</span>
<span class="nc" id="L641">        defaults.put(DEFAULT_SHOW_SOURCE, Boolean.FALSE);</span>

<span class="nc" id="L643">        defaults.put(MERGE_ENTRIES_DIFF_MODE, DiffMode.WORD.name());</span>
<span class="nc" id="L644">        defaults.put(MERGE_ENTRIES_SHOULD_SHOW_DIFF, Boolean.TRUE);</span>
<span class="nc" id="L645">        defaults.put(MERGE_ENTRIES_SHOULD_SHOW_UNIFIED_DIFF, Boolean.TRUE);</span>
<span class="nc" id="L646">        defaults.put(MERGE_ENTRIES_HIGHLIGHT_WORDS, Boolean.TRUE);</span>
<span class="nc" id="L647">        defaults.put(MERGE_SHOW_ONLY_CHANGED_FIELDS, Boolean.FALSE);</span>
<span class="nc" id="L648">        defaults.put(MERGE_APPLY_TO_ALL_ENTRIES, Boolean.FALSE);</span>
<span class="nc" id="L649">        defaults.put(DUPLICATE_RESOLVER_DECISION_RESULT_ALL_ENTRIES, DuplicateResolverDialog.DuplicateResolverResult.BREAK.name());</span>

<span class="nc" id="L651">        defaults.put(SHOW_USER_COMMENTS_FIELDS, Boolean.TRUE);</span>

<span class="nc" id="L653">        defaults.put(SHOW_RECOMMENDATIONS, Boolean.TRUE);</span>
<span class="nc" id="L654">        defaults.put(ACCEPT_RECOMMENDATIONS, Boolean.FALSE);</span>
<span class="nc" id="L655">        defaults.put(SHOW_LATEX_CITATIONS, Boolean.TRUE);</span>
<span class="nc" id="L656">        defaults.put(SHOW_SCITE_TAB, Boolean.TRUE);</span>
<span class="nc" id="L657">        defaults.put(SEND_LANGUAGE_DATA, Boolean.FALSE);</span>
<span class="nc" id="L658">        defaults.put(SEND_OS_DATA, Boolean.FALSE);</span>
<span class="nc" id="L659">        defaults.put(SEND_TIMEZONE_DATA, Boolean.FALSE);</span>
<span class="nc" id="L660">        defaults.put(VALIDATE_IN_ENTRY_EDITOR, Boolean.TRUE);</span>
<span class="nc" id="L661">        defaults.put(AUTO_COMPLETE, Boolean.FALSE);</span>
<span class="nc" id="L662">        defaults.put(AUTOCOMPLETER_FIRSTNAME_MODE, AutoCompleteFirstNameMode.BOTH.name());</span>
<span class="nc" id="L663">        defaults.put(AUTOCOMPLETER_FIRST_LAST, Boolean.FALSE); // &quot;Autocomplete names in 'Firstname Lastname' format only&quot;</span>
<span class="nc" id="L664">        defaults.put(AUTOCOMPLETER_LAST_FIRST, Boolean.FALSE); // &quot;Autocomplete names in 'Lastname, Firstname' format only&quot;</span>
<span class="nc" id="L665">        defaults.put(AUTOCOMPLETER_COMPLETE_FIELDS, &quot;author;editor;title;journal;publisher;keywords;crossref;related;entryset&quot;);</span>
<span class="nc" id="L666">        defaults.put(AUTO_ASSIGN_GROUP, Boolean.TRUE);</span>
<span class="nc" id="L667">        defaults.put(DISPLAY_GROUP_COUNT, Boolean.TRUE);</span>
<span class="nc" id="L668">        defaults.put(GROUP_INTERSECT_UNION_VIEW_MODE, GroupViewMode.INTERSECTION.name());</span>
<span class="nc" id="L669">        defaults.put(DEFAULT_HIERARCHICAL_CONTEXT, GroupHierarchyType.INDEPENDENT.name());</span>
<span class="nc" id="L670">        defaults.put(KEYWORD_SEPARATOR, &quot;, &quot;);</span>
<span class="nc" id="L671">        defaults.put(DEFAULT_ENCODING, StandardCharsets.UTF_8.name());</span>
<span class="nc" id="L672">        defaults.put(DEFAULT_OWNER, System.getProperty(&quot;user.name&quot;));</span>
<span class="nc" id="L673">        defaults.put(MEMORY_STICK_MODE, Boolean.FALSE);</span>
<span class="nc" id="L674">        defaults.put(SHOW_ADVANCED_HINTS, Boolean.TRUE);</span>

<span class="nc" id="L676">        defaults.put(EXTRA_FILE_COLUMNS, Boolean.FALSE);</span>

<span class="nc" id="L678">        defaults.put(PROTECTED_TERMS_ENABLED_INTERNAL, convertListToString(ProtectedTermsLoader.getInternalLists()));</span>
<span class="nc" id="L679">        defaults.put(PROTECTED_TERMS_DISABLED_INTERNAL, &quot;&quot;);</span>
<span class="nc" id="L680">        defaults.put(PROTECTED_TERMS_ENABLED_EXTERNAL, &quot;&quot;);</span>
<span class="nc" id="L681">        defaults.put(PROTECTED_TERMS_DISABLED_EXTERNAL, &quot;&quot;);</span>

        // OpenOffice/LibreOffice
<span class="nc bnc" id="L684" title="All 2 branches missed.">        if (OS.WINDOWS) {</span>
<span class="nc" id="L685">            defaults.put(OO_EXECUTABLE_PATH, OpenOfficePreferences.DEFAULT_WIN_EXEC_PATH);</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">        } else if (OS.OS_X) {</span>
<span class="nc" id="L687">            defaults.put(OO_EXECUTABLE_PATH, OpenOfficePreferences.DEFAULT_OSX_EXEC_PATH);</span>
        } else { // Linux
<span class="nc" id="L689">            defaults.put(OO_EXECUTABLE_PATH, OpenOfficePreferences.DEFAULT_LINUX_EXEC_PATH);</span>
        }

<span class="nc" id="L692">        defaults.put(OO_SYNC_WHEN_CITING, Boolean.TRUE);</span>
<span class="nc" id="L693">        defaults.put(OO_SHOW_PANEL, Boolean.FALSE);</span>
<span class="nc" id="L694">        defaults.put(OO_USE_ALL_OPEN_BASES, Boolean.TRUE);</span>
<span class="nc" id="L695">        defaults.put(OO_BIBLIOGRAPHY_STYLE_FILE, StyleLoader.DEFAULT_AUTHORYEAR_STYLE_PATH);</span>
<span class="nc" id="L696">        defaults.put(OO_EXTERNAL_STYLE_FILES, &quot;&quot;);</span>

<span class="nc" id="L698">        defaults.put(SPECIALFIELDSENABLED, Boolean.TRUE);</span>

<span class="nc" id="L700">        defaults.put(FETCHER_CUSTOM_KEY_NAMES, &quot;Springer;IEEEXplore;SAO/NASA ADS;ScienceDirect;Biodiversity Heritage&quot;);</span>
<span class="nc" id="L701">        defaults.put(FETCHER_CUSTOM_KEY_USES, &quot;FALSE;FALSE;FALSE;FALSE;FALSE&quot;);</span>
<span class="nc" id="L702">        defaults.put(FETCHER_CUSTOM_KEY_PERSIST, Boolean.FALSE);</span>

<span class="nc" id="L704">        defaults.put(USE_OWNER, Boolean.FALSE);</span>
<span class="nc" id="L705">        defaults.put(OVERWRITE_OWNER, Boolean.FALSE);</span>
<span class="nc" id="L706">        defaults.put(AVOID_OVERWRITING_KEY, Boolean.FALSE);</span>
<span class="nc" id="L707">        defaults.put(WARN_BEFORE_OVERWRITING_KEY, Boolean.TRUE);</span>
<span class="nc" id="L708">        defaults.put(CONFIRM_DELETE, Boolean.TRUE);</span>
<span class="nc" id="L709">        defaults.put(DEFAULT_CITATION_KEY_PATTERN, &quot;[auth][year]&quot;);</span>
<span class="nc" id="L710">        defaults.put(UNWANTED_CITATION_KEY_CHARACTERS, &quot;-`สน:!;?^+&quot;);</span>
<span class="nc" id="L711">        defaults.put(RESOLVE_STRINGS_FOR_FIELDS, &quot;author;booktitle;editor;editora;editorb;editorc;institution;issuetitle;journal;journalsubtitle;journaltitle;mainsubtitle;month;publisher;shortauthor;shorteditor;subtitle;titleaddon&quot;);</span>
<span class="nc" id="L712">        defaults.put(DO_NOT_RESOLVE_STRINGS, Boolean.FALSE);</span>
<span class="nc" id="L713">        defaults.put(NON_WRAPPABLE_FIELDS, &quot;pdf;ps;url;doi;file;isbn;issn&quot;);</span>
<span class="nc" id="L714">        defaults.put(WARN_ABOUT_DUPLICATES_IN_INSPECTION, Boolean.TRUE);</span>
<span class="nc" id="L715">        defaults.put(ADD_CREATION_DATE, Boolean.FALSE);</span>
<span class="nc" id="L716">        defaults.put(ADD_MODIFICATION_DATE, Boolean.FALSE);</span>

<span class="nc" id="L718">        defaults.put(UPDATE_TIMESTAMP, Boolean.FALSE);</span>
<span class="nc" id="L719">        defaults.put(TIME_STAMP_FIELD, StandardField.TIMESTAMP.getName());</span>
        // default time stamp follows ISO-8601. Reason: https://xkcd.com/1179/
<span class="nc" id="L721">        defaults.put(TIME_STAMP_FORMAT, &quot;yyyy-MM-dd&quot;);</span>

<span class="nc" id="L723">        defaults.put(GENERATE_KEYS_BEFORE_SAVING, Boolean.FALSE);</span>

<span class="nc" id="L725">        defaults.put(USE_REMOTE_SERVER, Boolean.TRUE);</span>
<span class="nc" id="L726">        defaults.put(REMOTE_SERVER_PORT, 6050);</span>

<span class="nc" id="L728">        defaults.put(EXTERNAL_JOURNAL_LISTS, &quot;&quot;);</span>
<span class="nc" id="L729">        defaults.put(USE_AMS_FJOURNAL, true);</span>
<span class="nc" id="L730">        defaults.put(CITE_COMMAND, &quot;\\cite{key1,key2}&quot;);</span>
<span class="nc" id="L731">        defaults.put(LAST_USED_EXPORT, &quot;&quot;);</span>
<span class="nc" id="L732">        defaults.put(SIDE_PANE_WIDTH, 0.15);</span>

<span class="nc" id="L734">        defaults.put(MAIN_FONT_SIZE, 9);</span>
<span class="nc" id="L735">        defaults.put(OVERRIDE_DEFAULT_FONT_SIZE, false);</span>

<span class="nc" id="L737">        defaults.put(AUTOLINK_EXACT_KEY_ONLY, Boolean.FALSE);</span>
<span class="nc" id="L738">        defaults.put(AUTOLINK_FILES_ENABLED, Boolean.TRUE);</span>
<span class="nc" id="L739">        defaults.put(LOCAL_AUTO_SAVE, Boolean.FALSE);</span>
<span class="nc" id="L740">        defaults.put(ALLOW_INTEGER_EDITION_BIBTEX, Boolean.FALSE);</span>
        // Curly brackets ({}) are the default delimiters, not quotes (&quot;) as these cause trouble when they appear within the field value:
        // Currently, JabRef does not escape them
<span class="nc" id="L743">        defaults.put(KEY_GEN_FIRST_LETTER_A, Boolean.TRUE);</span>
<span class="nc" id="L744">        defaults.put(KEY_GEN_ALWAYS_ADD_LETTER, Boolean.FALSE);</span>
<span class="nc" id="L745">        defaults.put(EMAIL_SUBJECT, Localization.lang(&quot;References&quot;));</span>
<span class="nc" id="L746">        defaults.put(KINDLE_EMAIL, &quot;&quot;);</span>

<span class="nc bnc" id="L748" title="All 2 branches missed.">        if (OS.WINDOWS) {</span>
<span class="nc" id="L749">            defaults.put(OPEN_FOLDERS_OF_ATTACHED_FILES, Boolean.TRUE);</span>
        } else {
<span class="nc" id="L751">            defaults.put(OPEN_FOLDERS_OF_ATTACHED_FILES, Boolean.FALSE);</span>
        }

<span class="nc" id="L754">        defaults.put(WEB_SEARCH_VISIBLE, Boolean.TRUE);</span>
<span class="nc" id="L755">        defaults.put(GROUP_SIDEPANE_VISIBLE, Boolean.TRUE);</span>
<span class="nc" id="L756">        defaults.put(SELECTED_FETCHER_INDEX, 0);</span>
<span class="nc" id="L757">        defaults.put(STORE_RELATIVE_TO_BIB, Boolean.TRUE);</span>
<span class="nc" id="L758">        defaults.put(COLLECT_TELEMETRY, Boolean.FALSE);</span>
<span class="nc" id="L759">        defaults.put(ALREADY_ASKED_TO_COLLECT_TELEMETRY, Boolean.FALSE);</span>

<span class="nc" id="L761">        defaults.put(ASK_AUTO_NAMING_PDFS_AGAIN, Boolean.TRUE);</span>
<span class="nc" id="L762">        defaults.put(CLEANUP_JOBS, convertListToString(getDefaultCleanupJobs().stream().map(Enum::name).toList()));</span>
<span class="nc" id="L763">        defaults.put(CLEANUP_FIELD_FORMATTERS_ENABLED, Boolean.FALSE);</span>
<span class="nc" id="L764">        defaults.put(CLEANUP_FIELD_FORMATTERS, FieldFormatterCleanups.getMetaDataString(FieldFormatterCleanups.DEFAULT_SAVE_ACTIONS, OS.NEWLINE));</span>

        // use citation key appended with filename as default pattern
<span class="nc" id="L767">        defaults.put(IMPORT_FILENAMEPATTERN, FilePreferences.DEFAULT_FILENAME_PATTERNS[1]);</span>
        // Default empty String to be backwards compatible
<span class="nc" id="L769">        defaults.put(IMPORT_FILEDIRPATTERN, &quot;&quot;);</span>
        // Download files by default
<span class="nc" id="L771">        defaults.put(DOWNLOAD_LINKED_FILES, true);</span>
        // Create Fulltext-Index by default
<span class="nc" id="L773">        defaults.put(FULLTEXT_INDEX_LINKED_FILES, true);</span>

<span class="nc" id="L775">        String defaultExpression = &quot;**/.*[citationkey].*\\\\.[extension]&quot;;</span>
<span class="nc" id="L776">        defaults.put(AUTOLINK_REG_EXP_SEARCH_EXPRESSION_KEY, defaultExpression);</span>
<span class="nc" id="L777">        defaults.put(AUTOLINK_USE_REG_EXP_SEARCH_KEY, Boolean.FALSE);</span>

<span class="nc" id="L779">        defaults.put(USE_DEFAULT_CONSOLE_APPLICATION, Boolean.TRUE);</span>
<span class="nc" id="L780">        defaults.put(USE_DEFAULT_FILE_BROWSER_APPLICATION, Boolean.TRUE);</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">        if (OS.WINDOWS) {</span>
<span class="nc" id="L782">            defaults.put(CONSOLE_COMMAND, &quot;C:\\Program Files\\ConEmu\\ConEmu64.exe /single /dir \&quot;%DIR\&quot;&quot;);</span>
<span class="nc" id="L783">            defaults.put(FILE_BROWSER_COMMAND, &quot;explorer.exe /select, \&quot;%DIR\&quot;&quot;);</span>
        } else {
<span class="nc" id="L785">            defaults.put(CONSOLE_COMMAND, &quot;&quot;);</span>
<span class="nc" id="L786">            defaults.put(FILE_BROWSER_COMMAND, &quot;&quot;);</span>
        }

        // version check defaults
<span class="nc" id="L790">        defaults.put(VERSION_IGNORED_UPDATE, &quot;&quot;);</span>
<span class="nc" id="L791">        defaults.put(VERSION_CHECK_ENABLED, Boolean.TRUE);</span>

        // preview
<span class="nc" id="L794">        defaults.put(CYCLE_PREVIEW, &quot;Preview;&quot; + CitationStyle.DEFAULT);</span>
<span class="nc" id="L795">        defaults.put(CYCLE_PREVIEW_POS, 0);</span>
<span class="nc" id="L796">        defaults.put(PREVIEW_AS_TAB, Boolean.FALSE);</span>
<span class="nc" id="L797">        defaults.put(PREVIEW_STYLE,</span>
                &quot;&lt;font face=\&quot;sans-serif\&quot;&gt;&quot; +
                        &quot;&lt;b&gt;\\bibtextype&lt;/b&gt;&lt;a name=\&quot;\\citationkey\&quot;&gt;\\begin{citationkey} (\\citationkey)&lt;/a&gt;\\end{citationkey}__NEWLINE__&quot; +
                        &quot;\\begin{author}&lt;BR&gt;&lt;BR&gt;\\format[Authors(LastFirst, FullName,Sep= / ,LastSep= / ),HTMLChars]{\\author}\\end{author}__NEWLINE__&quot; +
                        &quot;\\begin{editor &amp; !author}&lt;BR&gt;&lt;BR&gt;\\format[Authors(LastFirst,FullName,Sep= / ,LastSep= / ),HTMLChars]{\\editor} (\\format[IfPlural(Eds.,Ed.)]{\\editor})\\end{editor &amp; !author}__NEWLINE__&quot; +
                        &quot;\\begin{title}&lt;BR&gt;&lt;b&gt;\\format[HTMLChars]{\\title}&lt;/b&gt; \\end{title}__NEWLINE__&quot; +
                        &quot;&lt;BR&gt;\\begin{date}\\date\\end{date}\\begin{edition}, \\edition. edition\\end{edition}__NEWLINE__&quot; +
                        &quot;\\begin{editor &amp; author}&lt;BR&gt;&lt;BR&gt;\\format[Authors(LastFirst,FullName,Sep= / ,LastSep= / ),HTMLChars]{\\editor} (\\format[IfPlural(Eds.,Ed.)]{\\editor})\\end{editor &amp; author}__NEWLINE__&quot; +
                        &quot;\\begin{booktitle}&lt;BR&gt;&lt;i&gt;\\format[HTMLChars]{\\booktitle}&lt;/i&gt;\\end{booktitle}__NEWLINE__&quot; +
                        &quot;\\begin{chapter} \\format[HTMLChars]{\\chapter}&lt;BR&gt;\\end{chapter}&quot; +
                        &quot;\\begin{editor &amp; !author}&lt;BR&gt;\\end{editor &amp; !author}\\begin{!editor}&lt;BR&gt;\\end{!editor}\\begin{journal}&lt;BR&gt;&lt;i&gt;\\format[HTMLChars]{\\journal}&lt;/i&gt; \\end{journal} \\begin{volume}, Vol. \\volume\\end{volume}\\begin{series}&lt;BR&gt;\\format[HTMLChars]{\\series}\\end{series}\\begin{number}, No. \\format[HTMLChars]{\\number}\\end{number}__NEWLINE__&quot; +
                        &quot;\\begin{school} \\format[HTMLChars]{\\school}, \\end{school}__NEWLINE__&quot; +
                        &quot;\\begin{institution} &lt;em&gt;\\format[HTMLChars]{\\institution}, &lt;/em&gt;\\end{institution}__NEWLINE__&quot; +
                        &quot;\\begin{publisher}&lt;BR&gt;\\format[HTMLChars]{\\publisher}\\end{publisher}\\begin{location}: \\format[HTMLChars]{\\location} \\end{location}__NEWLINE__&quot; +
                        &quot;\\begin{pages}&lt;BR&gt; p. \\format[FormatPagesForHTML]{\\pages}\\end{pages}__NEWLINE__&quot; +
                        &quot;\\begin{abstract}&lt;BR&gt;&lt;BR&gt;&lt;b&gt;Abstract: &lt;/b&gt;\\format[HTMLChars]{\\abstract} \\end{abstract}__NEWLINE__&quot; +
                        &quot;\\begin{owncitation}&lt;BR&gt;&lt;BR&gt;&lt;b&gt;Own citation: &lt;/b&gt;\\format[HTMLChars]{\\owncitation} \\end{owncitation}__NEWLINE__&quot; +
                        &quot;\\begin{comment}&lt;BR&gt;&lt;BR&gt;&lt;b&gt;Comment: &lt;/b&gt;\\format[HTMLChars]{\\comment}\\end{comment}__NEWLINE__&quot; +
                        &quot;&lt;/font&gt;__NEWLINE__&quot;);

        // set default theme
<span class="nc" id="L818">        defaults.put(THEME, Theme.BASE_CSS);</span>
<span class="nc" id="L819">        defaults.put(THEME_SYNC_OS, Boolean.FALSE);</span>
<span class="nc" id="L820">        setLanguageDependentDefaultValues();</span>
<span class="nc" id="L821">    }</span>

    public void setLanguageDependentDefaultValues() {
        // Entry editor tab 0:
<span class="nc" id="L825">        defaults.put(CUSTOM_TAB_NAME + &quot;_def0&quot;, Localization.lang(&quot;General&quot;));</span>
<span class="nc" id="L826">        String fieldNames = FieldFactory.getDefaultGeneralFields().stream().map(Field::getName).collect(Collectors.joining(STRINGLIST_DELIMITER.toString()));</span>
<span class="nc" id="L827">        defaults.put(CUSTOM_TAB_FIELDS + &quot;_def0&quot;, fieldNames);</span>

        // Entry editor tab 1:
<span class="nc" id="L830">        defaults.put(CUSTOM_TAB_FIELDS + &quot;_def1&quot;, StandardField.ABSTRACT.getName());</span>
<span class="nc" id="L831">        defaults.put(CUSTOM_TAB_NAME + &quot;_def1&quot;, Localization.lang(&quot;Abstract&quot;));</span>

        // Entry editor tab 2: Comments Field - used for research comments, etc.
<span class="nc" id="L834">        defaults.put(CUSTOM_TAB_FIELDS + &quot;_def2&quot;, StandardField.COMMENT.getName());</span>
<span class="nc" id="L835">        defaults.put(CUSTOM_TAB_NAME + &quot;_def2&quot;, Localization.lang(&quot;Comments&quot;));</span>

<span class="nc" id="L837">        defaults.put(EMAIL_SUBJECT, Localization.lang(&quot;References&quot;));</span>
<span class="nc" id="L838">    }</span>

    /**
     * @return Instance of JaRefPreferences
     * @deprecated Use {@link PreferencesService} instead
     */
    @Deprecated
    public static JabRefPreferences getInstance() {
<span class="nc bnc" id="L846" title="All 2 branches missed.">        if (JabRefPreferences.singleton == null) {</span>
<span class="nc" id="L847">            JabRefPreferences.singleton = new JabRefPreferences();</span>
        }
<span class="nc" id="L849">        return JabRefPreferences.singleton;</span>
    }

    //*************************************************************************************************************
    // Common serializer logic
    //*************************************************************************************************************

    private static String convertListToString(List&lt;String&gt; value) {
<span class="nc" id="L857">        return value.stream().map(val -&gt; StringUtil.quote(val, STRINGLIST_DELIMITER.toString(), '\\')).collect(Collectors.joining(STRINGLIST_DELIMITER.toString()));</span>
    }

    private static List&lt;String&gt; convertStringToList(String toConvert) {
<span class="nc bnc" id="L861" title="All 2 branches missed.">        if (StringUtil.isBlank(toConvert)) {</span>
<span class="nc" id="L862">            return Collections.emptyList();</span>
        }

<span class="nc" id="L865">        StringReader reader = new StringReader(toConvert);</span>
<span class="nc" id="L866">        List&lt;String&gt; result = new ArrayList&lt;&gt;();</span>
        Optional&lt;String&gt; rs;
        try {
<span class="nc bnc" id="L869" title="All 2 branches missed.">            while ((rs = getNextUnit(reader)).isPresent()) {</span>
<span class="nc" id="L870">                result.add(rs.get());</span>
            }
<span class="nc" id="L872">        } catch (IOException e) {</span>
<span class="nc" id="L873">            LOGGER.warn(&quot;Unable to convert String to List&quot;, e);</span>
<span class="nc" id="L874">        }</span>
<span class="nc" id="L875">        return result;</span>
    }

    private static Optional&lt;String&gt; getNextUnit(Reader data) throws IOException {
        // character last read
        // -1 if end of stream
        // initialization necessary, because of Java compiler
<span class="nc" id="L882">        int c = -1;</span>

        // last character was escape symbol
<span class="nc" id="L885">        boolean escape = false;</span>

        // true if a STRINGLIST_DELIMITER is found
<span class="nc" id="L888">        boolean done = false;</span>

<span class="nc" id="L890">        StringBuilder res = new StringBuilder();</span>
<span class="nc bnc" id="L891" title="All 4 branches missed.">        while (!done &amp;&amp; ((c = data.read()) != -1)) {</span>
<span class="nc bnc" id="L892" title="All 2 branches missed.">            if (c == '\\') {</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">                if (escape) {</span>
<span class="nc" id="L894">                    escape = false;</span>
<span class="nc" id="L895">                    res.append('\\');</span>
                } else {
<span class="nc" id="L897">                    escape = true;</span>
                }
            } else {
<span class="nc bnc" id="L900" title="All 2 branches missed.">                if (c == STRINGLIST_DELIMITER) {</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">                    if (escape) {</span>
<span class="nc" id="L902">                        res.append(STRINGLIST_DELIMITER);</span>
                    } else {
<span class="nc" id="L904">                        done = true;</span>
                    }
                } else {
<span class="nc" id="L907">                    res.append((char) c);</span>
                }
<span class="nc" id="L909">                escape = false;</span>
            }
        }
<span class="nc bnc" id="L912" title="All 2 branches missed.">        if (!res.isEmpty()) {</span>
<span class="nc" id="L913">            return Optional.of(res.toString());</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">        } else if (c == -1) {</span>
            // end of stream
<span class="nc" id="L916">            return Optional.empty();</span>
        } else {
<span class="nc" id="L918">            return Optional.of(&quot;&quot;);</span>
        }
    }

    //*************************************************************************************************************
    // Backingstore access logic
    //*************************************************************************************************************

    /**
     * Check whether a key is set (differently from null).
     *
     * @param key The key to check.
     * @return true if the key is set, false otherwise.
     */
    public boolean hasKey(String key) {
<span class="nc bnc" id="L933" title="All 2 branches missed.">        return prefs.get(key, null) != null;</span>
    }

    public String get(String key) {
<span class="nc" id="L937">        return prefs.get(key, (String) defaults.get(key));</span>
    }

    public Optional&lt;String&gt; getAsOptional(String key) {
<span class="nc" id="L941">        return Optional.ofNullable(prefs.get(key, (String) defaults.get(key)));</span>
    }

    public String get(String key, String def) {
<span class="nc" id="L945">        return prefs.get(key, def);</span>
    }

    public boolean getBoolean(String key) {
<span class="nc" id="L949">        return prefs.getBoolean(key, getBooleanDefault(key));</span>
    }

    public boolean getBoolean(String key, boolean def) {
<span class="nc" id="L953">        return prefs.getBoolean(key, def);</span>
    }

    private boolean getBooleanDefault(String key) {
<span class="nc" id="L957">        return (Boolean) defaults.get(key);</span>
    }

    public int getInt(String key) {
<span class="nc" id="L961">        return prefs.getInt(key, getIntDefault(key));</span>
    }

    public double getDouble(String key) {
<span class="nc" id="L965">        return prefs.getDouble(key, getDoubleDefault(key));</span>
    }

    public int getIntDefault(String key) {
<span class="nc" id="L969">        return (Integer) defaults.get(key);</span>
    }

    private double getDoubleDefault(String key) {
<span class="nc" id="L973">        return ((Number) defaults.get(key)).doubleValue();</span>
    }

    public void put(String key, String value) {
<span class="nc" id="L977">        prefs.put(key, value);</span>
<span class="nc" id="L978">    }</span>

    public void putBoolean(String key, boolean value) {
<span class="nc" id="L981">        prefs.putBoolean(key, value);</span>
<span class="nc" id="L982">    }</span>

    public void putInt(String key, int value) {
<span class="nc" id="L985">        prefs.putInt(key, value);</span>
<span class="nc" id="L986">    }</span>

    public void putInt(String key, Number value) {
<span class="nc" id="L989">        prefs.putInt(key, value.intValue());</span>
<span class="nc" id="L990">    }</span>

    public void putDouble(String key, double value) {
<span class="nc" id="L993">        prefs.putDouble(key, value);</span>
<span class="nc" id="L994">    }</span>

    private void remove(String key) {
<span class="nc" id="L997">        prefs.remove(key);</span>
<span class="nc" id="L998">    }</span>

    /**
     * Puts a list of strings into the Preferences, by linking its elements with a STRINGLIST_DELIMITER into a single string. Escape characters make the process transparent even if strings contains a STRINGLIST_DELIMITER.
     */
    public void putStringList(String key, List&lt;String&gt; value) {
<span class="nc bnc" id="L1004" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L1005">            remove(key);</span>
<span class="nc" id="L1006">            return;</span>
        }

<span class="nc" id="L1009">        put(key, convertListToString(value));</span>
<span class="nc" id="L1010">    }</span>

    /**
     * Returns a List of Strings containing the chosen columns.
     */
    public List&lt;String&gt; getStringList(String key) {
<span class="nc" id="L1016">        return convertStringToList(get(key));</span>
    }

    /**
     * Returns a Path
     */
    private Path getPath(String key, Path defaultValue) {
<span class="nc" id="L1023">        String rawPath = get(key);</span>
<span class="nc bnc" id="L1024" title="All 2 branches missed.">        return StringUtil.isNotBlank(rawPath) ? Path.of(rawPath) : defaultValue;</span>
    }

    /**
     * Clear all preferences.
     *
     * @throws BackingStoreException if JabRef is unable to write to the registry/the preferences storage
     */
    @Override
    public void clear() throws BackingStoreException {
<span class="nc" id="L1034">        clearAllBibEntryTypes();</span>
<span class="nc" id="L1035">        clearCitationKeyPatterns();</span>
<span class="nc" id="L1036">        clearTruststoreFromCustomCertificates();</span>
<span class="nc" id="L1037">        clearCustomFetcherKeys();</span>
<span class="nc" id="L1038">        prefs.clear();</span>
<span class="nc" id="L1039">        new SharedDatabasePreferences().clear();</span>
<span class="nc" id="L1040">    }</span>

    private void clearTruststoreFromCustomCertificates() {
<span class="nc" id="L1043">        TrustStoreManager trustStoreManager = new TrustStoreManager(Path.of(defaults.get(TRUSTSTORE_PATH).toString()));</span>
<span class="nc" id="L1044">        trustStoreManager.clearCustomCertificates();</span>
<span class="nc" id="L1045">    }</span>

    /**
     * Removes the given key from the preferences.
     *
     * @throws IllegalArgumentException if the key does not exist
     */
    @Override
    public void deleteKey(String key) throws IllegalArgumentException {
<span class="nc" id="L1054">        String keyTrimmed = key.trim();</span>
<span class="nc bnc" id="L1055" title="All 2 branches missed.">        if (hasKey(keyTrimmed)) {</span>
<span class="nc" id="L1056">            remove(keyTrimmed);</span>
        } else {
<span class="nc" id="L1058">            throw new IllegalArgumentException(&quot;Unknown preference key&quot;);</span>
        }
<span class="nc" id="L1060">    }</span>

    /**
     * Calling this method will write all preferences into the preference store.
     */
    @Override
    public void flush() {
<span class="nc bnc" id="L1067" title="All 2 branches missed.">        if (getBoolean(MEMORY_STICK_MODE)) {</span>
            try {
<span class="nc" id="L1069">                exportPreferences(Path.of(&quot;jabref.xml&quot;));</span>
<span class="nc" id="L1070">            } catch (JabRefException e) {</span>
<span class="nc" id="L1071">                LOGGER.warn(&quot;Could not export preferences for memory stick mode: &quot; + e.getMessage(), e);</span>
<span class="nc" id="L1072">            }</span>
        }
        try {
<span class="nc" id="L1075">            prefs.flush();</span>
<span class="nc" id="L1076">        } catch (BackingStoreException ex) {</span>
<span class="nc" id="L1077">            LOGGER.warn(&quot;Cannot communicate with backing store&quot;, ex);</span>
<span class="nc" id="L1078">        }</span>
<span class="nc" id="L1079">    }</span>

    @Override
    public Map&lt;String, Object&gt; getPreferences() {
<span class="nc" id="L1083">        Map&lt;String, Object&gt; result = new HashMap&lt;&gt;();</span>

        try {
<span class="nc" id="L1086">            addPrefsRecursively(this.prefs, result);</span>
<span class="nc" id="L1087">        } catch (BackingStoreException e) {</span>
<span class="nc" id="L1088">            LOGGER.info(&quot;could not retrieve preference keys&quot;, e);</span>
<span class="nc" id="L1089">        }</span>
<span class="nc" id="L1090">        return result;</span>
    }

    @Override
    public Map&lt;String, Object&gt; getDefaults() {
<span class="nc" id="L1095">        return defaults;</span>
    }

    private void addPrefsRecursively(Preferences prefs, Map&lt;String, Object&gt; result) throws BackingStoreException {
<span class="nc bnc" id="L1099" title="All 2 branches missed.">        for (String key : prefs.keys()) {</span>
<span class="nc" id="L1100">            result.put(key, getObject(prefs, key));</span>
        }
<span class="nc bnc" id="L1102" title="All 2 branches missed.">        for (String child : prefs.childrenNames()) {</span>
<span class="nc" id="L1103">            addPrefsRecursively(prefs.node(child), result);</span>
        }
<span class="nc" id="L1105">    }</span>

    private Object getObject(Preferences prefs, String key) {
        try {
<span class="nc" id="L1109">            return prefs.get(key, (String) defaults.get(key));</span>
<span class="nc" id="L1110">        } catch (ClassCastException e) {</span>
            try {
<span class="nc" id="L1112">                return prefs.getBoolean(key, getBooleanDefault(key));</span>
<span class="nc" id="L1113">            } catch (ClassCastException e2) {</span>
                try {
<span class="nc" id="L1115">                    return prefs.getInt(key, getIntDefault(key));</span>
<span class="nc" id="L1116">                } catch (ClassCastException e3) {</span>
<span class="nc" id="L1117">                    return prefs.getDouble(key, getDoubleDefault(key));</span>
                }
            }
        }
    }

    /**
     * Returns a list of Strings stored by key+N with N being an incrementing number
     */
    private List&lt;String&gt; getSeries(String key) {
<span class="nc" id="L1127">        int i = 0;</span>
<span class="nc" id="L1128">        List&lt;String&gt; series = new ArrayList&lt;&gt;();</span>
        String item;
<span class="nc bnc" id="L1130" title="All 2 branches missed.">        while (!StringUtil.isBlank(item = get(key + i))) {</span>
<span class="nc" id="L1131">            series.add(item);</span>
<span class="nc" id="L1132">            i++;</span>
        }
<span class="nc" id="L1134">        return series;</span>
    }

    /**
     * Removes all entries keyed by prefix+number, where number is equal to or higher than the given number.
     *
     * @param number or higher.
     */
    private void purgeSeries(String prefix, int number) {
<span class="nc" id="L1143">        int n = number;</span>
<span class="nc bnc" id="L1144" title="All 2 branches missed.">        while (get(prefix + n) != null) {</span>
<span class="nc" id="L1145">            remove(prefix + n);</span>
<span class="nc" id="L1146">            n++;</span>
        }
<span class="nc" id="L1148">    }</span>

    /**
     * Exports Preferences to an XML file.
     *
     * @param path Path to export to
     */
    @Override
    public void exportPreferences(Path path) throws JabRefException {
<span class="nc" id="L1157">        LOGGER.debug(&quot;Exporting preferences {}&quot;, path.toAbsolutePath());</span>
<span class="nc" id="L1158">        try (OutputStream os = Files.newOutputStream(path)) {</span>
<span class="nc" id="L1159">            prefs.exportSubtree(os);</span>
<span class="nc" id="L1160">        } catch (BackingStoreException | IOException ex) {</span>
<span class="nc" id="L1161">            throw new JabRefException(</span>
                    &quot;Could not export preferences&quot;,
<span class="nc" id="L1163">                    Localization.lang(&quot;Could not export preferences&quot;),</span>
                    ex);
<span class="nc" id="L1165">        }</span>
<span class="nc" id="L1166">    }</span>

    /**
     * Imports Preferences from an XML file.
     *
     * @param file Path of file to import from
     * @throws JabRefException thrown if importing the preferences failed due to an InvalidPreferencesFormatException or an IOException
     */
    @Override
    public void importPreferences(Path file) throws JabRefException {
<span class="nc" id="L1176">        try (InputStream is = Files.newInputStream(file)) {</span>
<span class="nc" id="L1177">            Preferences.importPreferences(is);</span>
<span class="nc" id="L1178">        } catch (InvalidPreferencesFormatException | IOException ex) {</span>
<span class="nc" id="L1179">            throw new JabRefException(</span>
                    &quot;Could not import preferences&quot;,
<span class="nc" id="L1181">                    Localization.lang(&quot;Could not import preferences&quot;),</span>
                    ex);
<span class="nc" id="L1183">        }</span>
<span class="nc" id="L1184">    }</span>

    //*************************************************************************************************************
    // ToDo: Cleanup
    //*************************************************************************************************************

    @Override
    public LayoutFormatterPreferences getLayoutFormatterPreferences() {
<span class="nc" id="L1192">        return new LayoutFormatterPreferences(</span>
<span class="nc" id="L1193">                getNameFormatterPreferences(),</span>
<span class="nc" id="L1194">                getDOIPreferences(),</span>
<span class="nc" id="L1195">                getFilePreferences().mainFileDirectoryProperty());</span>
    }

    @Override
    public KeyBindingRepository getKeyBindingRepository() {
<span class="nc" id="L1200">        return new KeyBindingRepository(getStringList(BIND_NAMES), getStringList(BINDINGS));</span>
    }

    @Override
    public void storeKeyBindingRepository(KeyBindingRepository keyBindingRepository) {
<span class="nc" id="L1205">        putStringList(BIND_NAMES, keyBindingRepository.getBindNames());</span>
<span class="nc" id="L1206">        putStringList(BINDINGS, keyBindingRepository.getBindings());</span>
<span class="nc" id="L1207">    }</span>

    @Override
    public JournalAbbreviationPreferences getJournalAbbreviationPreferences() {
<span class="nc bnc" id="L1211" title="All 2 branches missed.">        if (journalAbbreviationPreferences != null) {</span>
<span class="nc" id="L1212">            return journalAbbreviationPreferences;</span>
        }

<span class="nc" id="L1215">        journalAbbreviationPreferences = new JournalAbbreviationPreferences(</span>
<span class="nc" id="L1216">                getStringList(EXTERNAL_JOURNAL_LISTS),</span>
<span class="nc" id="L1217">                getBoolean(USE_AMS_FJOURNAL));</span>

<span class="nc" id="L1219">        journalAbbreviationPreferences.getExternalJournalLists().addListener((InvalidationListener) change -&gt;</span>
<span class="nc" id="L1220">                putStringList(EXTERNAL_JOURNAL_LISTS, journalAbbreviationPreferences.getExternalJournalLists()));</span>
<span class="nc" id="L1221">        EasyBind.listen(journalAbbreviationPreferences.useFJournalFieldProperty(),</span>
<span class="nc" id="L1222">                (obs, oldValue, newValue) -&gt; putBoolean(USE_AMS_FJOURNAL, newValue));</span>

<span class="nc" id="L1224">        return journalAbbreviationPreferences;</span>
    }

    //*************************************************************************************************************
    // CustomEntryTypes
    //*************************************************************************************************************

    @Override
    public BibEntryTypesManager getCustomEntryTypesRepository() {
<span class="nc" id="L1233">        BibEntryTypesManager bibEntryTypesManager = new BibEntryTypesManager();</span>
<span class="nc" id="L1234">        EnumSet.allOf(BibDatabaseMode.class).forEach(mode -&gt;</span>
<span class="nc" id="L1235">                bibEntryTypesManager.addCustomOrModifiedTypes(getBibEntryTypes(mode), mode));</span>
<span class="nc" id="L1236">        return bibEntryTypesManager;</span>
    }

    private List&lt;BibEntryType&gt; getBibEntryTypes(BibDatabaseMode bibDatabaseMode) {
<span class="nc" id="L1240">        List&lt;BibEntryType&gt; storedEntryTypes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1241">        Preferences prefsNode = getPrefsNodeForCustomizedEntryTypes(bibDatabaseMode);</span>
        try {
<span class="nc" id="L1243">            Arrays.stream(prefsNode.keys())</span>
<span class="nc" id="L1244">                  .map(key -&gt; prefsNode.get(key, null))</span>
<span class="nc" id="L1245">                  .filter(Objects::nonNull)</span>
<span class="nc" id="L1246">                  .forEach(typeString -&gt; MetaDataParser.parseCustomEntryType(typeString).ifPresent(storedEntryTypes::add));</span>
<span class="nc" id="L1247">        } catch (BackingStoreException e) {</span>
<span class="nc" id="L1248">            LOGGER.info(&quot;Parsing customized entry types failed.&quot;, e);</span>
<span class="nc" id="L1249">        }</span>
<span class="nc" id="L1250">        return storedEntryTypes;</span>
    }

    private void clearAllBibEntryTypes() {
<span class="nc bnc" id="L1254" title="All 2 branches missed.">        for (BibDatabaseMode mode : BibDatabaseMode.values()) {</span>
<span class="nc" id="L1255">            clearBibEntryTypes(mode);</span>
        }
<span class="nc" id="L1257">    }</span>

    private void clearBibEntryTypes(BibDatabaseMode mode) {
        try {
<span class="nc" id="L1261">            Preferences prefsNode = getPrefsNodeForCustomizedEntryTypes(mode);</span>
<span class="nc" id="L1262">            prefsNode.clear();</span>
<span class="nc" id="L1263">            prefsNode.flush();</span>
<span class="nc" id="L1264">        } catch (BackingStoreException e) {</span>
<span class="nc" id="L1265">            LOGGER.error(&quot;Resetting customized entry types failed.&quot;, e);</span>
<span class="nc" id="L1266">        }</span>
<span class="nc" id="L1267">    }</span>

    @Override
    public void storeCustomEntryTypesRepository(BibEntryTypesManager entryTypesManager) {
<span class="nc" id="L1271">        clearAllBibEntryTypes();</span>
<span class="nc" id="L1272">        storeBibEntryTypes(entryTypesManager.getAllTypes(BibDatabaseMode.BIBTEX), BibDatabaseMode.BIBTEX);</span>
<span class="nc" id="L1273">        storeBibEntryTypes(entryTypesManager.getAllTypes(BibDatabaseMode.BIBLATEX), BibDatabaseMode.BIBLATEX);</span>
<span class="nc" id="L1274">    }</span>

    private void storeBibEntryTypes(Collection&lt;BibEntryType&gt; bibEntryTypes, BibDatabaseMode bibDatabaseMode) {
<span class="nc" id="L1277">        Preferences prefsNode = getPrefsNodeForCustomizedEntryTypes(bibDatabaseMode);</span>

        try {
            // clear old custom types
<span class="nc" id="L1281">            clearBibEntryTypes(bibDatabaseMode);</span>

            // store current custom types
<span class="nc" id="L1284">            bibEntryTypes.forEach(type -&gt; prefsNode.put(type.getType().getName(), MetaDataSerializer.serializeCustomEntryTypes(type)));</span>

<span class="nc" id="L1286">            prefsNode.flush();</span>
<span class="nc" id="L1287">        } catch (BackingStoreException e) {</span>
<span class="nc" id="L1288">            LOGGER.info(&quot;Updating stored custom entry types failed.&quot;, e);</span>
<span class="nc" id="L1289">        }</span>
<span class="nc" id="L1290">    }</span>

    private static Preferences getPrefsNodeForCustomizedEntryTypes(BibDatabaseMode mode) {
<span class="nc bnc" id="L1293" title="All 2 branches missed.">        return mode == BibDatabaseMode.BIBTEX</span>
<span class="nc" id="L1294">                ? PREFS_NODE.node(CUSTOMIZED_BIBTEX_TYPES)</span>
<span class="nc" id="L1295">                : PREFS_NODE.node(CUSTOMIZED_BIBLATEX_TYPES);</span>
    }

    //*************************************************************************************************************
    // Misc
    //*************************************************************************************************************

    @Override
    public OpenOfficePreferences getOpenOfficePreferences() {
<span class="nc bnc" id="L1304" title="All 2 branches missed.">        if (openOfficePreferences != null) {</span>
<span class="nc" id="L1305">            return openOfficePreferences;</span>
        }

<span class="nc" id="L1308">        openOfficePreferences = new OpenOfficePreferences(</span>
<span class="nc" id="L1309">                get(OO_EXECUTABLE_PATH),</span>
<span class="nc" id="L1310">                getBoolean(OO_USE_ALL_OPEN_BASES),</span>
<span class="nc" id="L1311">                getBoolean(OO_SYNC_WHEN_CITING),</span>
<span class="nc" id="L1312">                getStringList(OO_EXTERNAL_STYLE_FILES),</span>
<span class="nc" id="L1313">                get(OO_BIBLIOGRAPHY_STYLE_FILE));</span>

<span class="nc" id="L1315">        EasyBind.listen(openOfficePreferences.executablePathProperty(), (obs, oldValue, newValue) -&gt; put(OO_EXECUTABLE_PATH, newValue));</span>
<span class="nc" id="L1316">        EasyBind.listen(openOfficePreferences.useAllDatabasesProperty(), (obs, oldValue, newValue) -&gt; putBoolean(OO_USE_ALL_OPEN_BASES, newValue));</span>
<span class="nc" id="L1317">        EasyBind.listen(openOfficePreferences.syncWhenCitingProperty(), (obs, oldValue, newValue) -&gt; putBoolean(OO_SYNC_WHEN_CITING, newValue));</span>
<span class="nc" id="L1318">        openOfficePreferences.getExternalStyles().addListener((InvalidationListener) change -&gt;</span>
<span class="nc" id="L1319">                putStringList(OO_EXTERNAL_STYLE_FILES, openOfficePreferences.getExternalStyles()));</span>
<span class="nc" id="L1320">        EasyBind.listen(openOfficePreferences.currentStyleProperty(), (obs, oldValue, newValue) -&gt; put(OO_BIBLIOGRAPHY_STYLE_FILE, newValue));</span>

<span class="nc" id="L1322">        return openOfficePreferences;</span>
    }

    @Override
    public LibraryPreferences getLibraryPreferences() {
<span class="nc bnc" id="L1327" title="All 2 branches missed.">        if (libraryPreferences != null) {</span>
<span class="nc" id="L1328">            return libraryPreferences;</span>
        }

<span class="nc" id="L1331">        libraryPreferences = new LibraryPreferences(</span>
<span class="nc bnc" id="L1332" title="All 2 branches missed.">                getBoolean(BIBLATEX_DEFAULT_MODE) ? BibDatabaseMode.BIBLATEX : BibDatabaseMode.BIBTEX,</span>
<span class="nc" id="L1333">                getBoolean(REFORMAT_FILE_ON_SAVE_AND_EXPORT),</span>
<span class="nc" id="L1334">                getBoolean(LOCAL_AUTO_SAVE));</span>

<span class="nc bnc" id="L1336" title="All 2 branches missed.">        EasyBind.listen(libraryPreferences.defaultBibDatabaseModeProperty(), (obs, oldValue, newValue) -&gt; putBoolean(BIBLATEX_DEFAULT_MODE, (newValue == BibDatabaseMode.BIBLATEX)));</span>
<span class="nc" id="L1337">        EasyBind.listen(libraryPreferences.alwaysReformatOnSaveProperty(), (obs, oldValue, newValue) -&gt; putBoolean(REFORMAT_FILE_ON_SAVE_AND_EXPORT, newValue));</span>
<span class="nc" id="L1338">        EasyBind.listen(libraryPreferences.autoSaveProperty(), (obs, oldValue, newValue) -&gt; putBoolean(LOCAL_AUTO_SAVE, newValue));</span>

<span class="nc" id="L1340">        return libraryPreferences;</span>
    }

    @Override
    public TelemetryPreferences getTelemetryPreferences() {
<span class="nc bnc" id="L1345" title="All 2 branches missed.">        if (telemetryPreferences != null) {</span>
<span class="nc" id="L1346">            return telemetryPreferences;</span>
        }

<span class="nc" id="L1349">        telemetryPreferences = new TelemetryPreferences(</span>
<span class="nc" id="L1350">                getBoolean(COLLECT_TELEMETRY),</span>
<span class="nc bnc" id="L1351" title="All 2 branches missed.">                !getBoolean(ALREADY_ASKED_TO_COLLECT_TELEMETRY), // mind the !</span>
<span class="nc" id="L1352">                getTelemetryUserId()</span>
        );

<span class="nc" id="L1355">        EasyBind.listen(telemetryPreferences.collectTelemetryProperty(), (obs, oldValue, newValue) -&gt; putBoolean(COLLECT_TELEMETRY, newValue));</span>
<span class="nc bnc" id="L1356" title="All 2 branches missed.">        EasyBind.listen(telemetryPreferences.askToCollectTelemetryProperty(), (obs, oldValue, newValue) -&gt; putBoolean(ALREADY_ASKED_TO_COLLECT_TELEMETRY, !newValue));</span>

<span class="nc" id="L1358">        return telemetryPreferences;</span>
    }

    private String getTelemetryUserId() {
<span class="nc" id="L1362">        Optional&lt;String&gt; userId = getAsOptional(USER_ID);</span>
<span class="nc bnc" id="L1363" title="All 2 branches missed.">        if (userId.isPresent()) {</span>
<span class="nc" id="L1364">            return userId.get();</span>
        } else {
<span class="nc" id="L1366">            String newUserId = UUID.randomUUID().toString();</span>
<span class="nc" id="L1367">            put(USER_ID, newUserId);</span>
<span class="nc" id="L1368">            return newUserId;</span>
        }
    }

    @Override
    public DOIPreferences getDOIPreferences() {
<span class="nc bnc" id="L1374" title="All 2 branches missed.">        if (doiPreferences != null) {</span>
<span class="nc" id="L1375">            return doiPreferences;</span>
        }

<span class="nc" id="L1378">        doiPreferences = new DOIPreferences(</span>
<span class="nc" id="L1379">                getBoolean(USE_CUSTOM_DOI_URI),</span>
<span class="nc" id="L1380">                get(BASE_DOI_URI));</span>

<span class="nc" id="L1382">        EasyBind.listen(doiPreferences.useCustomProperty(), (obs, oldValue, newValue) -&gt; putBoolean(USE_CUSTOM_DOI_URI, newValue));</span>
<span class="nc" id="L1383">        EasyBind.listen(doiPreferences.defaultBaseURIProperty(), (obs, oldValue, newValue) -&gt; put(BASE_DOI_URI, newValue));</span>

<span class="nc" id="L1385">        return doiPreferences;</span>
    }

    @Override
    public OwnerPreferences getOwnerPreferences() {
<span class="nc bnc" id="L1390" title="All 2 branches missed.">        if (ownerPreferences != null) {</span>
<span class="nc" id="L1391">            return ownerPreferences;</span>
        }

<span class="nc" id="L1394">        ownerPreferences = new OwnerPreferences(</span>
<span class="nc" id="L1395">                getBoolean(USE_OWNER),</span>
<span class="nc" id="L1396">                get(DEFAULT_OWNER),</span>
<span class="nc" id="L1397">                getBoolean(OVERWRITE_OWNER));</span>

<span class="nc" id="L1399">        EasyBind.listen(ownerPreferences.useOwnerProperty(), (obs, oldValue, newValue) -&gt; putBoolean(USE_OWNER, newValue));</span>
<span class="nc" id="L1400">        EasyBind.listen(ownerPreferences.defaultOwnerProperty(), (obs, oldValue, newValue) -&gt; {</span>
<span class="nc" id="L1401">            put(DEFAULT_OWNER, newValue);</span>
            // trigger re-determination of userAndHost and the dependent preferences
<span class="nc" id="L1403">            userAndHost = null;</span>
<span class="nc" id="L1404">            filePreferences = null;</span>
<span class="nc" id="L1405">            internalPreferences = null;</span>
<span class="nc" id="L1406">        });</span>
<span class="nc" id="L1407">        EasyBind.listen(ownerPreferences.overwriteOwnerProperty(), (obs, oldValue, newValue) -&gt; putBoolean(OVERWRITE_OWNER, newValue));</span>

<span class="nc" id="L1409">        return ownerPreferences;</span>
    }

    @Override
    public TimestampPreferences getTimestampPreferences() {
<span class="nc bnc" id="L1414" title="All 2 branches missed.">        if (timestampPreferences != null) {</span>
<span class="nc" id="L1415">            return timestampPreferences;</span>
        }

<span class="nc" id="L1418">        timestampPreferences = new TimestampPreferences(</span>
<span class="nc" id="L1419">                getBoolean(ADD_CREATION_DATE),</span>
<span class="nc" id="L1420">                getBoolean(ADD_MODIFICATION_DATE),</span>
<span class="nc" id="L1421">                getBoolean(UPDATE_TIMESTAMP),</span>
<span class="nc" id="L1422">                FieldFactory.parseField(get(TIME_STAMP_FIELD)),</span>
<span class="nc" id="L1423">                get(TIME_STAMP_FORMAT));</span>

<span class="nc" id="L1425">        EasyBind.listen(timestampPreferences.addCreationDateProperty(), (obs, oldValue, newValue) -&gt; putBoolean(ADD_CREATION_DATE, newValue));</span>
<span class="nc" id="L1426">        EasyBind.listen(timestampPreferences.addModificationDateProperty(), (obs, oldValue, newValue) -&gt; putBoolean(ADD_MODIFICATION_DATE, newValue));</span>

<span class="nc" id="L1428">        return timestampPreferences;</span>
    }

    @Override
    public GroupsPreferences getGroupsPreferences() {
<span class="nc bnc" id="L1433" title="All 2 branches missed.">        if (groupsPreferences != null) {</span>
<span class="nc" id="L1434">            return groupsPreferences;</span>
        }

<span class="nc" id="L1437">        groupsPreferences = new GroupsPreferences(</span>
<span class="nc" id="L1438">                GroupViewMode.valueOf(get(GROUP_INTERSECT_UNION_VIEW_MODE)),</span>
<span class="nc" id="L1439">                getBoolean(AUTO_ASSIGN_GROUP),</span>
<span class="nc" id="L1440">                getBoolean(DISPLAY_GROUP_COUNT),</span>
<span class="nc" id="L1441">                GroupHierarchyType.valueOf(get(DEFAULT_HIERARCHICAL_CONTEXT))</span>
        );

<span class="nc" id="L1444">        EasyBind.listen(groupsPreferences.groupViewModeProperty(), (obs, oldValue, newValue) -&gt; put(GROUP_INTERSECT_UNION_VIEW_MODE, newValue.name()));</span>
<span class="nc" id="L1445">        EasyBind.listen(groupsPreferences.autoAssignGroupProperty(), (obs, oldValue, newValue) -&gt; putBoolean(AUTO_ASSIGN_GROUP, newValue));</span>
<span class="nc" id="L1446">        EasyBind.listen(groupsPreferences.displayGroupCountProperty(), (obs, oldValue, newValue) -&gt; putBoolean(DISPLAY_GROUP_COUNT, newValue));</span>
<span class="nc" id="L1447">        EasyBind.listen(groupsPreferences.defaultHierarchicalContextProperty(), (obs, oldValue, newValue) -&gt; put(DEFAULT_HIERARCHICAL_CONTEXT, newValue.name()));</span>

<span class="nc" id="L1449">        return groupsPreferences;</span>
    }

    //*************************************************************************************************************
    // EntryEditorPreferences
    //*************************************************************************************************************

    @Override
    public EntryEditorPreferences getEntryEditorPreferences() {
<span class="nc bnc" id="L1458" title="All 2 branches missed.">        if (entryEditorPreferences != null) {</span>
<span class="nc" id="L1459">            return entryEditorPreferences;</span>
        }

<span class="nc" id="L1462">        entryEditorPreferences = new EntryEditorPreferences(</span>
<span class="nc" id="L1463">                getEntryEditorTabs(),</span>
<span class="nc" id="L1464">                getDefaultEntryEditorTabs(),</span>
<span class="nc" id="L1465">                getBoolean(AUTO_OPEN_FORM),</span>
<span class="nc" id="L1466">                getBoolean(SHOW_RECOMMENDATIONS),</span>
<span class="nc" id="L1467">                getBoolean(SHOW_LATEX_CITATIONS),</span>
<span class="nc" id="L1468">                getBoolean(DEFAULT_SHOW_SOURCE),</span>
<span class="nc" id="L1469">                getBoolean(VALIDATE_IN_ENTRY_EDITOR),</span>
<span class="nc" id="L1470">                getBoolean(ALLOW_INTEGER_EDITION_BIBTEX),</span>
<span class="nc" id="L1471">                getDouble(ENTRY_EDITOR_HEIGHT),</span>
<span class="nc" id="L1472">                getBoolean(AUTOLINK_FILES_ENABLED),</span>
<span class="nc" id="L1473">                EntryEditorPreferences.JournalPopupEnabled.fromString(get(JOURNAL_POPUP)),</span>
<span class="nc" id="L1474">                getBoolean(SHOW_SCITE_TAB),</span>
<span class="nc" id="L1475">                getBoolean(SHOW_USER_COMMENTS_FIELDS));</span>

<span class="nc" id="L1477">        EasyBind.listen(entryEditorPreferences.entryEditorTabs(), (obs, oldValue, newValue) -&gt; storeEntryEditorTabs(newValue));</span>
        // defaultEntryEditorTabs are read-only
<span class="nc" id="L1479">        EasyBind.listen(entryEditorPreferences.shouldOpenOnNewEntryProperty(), (obs, oldValue, newValue) -&gt; putBoolean(AUTO_OPEN_FORM, newValue));</span>
<span class="nc" id="L1480">        EasyBind.listen(entryEditorPreferences.shouldShowRecommendationsTabProperty(), (obs, oldValue, newValue) -&gt; putBoolean(SHOW_RECOMMENDATIONS, newValue));</span>
<span class="nc" id="L1481">        EasyBind.listen(entryEditorPreferences.shouldShowLatexCitationsTabProperty(), (obs, oldValue, newValue) -&gt; putBoolean(SHOW_LATEX_CITATIONS, newValue));</span>
<span class="nc" id="L1482">        EasyBind.listen(entryEditorPreferences.showSourceTabByDefaultProperty(), (obs, oldValue, newValue) -&gt; putBoolean(DEFAULT_SHOW_SOURCE, newValue));</span>
<span class="nc" id="L1483">        EasyBind.listen(entryEditorPreferences.enableValidationProperty(), (obs, oldValue, newValue) -&gt; putBoolean(VALIDATE_IN_ENTRY_EDITOR, newValue));</span>
<span class="nc" id="L1484">        EasyBind.listen(entryEditorPreferences.allowIntegerEditionBibtexProperty(), (obs, oldValue, newValue) -&gt; putBoolean(ALLOW_INTEGER_EDITION_BIBTEX, newValue));</span>
<span class="nc" id="L1485">        EasyBind.listen(entryEditorPreferences.dividerPositionProperty(), (obs, oldValue, newValue) -&gt; putDouble(ENTRY_EDITOR_HEIGHT, newValue.doubleValue()));</span>
<span class="nc" id="L1486">        EasyBind.listen(entryEditorPreferences.autoLinkEnabledProperty(), (obs, oldValue, newValue) -&gt; putBoolean(AUTOLINK_FILES_ENABLED, newValue));</span>
<span class="nc" id="L1487">        EasyBind.listen(entryEditorPreferences.enableJournalPopupProperty(), (obs, oldValue, newValue) -&gt; put(JOURNAL_POPUP, newValue.toString()));</span>
<span class="nc" id="L1488">        EasyBind.listen(entryEditorPreferences.shouldShowLSciteTabProperty(), (obs, oldValue, newValue) -&gt; putBoolean(SHOW_SCITE_TAB, newValue));</span>
<span class="nc" id="L1489">        EasyBind.listen(entryEditorPreferences.showUserCommentsFieldsProperty(), (obs, oldValue, newValue) -&gt; putBoolean(SHOW_USER_COMMENTS_FIELDS, newValue));</span>

<span class="nc" id="L1491">        return entryEditorPreferences;</span>
    }

    /**
     * Get a Map of defined tab names to default tab fields.
     *
     * @return A map of the currently defined tabs in the entry editor from scratch to cache
     */
    private Map&lt;String, Set&lt;Field&gt;&gt; getEntryEditorTabs() {
<span class="nc" id="L1500">        Map&lt;String, Set&lt;Field&gt;&gt; tabs = new LinkedHashMap&lt;&gt;();</span>
<span class="nc" id="L1501">        List&lt;String&gt; tabNames = getSeries(CUSTOM_TAB_NAME);</span>
<span class="nc" id="L1502">        List&lt;String&gt; tabFields = getSeries(CUSTOM_TAB_FIELDS);</span>

<span class="nc bnc" id="L1504" title="All 4 branches missed.">        if (tabNames.isEmpty() || (tabNames.size() != tabFields.size())) {</span>
            // Nothing set, so we use the default values
<span class="nc" id="L1506">            tabNames = getSeries(CUSTOM_TAB_NAME + &quot;_def&quot;);</span>
<span class="nc" id="L1507">            tabFields = getSeries(CUSTOM_TAB_FIELDS + &quot;_def&quot;);</span>
        }

<span class="nc bnc" id="L1510" title="All 2 branches missed.">        for (int i = 0; i &lt; tabNames.size(); i++) {</span>
<span class="nc" id="L1511">            tabs.put(tabNames.get(i), FieldFactory.parseFieldList(tabFields.get(i)));</span>
        }
<span class="nc" id="L1513">        return tabs;</span>
    }

    /**
     * Stores the defined tabs and corresponding fields in the preferences.
     *
     * @param customTabs a map of tab names and the corresponding set of fields to be displayed in
     */
    private void storeEntryEditorTabs(Map&lt;String, Set&lt;Field&gt;&gt; customTabs) {
<span class="nc" id="L1522">        String[] names = customTabs.keySet().toArray(String[]::new);</span>
<span class="nc" id="L1523">        String[] fields = customTabs.values().stream()</span>
<span class="nc" id="L1524">                                    .map(set -&gt; set.stream()</span>
<span class="nc" id="L1525">                                                   .map(Field::getName)</span>
<span class="nc" id="L1526">                                                   .collect(Collectors.joining(STRINGLIST_DELIMITER.toString())))</span>
<span class="nc" id="L1527">                                    .toArray(String[]::new);</span>

<span class="nc bnc" id="L1529" title="All 2 branches missed.">        for (int i = 0; i &lt; customTabs.size(); i++) {</span>
<span class="nc" id="L1530">            put(CUSTOM_TAB_NAME + i, names[i]);</span>
<span class="nc" id="L1531">            put(CUSTOM_TAB_FIELDS + i, fields[i]);</span>
        }

<span class="nc" id="L1534">        purgeSeries(CUSTOM_TAB_NAME, customTabs.size());</span>
<span class="nc" id="L1535">        purgeSeries(CUSTOM_TAB_FIELDS, customTabs.size());</span>

<span class="nc" id="L1537">        getEntryEditorTabs();</span>
<span class="nc" id="L1538">    }</span>

    private Map&lt;String, Set&lt;Field&gt;&gt; getDefaultEntryEditorTabs() {
<span class="nc" id="L1541">        Map&lt;String, Set&lt;Field&gt;&gt; customTabsMap = new LinkedHashMap&lt;&gt;();</span>

<span class="nc" id="L1543">        int defNumber = 0;</span>
        while (true) {
            // Saved as 'CUSTOMTABNAME_def{number}' and seperated by ';'
<span class="nc" id="L1546">            String name = (String) defaults.get(CUSTOM_TAB_NAME + &quot;_def&quot; + defNumber);</span>
<span class="nc" id="L1547">            String fields = (String) defaults.get(CUSTOM_TAB_FIELDS + &quot;_def&quot; + defNumber);</span>

<span class="nc bnc" id="L1549" title="All 4 branches missed.">            if (StringUtil.isNullOrEmpty(name) || StringUtil.isNullOrEmpty(fields)) {</span>
<span class="nc" id="L1550">                break;</span>
            }

<span class="nc" id="L1553">            customTabsMap.put(name, FieldFactory.parseFieldList((String) defaults.get(CUSTOM_TAB_FIELDS + &quot;_def&quot; + defNumber)));</span>
<span class="nc" id="L1554">            defNumber++;</span>
<span class="nc" id="L1555">        }</span>
<span class="nc" id="L1556">        return customTabsMap;</span>
    }

    //*************************************************************************************************************
    // Network preferences
    //*************************************************************************************************************

    @Override
    public RemotePreferences getRemotePreferences() {
<span class="nc bnc" id="L1565" title="All 2 branches missed.">        if (remotePreferences != null) {</span>
<span class="nc" id="L1566">            return remotePreferences;</span>
        }

<span class="nc" id="L1569">        remotePreferences = new RemotePreferences(</span>
<span class="nc" id="L1570">                getInt(REMOTE_SERVER_PORT),</span>
<span class="nc" id="L1571">                getBoolean(USE_REMOTE_SERVER));</span>

<span class="nc" id="L1573">        EasyBind.listen(remotePreferences.portProperty(), (obs, oldValue, newValue) -&gt; putInt(REMOTE_SERVER_PORT, newValue));</span>
<span class="nc" id="L1574">        EasyBind.listen(remotePreferences.useRemoteServerProperty(), (obs, oldValue, newValue) -&gt; putBoolean(USE_REMOTE_SERVER, newValue));</span>

<span class="nc" id="L1576">        return remotePreferences;</span>
    }

    @Override
    public ProxyPreferences getProxyPreferences() {
<span class="nc bnc" id="L1581" title="All 2 branches missed.">        if (proxyPreferences != null) {</span>
<span class="nc" id="L1582">            return proxyPreferences;</span>
        }

<span class="nc" id="L1585">        proxyPreferences = new ProxyPreferences(</span>
<span class="nc" id="L1586">                getBoolean(PROXY_USE),</span>
<span class="nc" id="L1587">                get(PROXY_HOSTNAME),</span>
<span class="nc" id="L1588">                get(PROXY_PORT),</span>
<span class="nc" id="L1589">                getBoolean(PROXY_USE_AUTHENTICATION),</span>
<span class="nc" id="L1590">                get(PROXY_USERNAME),</span>
<span class="nc" id="L1591">                getProxyPassword(),</span>
<span class="nc" id="L1592">                getBoolean(PROXY_PERSIST_PASSWORD));</span>

<span class="nc" id="L1594">        EasyBind.listen(proxyPreferences.useProxyProperty(), (obs, oldValue, newValue) -&gt; putBoolean(PROXY_USE, newValue));</span>
<span class="nc" id="L1595">        EasyBind.listen(proxyPreferences.hostnameProperty(), (obs, oldValue, newValue) -&gt; put(PROXY_HOSTNAME, newValue));</span>
<span class="nc" id="L1596">        EasyBind.listen(proxyPreferences.portProperty(), (obs, oldValue, newValue) -&gt; put(PROXY_PORT, newValue));</span>
<span class="nc" id="L1597">        EasyBind.listen(proxyPreferences.useAuthenticationProperty(), (obs, oldValue, newValue) -&gt; putBoolean(PROXY_USE_AUTHENTICATION, newValue));</span>
<span class="nc" id="L1598">        EasyBind.listen(proxyPreferences.usernameProperty(), (obs, oldValue, newValue) -&gt; put(PROXY_USERNAME, newValue));</span>
<span class="nc" id="L1599">        EasyBind.listen(proxyPreferences.passwordProperty(), (obs, oldValue, newValue) -&gt; setProxyPassword(newValue));</span>
<span class="nc" id="L1600">        EasyBind.listen(proxyPreferences.persistPasswordProperty(), (obs, oldValue, newValue) -&gt; {</span>
<span class="nc" id="L1601">            putBoolean(PROXY_PERSIST_PASSWORD, newValue);</span>
<span class="nc bnc" id="L1602" title="All 2 branches missed.">            if (!newValue) {</span>
<span class="nc" id="L1603">                try (final Keyring keyring = Keyring.create()) {</span>
<span class="nc" id="L1604">                    keyring.deletePassword(&quot;org.jabref&quot;, &quot;proxy&quot;);</span>
<span class="nc" id="L1605">                } catch (Exception ex) {</span>
<span class="nc" id="L1606">                    LOGGER.warn(&quot;Unable to remove proxy credentials&quot;);</span>
<span class="nc" id="L1607">                }</span>
            }
<span class="nc" id="L1609">        });</span>

<span class="nc" id="L1611">        return proxyPreferences;</span>
    }

    private String getProxyPassword() {
<span class="nc bnc" id="L1615" title="All 2 branches missed.">        if (getBoolean(PROXY_PERSIST_PASSWORD)) {</span>
<span class="nc" id="L1616">            try (final Keyring keyring = Keyring.create()) {</span>
<span class="nc" id="L1617">                return new Password(</span>
<span class="nc" id="L1618">                        keyring.getPassword(&quot;org.jabref&quot;, &quot;proxy&quot;),</span>
<span class="nc" id="L1619">                        getInternalPreferences().getUserAndHost())</span>
<span class="nc" id="L1620">                        .decrypt();</span>
<span class="nc" id="L1621">            } catch (PasswordAccessException ex) {</span>
<span class="nc" id="L1622">                LOGGER.warn(&quot;JabRef uses proxy password from key store but no password is stored&quot;);</span>
<span class="nc" id="L1623">            } catch (Exception ex) {</span>
<span class="nc" id="L1624">                LOGGER.warn(&quot;JabRef could not open the key store&quot;);</span>
<span class="nc" id="L1625">            }</span>
        }
<span class="nc" id="L1627">        return (String) defaults.get(PROXY_PASSWORD);</span>
    }

    private void setProxyPassword(String password) {
<span class="nc bnc" id="L1631" title="All 2 branches missed.">        if (getProxyPreferences().shouldPersistPassword()) {</span>
<span class="nc" id="L1632">            try (final Keyring keyring = Keyring.create()) {</span>
<span class="nc bnc" id="L1633" title="All 2 branches missed.">                if (StringUtil.isBlank(password)) {</span>
<span class="nc" id="L1634">                    keyring.deletePassword(&quot;org.jabref&quot;, &quot;proxy&quot;);</span>
                } else {
<span class="nc" id="L1636">                    keyring.setPassword(&quot;org.jabref&quot;, &quot;proxy&quot;, new Password(</span>
<span class="nc" id="L1637">                            password.trim(),</span>
<span class="nc" id="L1638">                            getInternalPreferences().getUserAndHost())</span>
<span class="nc" id="L1639">                            .encrypt());</span>
                }
<span class="nc" id="L1641">            } catch (Exception ex) {</span>
<span class="nc" id="L1642">                LOGGER.warn(&quot;Unable to open key store&quot;, ex);</span>
<span class="nc" id="L1643">            }</span>
        }
<span class="nc" id="L1645">    }</span>

    @Override
    public SSLPreferences getSSLPreferences() {
<span class="nc bnc" id="L1649" title="All 2 branches missed.">        if (sslPreferences != null) {</span>
<span class="nc" id="L1650">            return sslPreferences;</span>
        }

<span class="nc" id="L1653">        sslPreferences = new SSLPreferences(</span>
<span class="nc" id="L1654">                get(TRUSTSTORE_PATH)</span>
        );

<span class="nc" id="L1657">        return sslPreferences;</span>
    }

    //*************************************************************************************************************
    // CitationKeyPatternPreferences
    //*************************************************************************************************************

    private GlobalCitationKeyPattern getGlobalCitationKeyPattern() {
<span class="nc" id="L1665">        GlobalCitationKeyPattern citationKeyPattern = GlobalCitationKeyPattern.fromPattern(get(DEFAULT_CITATION_KEY_PATTERN));</span>
<span class="nc" id="L1666">        Preferences preferences = PREFS_NODE.node(CITATION_KEY_PATTERNS_NODE);</span>
        try {
<span class="nc" id="L1668">            String[] keys = preferences.keys();</span>
<span class="nc bnc" id="L1669" title="All 2 branches missed.">            for (String key : keys) {</span>
<span class="nc" id="L1670">                citationKeyPattern.addCitationKeyPattern(</span>
<span class="nc" id="L1671">                        EntryTypeFactory.parse(key),</span>
<span class="nc" id="L1672">                        preferences.get(key, null));</span>
            }
<span class="nc" id="L1674">        } catch (</span>
                BackingStoreException ex) {
<span class="nc" id="L1676">            LOGGER.info(&quot;BackingStoreException in JabRefPreferences.getKeyPattern&quot;, ex);</span>
<span class="nc" id="L1677">        }</span>

<span class="nc" id="L1679">        return citationKeyPattern;</span>
    }

    // public for use in PreferenceMigrations
    public void storeGlobalCitationKeyPattern(GlobalCitationKeyPattern pattern) {
<span class="nc bnc" id="L1684" title="All 2 branches missed.">        if ((pattern.getDefaultValue() == null)</span>
<span class="nc bnc" id="L1685" title="All 2 branches missed.">                || pattern.getDefaultValue().isEmpty()) {</span>
<span class="nc" id="L1686">            put(DEFAULT_CITATION_KEY_PATTERN, &quot;&quot;);</span>
        } else {
<span class="nc" id="L1688">            put(DEFAULT_CITATION_KEY_PATTERN, pattern.getDefaultValue().getFirst());</span>
        }

        // Store overridden definitions to Preferences.
<span class="nc" id="L1692">        Preferences preferences = PREFS_NODE.node(CITATION_KEY_PATTERNS_NODE);</span>
        try {
<span class="nc" id="L1694">            preferences.clear(); // We remove all old entries.</span>
<span class="nc" id="L1695">        } catch (</span>
                BackingStoreException ex) {
<span class="nc" id="L1697">            LOGGER.info(&quot;BackingStoreException in JabRefPreferences::putKeyPattern&quot;, ex);</span>
<span class="nc" id="L1698">        }</span>

<span class="nc bnc" id="L1700" title="All 2 branches missed.">        for (EntryType entryType : pattern.getAllKeys()) {</span>
<span class="nc bnc" id="L1701" title="All 2 branches missed.">            if (!pattern.isDefaultValue(entryType)) {</span>
                // first entry in the map is the full pattern
<span class="nc" id="L1703">                preferences.put(entryType.getName(), pattern.getValue(entryType).getFirst());</span>
            }
<span class="nc" id="L1705">        }</span>
<span class="nc" id="L1706">    }</span>

    private void clearCitationKeyPatterns() throws BackingStoreException {
<span class="nc" id="L1709">        Preferences preferences = PREFS_NODE.node(CITATION_KEY_PATTERNS_NODE);</span>
<span class="nc" id="L1710">        preferences.clear();</span>
<span class="nc" id="L1711">        getCitationKeyPatternPreferences().setKeyPattern(getGlobalCitationKeyPattern());</span>
<span class="nc" id="L1712">    }</span>

    @Override
    public CitationKeyPatternPreferences getCitationKeyPatternPreferences() {
<span class="nc bnc" id="L1716" title="All 2 branches missed.">        if (citationKeyPatternPreferences != null) {</span>
<span class="nc" id="L1717">            return citationKeyPatternPreferences;</span>
        }

<span class="nc" id="L1720">        citationKeyPatternPreferences = new CitationKeyPatternPreferences(</span>
<span class="nc" id="L1721">                getBoolean(AVOID_OVERWRITING_KEY),</span>
<span class="nc" id="L1722">                getBoolean(WARN_BEFORE_OVERWRITING_KEY),</span>
<span class="nc" id="L1723">                getBoolean(GENERATE_KEYS_BEFORE_SAVING),</span>
<span class="nc" id="L1724">                getKeySuffix(),</span>
<span class="nc" id="L1725">                get(KEY_PATTERN_REGEX),</span>
<span class="nc" id="L1726">                get(KEY_PATTERN_REPLACEMENT),</span>
<span class="nc" id="L1727">                get(UNWANTED_CITATION_KEY_CHARACTERS),</span>
<span class="nc" id="L1728">                getGlobalCitationKeyPattern(),</span>
<span class="nc" id="L1729">                (String) defaults.get(DEFAULT_CITATION_KEY_PATTERN),</span>
<span class="nc" id="L1730">                getBibEntryPreferences().keywordSeparatorProperty());</span>

<span class="nc" id="L1732">        EasyBind.listen(citationKeyPatternPreferences.shouldAvoidOverwriteCiteKeyProperty(),</span>
<span class="nc" id="L1733">                (obs, oldValue, newValue) -&gt; putBoolean(AVOID_OVERWRITING_KEY, newValue));</span>
<span class="nc" id="L1734">        EasyBind.listen(citationKeyPatternPreferences.shouldWarnBeforeOverwriteCiteKeyProperty(),</span>
<span class="nc" id="L1735">                (obs, oldValue, newValue) -&gt; putBoolean(WARN_BEFORE_OVERWRITING_KEY, newValue));</span>
<span class="nc" id="L1736">        EasyBind.listen(citationKeyPatternPreferences.shouldGenerateCiteKeysBeforeSavingProperty(),</span>
<span class="nc" id="L1737">                (obs, oldValue, newValue) -&gt; putBoolean(GENERATE_KEYS_BEFORE_SAVING, newValue));</span>
<span class="nc" id="L1738">        EasyBind.listen(citationKeyPatternPreferences.keySuffixProperty(), (obs, oldValue, newValue) -&gt; {</span>
<span class="nc bnc" id="L1739" title="All 2 branches missed.">            putBoolean(KEY_GEN_ALWAYS_ADD_LETTER, newValue == CitationKeyPatternPreferences.KeySuffix.ALWAYS);</span>
<span class="nc bnc" id="L1740" title="All 2 branches missed.">            putBoolean(KEY_GEN_FIRST_LETTER_A, newValue == CitationKeyPatternPreferences.KeySuffix.SECOND_WITH_A);</span>
<span class="nc" id="L1741">        });</span>
<span class="nc" id="L1742">        EasyBind.listen(citationKeyPatternPreferences.keyPatternRegexProperty(),</span>
<span class="nc" id="L1743">                (obs, oldValue, newValue) -&gt; put(KEY_PATTERN_REGEX, newValue));</span>
<span class="nc" id="L1744">        EasyBind.listen(citationKeyPatternPreferences.keyPatternReplacementProperty(),</span>
<span class="nc" id="L1745">                (obs, oldValue, newValue) -&gt; put(KEY_PATTERN_REPLACEMENT, newValue));</span>
<span class="nc" id="L1746">        EasyBind.listen(citationKeyPatternPreferences.unwantedCharactersProperty(),</span>
<span class="nc" id="L1747">                (obs, oldValue, newValue) -&gt; put(UNWANTED_CITATION_KEY_CHARACTERS, newValue));</span>
<span class="nc" id="L1748">        EasyBind.listen(citationKeyPatternPreferences.keyPatternProperty(),</span>
<span class="nc" id="L1749">                (obs, oldValue, newValue) -&gt; storeGlobalCitationKeyPattern(newValue));</span>

<span class="nc" id="L1751">        return citationKeyPatternPreferences;</span>
    }

    private CitationKeyPatternPreferences.KeySuffix getKeySuffix() {
<span class="nc" id="L1755">        CitationKeyPatternPreferences.KeySuffix keySuffix =</span>
                CitationKeyPatternPreferences.KeySuffix.SECOND_WITH_B;
<span class="nc bnc" id="L1757" title="All 2 branches missed.">        if (getBoolean(KEY_GEN_ALWAYS_ADD_LETTER)) {</span>
<span class="nc" id="L1758">            keySuffix = CitationKeyPatternPreferences.KeySuffix.ALWAYS;</span>
<span class="nc bnc" id="L1759" title="All 2 branches missed.">        } else if (getBoolean(KEY_GEN_FIRST_LETTER_A)) {</span>
<span class="nc" id="L1760">            keySuffix = CitationKeyPatternPreferences.KeySuffix.SECOND_WITH_A;</span>
        }
<span class="nc" id="L1762">        return keySuffix;</span>
    }

    //*************************************************************************************************************
    // ExternalApplicationsPreferences
    //*************************************************************************************************************

    @Override
    public PushToApplicationPreferences getPushToApplicationPreferences() {
<span class="nc bnc" id="L1771" title="All 2 branches missed.">        if (pushToApplicationPreferences != null) {</span>
<span class="nc" id="L1772">            return pushToApplicationPreferences;</span>
        }

<span class="nc" id="L1775">        Map&lt;String, String&gt; applicationCommands = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1776">        applicationCommands.put(PushToApplications.EMACS, get(PUSH_EMACS_PATH));</span>
<span class="nc" id="L1777">        applicationCommands.put(PushToApplications.LYX, get(PUSH_LYXPIPE));</span>
<span class="nc" id="L1778">        applicationCommands.put(PushToApplications.TEXMAKER, get(PUSH_TEXMAKER_PATH));</span>
<span class="nc" id="L1779">        applicationCommands.put(PushToApplications.TEXSTUDIO, get(PUSH_TEXSTUDIO_PATH));</span>
<span class="nc" id="L1780">        applicationCommands.put(PushToApplications.VIM, get(PUSH_VIM));</span>
<span class="nc" id="L1781">        applicationCommands.put(PushToApplications.WIN_EDT, get(PUSH_WINEDT_PATH));</span>
<span class="nc" id="L1782">        applicationCommands.put(PushToApplications.SUBLIME_TEXT, get(PUSH_SUBLIME_TEXT_PATH));</span>

<span class="nc" id="L1784">        pushToApplicationPreferences = new PushToApplicationPreferences(</span>
<span class="nc" id="L1785">                get(PUSH_TO_APPLICATION),</span>
                applicationCommands,
<span class="nc" id="L1787">                get(PUSH_EMACS_ADDITIONAL_PARAMETERS),</span>
<span class="nc" id="L1788">                get(PUSH_VIM_SERVER)</span>
        );

<span class="nc" id="L1791">        EasyBind.listen(pushToApplicationPreferences.activeApplicationNameProperty(), (obs, oldValue, newValue) -&gt; put(PUSH_TO_APPLICATION, newValue));</span>
<span class="nc" id="L1792">        pushToApplicationPreferences.getCommandPaths().addListener((obs, oldValue, newValue) -&gt; storePushToApplicationPath(newValue));</span>
<span class="nc" id="L1793">        EasyBind.listen(pushToApplicationPreferences.emacsArgumentsProperty(), (obs, oldValue, newValue) -&gt; put(PUSH_EMACS_ADDITIONAL_PARAMETERS, newValue));</span>
<span class="nc" id="L1794">        EasyBind.listen(pushToApplicationPreferences.vimServerProperty(), (obs, oldValue, newValue) -&gt; put(PUSH_VIM_SERVER, newValue));</span>
<span class="nc" id="L1795">        return pushToApplicationPreferences;</span>
    }

    private void storePushToApplicationPath(Map&lt;String, String&gt; commandPair) {
<span class="nc" id="L1799">        commandPair.forEach((key, value) -&gt; {</span>
<span class="nc bnc" id="L1800" title="All 8 branches missed.">            switch (key) {</span>
                case PushToApplications.EMACS -&gt;
<span class="nc" id="L1802">                        put(PUSH_EMACS_PATH, value);</span>
                case PushToApplications.LYX -&gt;
<span class="nc" id="L1804">                        put(PUSH_LYXPIPE, value);</span>
                case PushToApplications.TEXMAKER -&gt;
<span class="nc" id="L1806">                        put(PUSH_TEXMAKER_PATH, value);</span>
                case PushToApplications.TEXSTUDIO -&gt;
<span class="nc" id="L1808">                        put(PUSH_TEXSTUDIO_PATH, value);</span>
                case PushToApplications.VIM -&gt;
<span class="nc" id="L1810">                        put(PUSH_VIM, value);</span>
                case PushToApplications.WIN_EDT -&gt;
<span class="nc" id="L1812">                        put(PUSH_WINEDT_PATH, value);</span>
                case PushToApplications.SUBLIME_TEXT -&gt;
<span class="nc" id="L1814">                        put(PUSH_SUBLIME_TEXT_PATH, value);</span>
            }
<span class="nc" id="L1816">        });</span>
<span class="nc" id="L1817">    }</span>

    @Override
    public ExternalApplicationsPreferences getExternalApplicationsPreferences() {
<span class="nc bnc" id="L1821" title="All 2 branches missed.">        if (externalApplicationsPreferences != null) {</span>
<span class="nc" id="L1822">            return externalApplicationsPreferences;</span>
        }

<span class="nc" id="L1825">        externalApplicationsPreferences = new ExternalApplicationsPreferences(</span>
<span class="nc" id="L1826">                get(EMAIL_SUBJECT),</span>
<span class="nc" id="L1827">                getBoolean(OPEN_FOLDERS_OF_ATTACHED_FILES),</span>
<span class="nc" id="L1828">                CitationCommandString.from(get(CITE_COMMAND)),</span>
<span class="nc" id="L1829">                CitationCommandString.from((String) defaults.get(CITE_COMMAND)),</span>
<span class="nc bnc" id="L1830" title="All 2 branches missed.">                !getBoolean(USE_DEFAULT_CONSOLE_APPLICATION), // mind the !</span>
<span class="nc" id="L1831">                get(CONSOLE_COMMAND),</span>
<span class="nc bnc" id="L1832" title="All 2 branches missed.">                !getBoolean(USE_DEFAULT_FILE_BROWSER_APPLICATION), // mind the !</span>
<span class="nc" id="L1833">                get(FILE_BROWSER_COMMAND),</span>
<span class="nc" id="L1834">                get(KINDLE_EMAIL));</span>

<span class="nc" id="L1836">        EasyBind.listen(externalApplicationsPreferences.eMailSubjectProperty(),</span>
<span class="nc" id="L1837">                (obs, oldValue, newValue) -&gt; put(EMAIL_SUBJECT, newValue));</span>
<span class="nc" id="L1838">        EasyBind.listen(externalApplicationsPreferences.autoOpenEmailAttachmentsFolderProperty(),</span>
<span class="nc" id="L1839">                (obs, oldValue, newValue) -&gt; putBoolean(OPEN_FOLDERS_OF_ATTACHED_FILES, newValue));</span>
<span class="nc" id="L1840">        EasyBind.listen(externalApplicationsPreferences.citeCommandProperty(),</span>
<span class="nc" id="L1841">                (obs, oldValue, newValue) -&gt; put(CITE_COMMAND, newValue.toString()));</span>
<span class="nc" id="L1842">        EasyBind.listen(externalApplicationsPreferences.useCustomTerminalProperty(),</span>
<span class="nc bnc" id="L1843" title="All 2 branches missed.">                (obs, oldValue, newValue) -&gt; putBoolean(USE_DEFAULT_CONSOLE_APPLICATION, !newValue)); // mind the !</span>
<span class="nc" id="L1844">        EasyBind.listen(externalApplicationsPreferences.customTerminalCommandProperty(),</span>
<span class="nc" id="L1845">                (obs, oldValue, newValue) -&gt; put(CONSOLE_COMMAND, newValue));</span>
<span class="nc" id="L1846">        EasyBind.listen(externalApplicationsPreferences.useCustomFileBrowserProperty(),</span>
<span class="nc bnc" id="L1847" title="All 2 branches missed.">                (obs, oldValue, newValue) -&gt; putBoolean(USE_DEFAULT_FILE_BROWSER_APPLICATION, !newValue)); // mind the !</span>
<span class="nc" id="L1848">        EasyBind.listen(externalApplicationsPreferences.customFileBrowserCommandProperty(),</span>
<span class="nc" id="L1849">                (obs, oldValue, newValue) -&gt; put(FILE_BROWSER_COMMAND, newValue));</span>
<span class="nc" id="L1850">        EasyBind.listen(externalApplicationsPreferences.kindleEmailProperty(),</span>
<span class="nc" id="L1851">                (obs, oldValue, newValue) -&gt; put(KINDLE_EMAIL, newValue));</span>

<span class="nc" id="L1853">        return externalApplicationsPreferences;</span>
    }

    //*************************************************************************************************************
    // Main table and search dialog preferences
    //*************************************************************************************************************

    @Override
    public MainTablePreferences getMainTablePreferences() {
<span class="nc bnc" id="L1862" title="All 2 branches missed.">        if (mainTablePreferences != null) {</span>
<span class="nc" id="L1863">            return mainTablePreferences;</span>
        }

<span class="nc" id="L1866">        mainTablePreferences = new MainTablePreferences(</span>
<span class="nc" id="L1867">                getMainTableColumnPreferences(),</span>
<span class="nc" id="L1868">                getBoolean(AUTO_RESIZE_MODE),</span>
<span class="nc" id="L1869">                getBoolean(EXTRA_FILE_COLUMNS));</span>

<span class="nc" id="L1871">        EasyBind.listen(mainTablePreferences.resizeColumnsToFitProperty(),</span>
<span class="nc" id="L1872">                (obs, oldValue, newValue) -&gt; putBoolean(AUTO_RESIZE_MODE, newValue));</span>
<span class="nc" id="L1873">        EasyBind.listen(mainTablePreferences.extraFileColumnsEnabledProperty(),</span>
<span class="nc" id="L1874">                (obs, oldValue, newValue) -&gt; putBoolean(EXTRA_FILE_COLUMNS, newValue));</span>

<span class="nc" id="L1876">        return mainTablePreferences;</span>
    }

    @Override
    public ColumnPreferences getMainTableColumnPreferences() {
<span class="nc bnc" id="L1881" title="All 2 branches missed.">        if (mainTableColumnPreferences != null) {</span>
<span class="nc" id="L1882">            return mainTableColumnPreferences;</span>
        }

<span class="nc" id="L1885">        List&lt;MainTableColumnModel&gt; columns = getColumns(COLUMN_NAMES, COLUMN_WIDTHS, COLUMN_SORT_TYPES, ColumnPreferences.DEFAULT_COLUMN_WIDTH);</span>
<span class="nc" id="L1886">        List&lt;MainTableColumnModel&gt; columnSortOrder = getColumnSortOrder(COLUMN_SORT_ORDER, columns);</span>
<span class="nc" id="L1887">        mainTableColumnPreferences = new ColumnPreferences(columns, columnSortOrder);</span>

<span class="nc" id="L1889">        mainTableColumnPreferences.getColumns().addListener((InvalidationListener) change -&gt; {</span>
<span class="nc" id="L1890">            putStringList(COLUMN_NAMES, getColumnNamesAsStringList(mainTableColumnPreferences));</span>
<span class="nc" id="L1891">            putStringList(COLUMN_WIDTHS, getColumnWidthsAsStringList(mainTableColumnPreferences));</span>
<span class="nc" id="L1892">            putStringList(COLUMN_SORT_TYPES, getColumnSortTypesAsStringList(mainTableColumnPreferences));</span>
<span class="nc" id="L1893">        });</span>
<span class="nc" id="L1894">        mainTableColumnPreferences.getColumnSortOrder().addListener((InvalidationListener) change -&gt;</span>
<span class="nc" id="L1895">                putStringList(COLUMN_SORT_ORDER, getColumnSortOrderAsStringList(mainTableColumnPreferences)));</span>

<span class="nc" id="L1897">        return mainTableColumnPreferences;</span>
    }

    @Override
    public ColumnPreferences getSearchDialogColumnPreferences() {
<span class="nc bnc" id="L1902" title="All 2 branches missed.">        if (searchDialogColumnPreferences != null) {</span>
<span class="nc" id="L1903">            return searchDialogColumnPreferences;</span>
        }

<span class="nc" id="L1906">        List&lt;MainTableColumnModel&gt; columns = getColumns(COLUMN_NAMES, SEARCH_DIALOG_COLUMN_WIDTHS, SEARCH_DIALOG_COLUMN_SORT_TYPES, ColumnPreferences.DEFAULT_COLUMN_WIDTH);</span>
<span class="nc" id="L1907">        List&lt;MainTableColumnModel&gt; columnSortOrder = getColumnSortOrder(SEARCH_DIALOG_COLUMN_SORT_ORDER, columns);</span>
<span class="nc" id="L1908">        searchDialogColumnPreferences = new ColumnPreferences(columns, columnSortOrder);</span>

<span class="nc" id="L1910">        searchDialogColumnPreferences.getColumns().addListener((InvalidationListener) change -&gt; {</span>
            // MainTable and SearchResultTable use the same set of columnNames
            // putStringList(SEARCH_DIALOG_COLUMN_NAMES, getColumnNamesAsStringList(columnPreferences));
<span class="nc" id="L1913">            putStringList(SEARCH_DIALOG_COLUMN_WIDTHS, getColumnWidthsAsStringList(searchDialogColumnPreferences));</span>
<span class="nc" id="L1914">            putStringList(SEARCH_DIALOG_COLUMN_SORT_TYPES, getColumnSortTypesAsStringList(searchDialogColumnPreferences));</span>
<span class="nc" id="L1915">        });</span>
<span class="nc" id="L1916">        searchDialogColumnPreferences.getColumnSortOrder().addListener((InvalidationListener) change -&gt;</span>
<span class="nc" id="L1917">                putStringList(SEARCH_DIALOG_COLUMN_SORT_ORDER, getColumnSortOrderAsStringList(searchDialogColumnPreferences)));</span>

<span class="nc" id="L1919">        return searchDialogColumnPreferences;</span>
    }

    // --- Generic column handling ---
    @SuppressWarnings(&quot;SameParameterValue&quot;)
    private List&lt;MainTableColumnModel&gt; getColumns(String columnNamesList, String columnWidthList, String sortTypeList, double defaultWidth) {
<span class="nc" id="L1925">        List&lt;String&gt; columnNames = getStringList(columnNamesList);</span>
<span class="nc" id="L1926">        List&lt;Double&gt; columnWidths = getStringList(columnWidthList)</span>
<span class="nc" id="L1927">                .stream()</span>
<span class="nc" id="L1928">                .map(string -&gt; {</span>
                    try {
<span class="nc" id="L1930">                        return Double.parseDouble(string);</span>
<span class="nc" id="L1931">                    } catch (</span>
                            NumberFormatException e) {
<span class="nc" id="L1933">                        LOGGER.error(&quot;Exception while parsing column widths. Choosing default.&quot;, e);</span>
<span class="nc" id="L1934">                        return defaultWidth;</span>
                    }
<span class="nc" id="L1936">                }).toList();</span>

<span class="nc" id="L1938">        List&lt;SortType&gt; columnSortTypes = getStringList(sortTypeList)</span>
<span class="nc" id="L1939">                .stream()</span>
<span class="nc" id="L1940">                .map(SortType::valueOf).toList();</span>

<span class="nc" id="L1942">        List&lt;MainTableColumnModel&gt; columns = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1943" title="All 2 branches missed.">        for (int i = 0; i &lt; columnNames.size(); i++) {</span>
<span class="nc" id="L1944">            MainTableColumnModel columnModel = MainTableColumnModel.parse(columnNames.get(i));</span>

<span class="nc bnc" id="L1946" title="All 2 branches missed.">            if (i &lt; columnWidths.size()) {</span>
<span class="nc" id="L1947">                columnModel.widthProperty().setValue(columnWidths.get(i));</span>
            }

<span class="nc bnc" id="L1950" title="All 2 branches missed.">            if (i &lt; columnSortTypes.size()) {</span>
<span class="nc" id="L1951">                columnModel.sortTypeProperty().setValue(columnSortTypes.get(i));</span>
            }

<span class="nc" id="L1954">            columns.add(columnModel);</span>
        }
<span class="nc" id="L1956">        return columns;</span>
    }

    private List&lt;MainTableColumnModel&gt; getColumnSortOrder(String sortOrderList, List&lt;MainTableColumnModel&gt; tableColumns) {
<span class="nc" id="L1960">        List&lt;MainTableColumnModel&gt; columnsOrdered = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1961">        getStringList(sortOrderList).forEach(columnName -&gt; tableColumns.stream().filter(column -&gt; column.getName().equals(columnName))</span>
<span class="nc" id="L1962">                                                                       .findFirst()</span>
<span class="nc" id="L1963">                                                                       .ifPresent(columnsOrdered::add));</span>

<span class="nc" id="L1965">        return columnsOrdered;</span>
    }

    private static List&lt;String&gt; getColumnNamesAsStringList(ColumnPreferences columnPreferences) {
<span class="nc" id="L1969">        return columnPreferences.getColumns().stream()</span>
<span class="nc" id="L1970">                                .map(MainTableColumnModel::getName)</span>
<span class="nc" id="L1971">                                .toList();</span>
    }

    private static List&lt;String&gt; getColumnWidthsAsStringList(ColumnPreferences columnPreferences) {
<span class="nc" id="L1975">        return columnPreferences.getColumns().stream()</span>
<span class="nc" id="L1976">                                .map(column -&gt; column.widthProperty().getValue().toString())</span>
<span class="nc" id="L1977">                                .toList();</span>
    }

    private static List&lt;String&gt; getColumnSortTypesAsStringList(ColumnPreferences columnPreferences) {
<span class="nc" id="L1981">        return columnPreferences.getColumns().stream()</span>
<span class="nc" id="L1982">                                .map(column -&gt; column.sortTypeProperty().getValue().toString())</span>
<span class="nc" id="L1983">                                .toList();</span>
    }

    private static List&lt;String&gt; getColumnSortOrderAsStringList(ColumnPreferences columnPreferences) {
<span class="nc" id="L1987">        return columnPreferences.getColumnSortOrder().stream()</span>
<span class="nc" id="L1988">                                .map(MainTableColumnModel::getName)</span>
<span class="nc" id="L1989">                                .collect(Collectors.toList());</span>
    }

    //*************************************************************************************************************
    // NameDisplayPreferences
    //*************************************************************************************************************

    @Override
    public NameDisplayPreferences getNameDisplayPreferences() {
<span class="nc bnc" id="L1998" title="All 2 branches missed.">        if (nameDisplayPreferences != null) {</span>
<span class="nc" id="L1999">            return nameDisplayPreferences;</span>
        }

<span class="nc" id="L2002">        nameDisplayPreferences = new NameDisplayPreferences(</span>
<span class="nc" id="L2003">                getNameDisplayStyle(),</span>
<span class="nc" id="L2004">                getNameAbbreviationStyle());</span>

<span class="nc" id="L2006">        EasyBind.listen(nameDisplayPreferences.displayStyleProperty(), (obs, oldValue, newValue) -&gt; {</span>
<span class="nc bnc" id="L2007" title="All 2 branches missed.">            putBoolean(NAMES_NATBIB, newValue == DisplayStyle.NATBIB);</span>
<span class="nc bnc" id="L2008" title="All 2 branches missed.">            putBoolean(NAMES_AS_IS, newValue == DisplayStyle.AS_IS);</span>
<span class="nc bnc" id="L2009" title="All 2 branches missed.">            putBoolean(NAMES_FIRST_LAST, newValue == DisplayStyle.FIRSTNAME_LASTNAME);</span>
<span class="nc" id="L2010">        });</span>
<span class="nc" id="L2011">        EasyBind.listen(nameDisplayPreferences.abbreviationStyleProperty(), (obs, oldValue, newValue) -&gt; {</span>
<span class="nc bnc" id="L2012" title="All 2 branches missed.">            putBoolean(ABBR_AUTHOR_NAMES, newValue == AbbreviationStyle.FULL);</span>
<span class="nc bnc" id="L2013" title="All 2 branches missed.">            putBoolean(NAMES_LAST_ONLY, newValue == AbbreviationStyle.LASTNAME_ONLY);</span>
<span class="nc" id="L2014">        });</span>

<span class="nc" id="L2016">        return nameDisplayPreferences;</span>
    }

    private AbbreviationStyle getNameAbbreviationStyle() {
<span class="nc" id="L2020">        AbbreviationStyle abbreviationStyle = AbbreviationStyle.NONE; // default</span>
<span class="nc bnc" id="L2021" title="All 2 branches missed.">        if (getBoolean(ABBR_AUTHOR_NAMES)) {</span>
<span class="nc" id="L2022">            abbreviationStyle = AbbreviationStyle.FULL;</span>
<span class="nc bnc" id="L2023" title="All 2 branches missed.">        } else if (getBoolean(NAMES_LAST_ONLY)) {</span>
<span class="nc" id="L2024">            abbreviationStyle = AbbreviationStyle.LASTNAME_ONLY;</span>
        }
<span class="nc" id="L2026">        return abbreviationStyle;</span>
    }

    private DisplayStyle getNameDisplayStyle() {
<span class="nc" id="L2030">        DisplayStyle displayStyle = DisplayStyle.LASTNAME_FIRSTNAME; // default</span>
<span class="nc bnc" id="L2031" title="All 2 branches missed.">        if (getBoolean(NAMES_NATBIB)) {</span>
<span class="nc" id="L2032">            displayStyle = DisplayStyle.NATBIB;</span>
<span class="nc bnc" id="L2033" title="All 2 branches missed.">        } else if (getBoolean(NAMES_AS_IS)) {</span>
<span class="nc" id="L2034">            displayStyle = DisplayStyle.AS_IS;</span>
<span class="nc bnc" id="L2035" title="All 2 branches missed.">        } else if (getBoolean(NAMES_FIRST_LAST)) {</span>
<span class="nc" id="L2036">            displayStyle = DisplayStyle.FIRSTNAME_LASTNAME;</span>
        }
<span class="nc" id="L2038">        return displayStyle;</span>
    }

    //*************************************************************************************************************
    // BibEntryPreferences
    //*************************************************************************************************************

    @Override
    public BibEntryPreferences getBibEntryPreferences() {
<span class="nc bnc" id="L2047" title="All 2 branches missed.">        if (bibEntryPreferences != null) {</span>
<span class="nc" id="L2048">            return bibEntryPreferences;</span>
        }

<span class="nc" id="L2051">        bibEntryPreferences = new BibEntryPreferences(</span>
<span class="nc" id="L2052">                get(KEYWORD_SEPARATOR).charAt(0)</span>
        );

<span class="nc" id="L2055">        EasyBind.listen(bibEntryPreferences.keywordSeparatorProperty(), ((observable, oldValue, newValue) -&gt; put(KEYWORD_SEPARATOR, String.valueOf(newValue))));</span>

<span class="nc" id="L2057">        return bibEntryPreferences;</span>
    }

    //*************************************************************************************************************
    // InternalPreferences
    //*************************************************************************************************************

    @Override
    public InternalPreferences getInternalPreferences() {
<span class="nc bnc" id="L2066" title="All 2 branches missed.">        if (internalPreferences != null) {</span>
<span class="nc" id="L2067">            return internalPreferences;</span>
        }

<span class="nc" id="L2070">        internalPreferences = new InternalPreferences(</span>
<span class="nc" id="L2071">                Version.parse(get(VERSION_IGNORED_UPDATE)),</span>
<span class="nc" id="L2072">                getBoolean(VERSION_CHECK_ENABLED),</span>
<span class="nc" id="L2073">                getPath(PREFS_EXPORT_PATH, OS.getNativeDesktop().getDefaultFileChooserDirectory()),</span>
<span class="nc" id="L2074">                getUserAndHost(),</span>
<span class="nc" id="L2075">                getBoolean(MEMORY_STICK_MODE));</span>

<span class="nc" id="L2077">        EasyBind.listen(internalPreferences.ignoredVersionProperty(),</span>
<span class="nc" id="L2078">                (obs, oldValue, newValue) -&gt; put(VERSION_IGNORED_UPDATE, newValue.toString()));</span>
<span class="nc" id="L2079">        EasyBind.listen(internalPreferences.versionCheckEnabledProperty(),</span>
<span class="nc" id="L2080">                (obs, oldValue, newValue) -&gt; putBoolean(VERSION_CHECK_ENABLED, newValue));</span>
<span class="nc" id="L2081">        EasyBind.listen(internalPreferences.lastPreferencesExportPathProperty(),</span>
<span class="nc" id="L2082">                (obs, oldValue, newValue) -&gt; put(PREFS_EXPORT_PATH, newValue.toString()));</span>
        // user is a static value, should only be changed for debugging
<span class="nc" id="L2084">        EasyBind.listen(internalPreferences.memoryStickModeProperty(), (obs, oldValue, newValue) -&gt; {</span>
<span class="nc" id="L2085">            putBoolean(MEMORY_STICK_MODE, newValue);</span>
<span class="nc bnc" id="L2086" title="All 2 branches missed.">            if (!newValue) {</span>
                try {
<span class="nc" id="L2088">                    Files.deleteIfExists(Path.of(&quot;jabref.xml&quot;));</span>
<span class="nc" id="L2089">                } catch (IOException e) {</span>
<span class="nc" id="L2090">                    LOGGER.warn(&quot;Error accessing filesystem&quot;);</span>
<span class="nc" id="L2091">                }</span>
            }
<span class="nc" id="L2093">        });</span>

<span class="nc" id="L2095">        return internalPreferences;</span>
    }

    private String getUserAndHost() {
<span class="nc bnc" id="L2099" title="All 2 branches missed.">        if (StringUtil.isNotBlank(userAndHost)) {</span>
<span class="nc" id="L2100">            return userAndHost;</span>
        }
<span class="nc" id="L2102">        userAndHost = get(DEFAULT_OWNER) + '-' + OS.getNativeDesktop().getHostName();</span>
<span class="nc" id="L2103">        return userAndHost;</span>
    }

    //*************************************************************************************************************
    // WorkspacePreferences
    //*************************************************************************************************************

    @Override
    public WorkspacePreferences getWorkspacePreferences() {
<span class="nc bnc" id="L2112" title="All 2 branches missed.">        if (workspacePreferences != null) {</span>
<span class="nc" id="L2113">            return workspacePreferences;</span>
        }

<span class="nc" id="L2116">        workspacePreferences = new WorkspacePreferences(</span>
<span class="nc" id="L2117">                getLanguage(),</span>
<span class="nc" id="L2118">                getBoolean(OVERRIDE_DEFAULT_FONT_SIZE),</span>
<span class="nc" id="L2119">                getInt(MAIN_FONT_SIZE),</span>
<span class="nc" id="L2120">                (Integer) defaults.get(MAIN_FONT_SIZE),</span>
<span class="nc" id="L2121">                new Theme(get(THEME)),</span>
<span class="nc" id="L2122">                getBoolean(THEME_SYNC_OS),</span>
<span class="nc" id="L2123">                getBoolean(OPEN_LAST_EDITED),</span>
<span class="nc" id="L2124">                getBoolean(SHOW_ADVANCED_HINTS),</span>
<span class="nc" id="L2125">                getBoolean(WARN_ABOUT_DUPLICATES_IN_INSPECTION),</span>
<span class="nc" id="L2126">                getBoolean(CONFIRM_DELETE));</span>

<span class="nc" id="L2128">        EasyBind.listen(workspacePreferences.languageProperty(), (obs, oldValue, newValue) -&gt; {</span>
<span class="nc" id="L2129">            put(LANGUAGE, newValue.getId());</span>
<span class="nc bnc" id="L2130" title="All 2 branches missed.">            if (oldValue != newValue) {</span>
<span class="nc" id="L2131">                setLanguageDependentDefaultValues();</span>
<span class="nc" id="L2132">                Localization.setLanguage(newValue);</span>
            }
<span class="nc" id="L2134">        });</span>
<span class="nc" id="L2135">        EasyBind.listen(workspacePreferences.shouldOverrideDefaultFontSizeProperty(), (obs, oldValue, newValue) -&gt; putBoolean(OVERRIDE_DEFAULT_FONT_SIZE, newValue));</span>
<span class="nc" id="L2136">        EasyBind.listen(workspacePreferences.mainFontSizeProperty(), (obs, oldValue, newValue) -&gt; putInt(MAIN_FONT_SIZE, newValue));</span>
<span class="nc" id="L2137">        EasyBind.listen(workspacePreferences.themeProperty(), (obs, oldValue, newValue) -&gt; put(THEME, newValue.getName()));</span>
<span class="nc" id="L2138">        EasyBind.listen(workspacePreferences.themeSyncOsProperty(), (obs, oldValue, newValue) -&gt; putBoolean(THEME_SYNC_OS, newValue));</span>
<span class="nc" id="L2139">        EasyBind.listen(workspacePreferences.openLastEditedProperty(), (obs, oldValue, newValue) -&gt; putBoolean(OPEN_LAST_EDITED, newValue));</span>
<span class="nc" id="L2140">        EasyBind.listen(workspacePreferences.showAdvancedHintsProperty(), (obs, oldValue, newValue) -&gt; putBoolean(SHOW_ADVANCED_HINTS, newValue));</span>
<span class="nc" id="L2141">        EasyBind.listen(workspacePreferences.warnAboutDuplicatesInInspectionProperty(), (obs, oldValue, newValue) -&gt; putBoolean(WARN_ABOUT_DUPLICATES_IN_INSPECTION, newValue));</span>
<span class="nc" id="L2142">        EasyBind.listen(workspacePreferences.confirmDeleteProperty(), (obs, oldValue, newValue) -&gt; putBoolean(CONFIRM_DELETE, newValue));</span>
<span class="nc" id="L2143">        return workspacePreferences;</span>
    }

    private Language getLanguage() {
<span class="nc" id="L2147">        return Stream.of(Language.values())</span>
<span class="nc" id="L2148">                     .filter(language -&gt; language.getId().equalsIgnoreCase(get(LANGUAGE)))</span>
<span class="nc" id="L2149">                     .findFirst()</span>
<span class="nc" id="L2150">                     .orElse(Language.ENGLISH);</span>
    }

    @Override
    public FieldPreferences getFieldPreferences() {
<span class="nc bnc" id="L2155" title="All 2 branches missed.">        if (fieldPreferences != null) {</span>
<span class="nc" id="L2156">            return fieldPreferences;</span>
        }

<span class="nc" id="L2159">        fieldPreferences = new FieldPreferences(</span>
<span class="nc bnc" id="L2160" title="All 2 branches missed.">                !getBoolean(DO_NOT_RESOLVE_STRINGS), // mind the !</span>
<span class="nc" id="L2161">                getStringList(RESOLVE_STRINGS_FOR_FIELDS).stream()</span>
<span class="nc" id="L2162">                                                         .map(FieldFactory::parseField)</span>
<span class="nc" id="L2163">                                                         .collect(Collectors.toList()),</span>
<span class="nc" id="L2164">                getStringList(NON_WRAPPABLE_FIELDS).stream()</span>
<span class="nc" id="L2165">                                                   .map(FieldFactory::parseField)</span>
<span class="nc" id="L2166">                                                   .collect(Collectors.toList()));</span>

<span class="nc bnc" id="L2168" title="All 2 branches missed.">        EasyBind.listen(fieldPreferences.resolveStringsProperty(), (obs, oldValue, newValue) -&gt; putBoolean(DO_NOT_RESOLVE_STRINGS, !newValue));</span>
<span class="nc" id="L2169">        fieldPreferences.getResolvableFields().addListener((InvalidationListener) change -&gt;</span>
<span class="nc" id="L2170">                put(RESOLVE_STRINGS_FOR_FIELDS, FieldFactory.serializeFieldsList(fieldPreferences.getResolvableFields())));</span>
<span class="nc" id="L2171">        fieldPreferences.getNonWrappableFields().addListener((InvalidationListener) change -&gt;</span>
<span class="nc" id="L2172">                put(NON_WRAPPABLE_FIELDS, FieldFactory.serializeFieldsList(fieldPreferences.getNonWrappableFields())));</span>

<span class="nc" id="L2174">        return fieldPreferences;</span>
    }

    //*************************************************************************************************************
    // Linked files preferences
    //*************************************************************************************************************

    @Override
    public FilePreferences getFilePreferences() {
<span class="nc bnc" id="L2183" title="All 2 branches missed.">        if (filePreferences != null) {</span>
<span class="nc" id="L2184">            return filePreferences;</span>
        }

<span class="nc" id="L2187">        filePreferences = new FilePreferences(</span>
<span class="nc" id="L2188">                getInternalPreferences().getUserAndHost(),</span>
<span class="nc" id="L2189">                getPath(MAIN_FILE_DIRECTORY, OS.getNativeDesktop().getDefaultFileChooserDirectory()).toString(),</span>
<span class="nc" id="L2190">                getBoolean(STORE_RELATIVE_TO_BIB),</span>
<span class="nc" id="L2191">                get(IMPORT_FILENAMEPATTERN),</span>
<span class="nc" id="L2192">                get(IMPORT_FILEDIRPATTERN),</span>
<span class="nc" id="L2193">                getBoolean(DOWNLOAD_LINKED_FILES),</span>
<span class="nc" id="L2194">                getBoolean(FULLTEXT_INDEX_LINKED_FILES),</span>
<span class="nc" id="L2195">                Path.of(get(WORKING_DIRECTORY)),</span>
<span class="nc" id="L2196">                ExternalFileTypes.fromString(get(EXTERNAL_FILE_TYPES)),</span>
<span class="nc" id="L2197">                getBoolean(CREATE_BACKUP),</span>
                // We choose the data directory, because a &quot;.bak&quot; file should survive cache cleanups
<span class="nc" id="L2199">                getPath(BACKUP_DIRECTORY, OS.getNativeDesktop().getBackupDirectory()));</span>

<span class="nc" id="L2201">        EasyBind.listen(filePreferences.mainFileDirectoryProperty(), (obs, oldValue, newValue) -&gt; put(MAIN_FILE_DIRECTORY, newValue));</span>
<span class="nc" id="L2202">        EasyBind.listen(filePreferences.storeFilesRelativeToBibFileProperty(), (obs, oldValue, newValue) -&gt; putBoolean(STORE_RELATIVE_TO_BIB, newValue));</span>
<span class="nc" id="L2203">        EasyBind.listen(filePreferences.fileNamePatternProperty(), (obs, oldValue, newValue) -&gt; put(IMPORT_FILENAMEPATTERN, newValue));</span>
<span class="nc" id="L2204">        EasyBind.listen(filePreferences.fileDirectoryPatternProperty(), (obs, oldValue, newValue) -&gt; put(IMPORT_FILEDIRPATTERN, newValue));</span>
<span class="nc" id="L2205">        EasyBind.listen(filePreferences.downloadLinkedFilesProperty(), (obs, oldValue, newValue) -&gt; putBoolean(DOWNLOAD_LINKED_FILES, newValue));</span>
<span class="nc" id="L2206">        EasyBind.listen(filePreferences.fulltextIndexLinkedFilesProperty(), (obs, oldValue, newValue) -&gt; putBoolean(FULLTEXT_INDEX_LINKED_FILES, newValue));</span>
<span class="nc" id="L2207">        EasyBind.listen(filePreferences.workingDirectoryProperty(), (obs, oldValue, newValue) -&gt; put(WORKING_DIRECTORY, newValue.toString()));</span>
<span class="nc" id="L2208">        filePreferences.getExternalFileTypes().addListener((SetChangeListener&lt;ExternalFileType&gt;) c -&gt;</span>
<span class="nc" id="L2209">                put(EXTERNAL_FILE_TYPES, ExternalFileTypes.toStringList(filePreferences.getExternalFileTypes())));</span>
<span class="nc" id="L2210">        EasyBind.listen(filePreferences.createBackupProperty(), (obs, oldValue, newValue) -&gt; putBoolean(CREATE_BACKUP, newValue));</span>
<span class="nc" id="L2211">        EasyBind.listen(filePreferences.backupDirectoryProperty(), (obs, oldValue, newValue) -&gt; put(BACKUP_DIRECTORY, newValue.toString()));</span>

<span class="nc" id="L2213">        return filePreferences;</span>
    }

    @Override
    public AutoLinkPreferences getAutoLinkPreferences() {
<span class="nc bnc" id="L2218" title="All 2 branches missed.">        if (autoLinkPreferences != null) {</span>
<span class="nc" id="L2219">            return autoLinkPreferences;</span>
        }

<span class="nc" id="L2222">        autoLinkPreferences = new AutoLinkPreferences(</span>
<span class="nc" id="L2223">                getAutoLinkKeyDependency(),</span>
<span class="nc" id="L2224">                get(AUTOLINK_REG_EXP_SEARCH_EXPRESSION_KEY),</span>
<span class="nc" id="L2225">                getBoolean(ASK_AUTO_NAMING_PDFS_AGAIN),</span>
<span class="nc" id="L2226">                bibEntryPreferences.keywordSeparatorProperty());</span>

<span class="nc" id="L2228">        EasyBind.listen(autoLinkPreferences.citationKeyDependencyProperty(), (obs, oldValue, newValue) -&gt; {</span>
            // Starts bibtex only omitted, as it is not being saved
<span class="nc bnc" id="L2230" title="All 2 branches missed.">            putBoolean(AUTOLINK_EXACT_KEY_ONLY, newValue == AutoLinkPreferences.CitationKeyDependency.EXACT);</span>
<span class="nc bnc" id="L2231" title="All 2 branches missed.">            putBoolean(AUTOLINK_USE_REG_EXP_SEARCH_KEY, newValue == AutoLinkPreferences.CitationKeyDependency.REGEX);</span>
<span class="nc" id="L2232">        });</span>
<span class="nc" id="L2233">        EasyBind.listen(autoLinkPreferences.askAutoNamingPdfsProperty(),</span>
<span class="nc" id="L2234">                (obs, oldValue, newValue) -&gt; putBoolean(ASK_AUTO_NAMING_PDFS_AGAIN, newValue));</span>
<span class="nc" id="L2235">        EasyBind.listen(autoLinkPreferences.regularExpressionProperty(),</span>
<span class="nc" id="L2236">                (obs, oldValue, newValue) -&gt; put(AUTOLINK_REG_EXP_SEARCH_EXPRESSION_KEY, newValue));</span>

<span class="nc" id="L2238">        return autoLinkPreferences;</span>
    }

    private AutoLinkPreferences.CitationKeyDependency getAutoLinkKeyDependency() {
<span class="nc" id="L2242">        AutoLinkPreferences.CitationKeyDependency citationKeyDependency =</span>
                AutoLinkPreferences.CitationKeyDependency.START; // default
<span class="nc bnc" id="L2244" title="All 2 branches missed.">        if (getBoolean(AUTOLINK_EXACT_KEY_ONLY)) {</span>
<span class="nc" id="L2245">            citationKeyDependency = AutoLinkPreferences.CitationKeyDependency.EXACT;</span>
<span class="nc bnc" id="L2246" title="All 2 branches missed.">        } else if (getBoolean(AUTOLINK_USE_REG_EXP_SEARCH_KEY)) {</span>
<span class="nc" id="L2247">            citationKeyDependency = AutoLinkPreferences.CitationKeyDependency.REGEX;</span>
        }
<span class="nc" id="L2249">        return citationKeyDependency;</span>
    }

    //*************************************************************************************************************
    // Import/Export preferences
    //*************************************************************************************************************

    @Override
    public ExportPreferences getExportPreferences() {
<span class="nc bnc" id="L2258" title="All 2 branches missed.">        if (exportPreferences != null) {</span>
<span class="nc" id="L2259">            return exportPreferences;</span>
        }

<span class="nc" id="L2262">        exportPreferences = new ExportPreferences(</span>
<span class="nc" id="L2263">                get(LAST_USED_EXPORT),</span>
<span class="nc" id="L2264">                Path.of(get(EXPORT_WORKING_DIRECTORY)),</span>
<span class="nc" id="L2265">                getExportSaveOrder(),</span>
<span class="nc" id="L2266">                getCustomExportFormats());</span>

<span class="nc" id="L2268">        EasyBind.listen(exportPreferences.lastExportExtensionProperty(), (obs, oldValue, newValue) -&gt; put(LAST_USED_EXPORT, newValue));</span>
<span class="nc" id="L2269">        EasyBind.listen(exportPreferences.exportWorkingDirectoryProperty(), (obs, oldValue, newValue) -&gt; put(EXPORT_WORKING_DIRECTORY, newValue.toString()));</span>
<span class="nc" id="L2270">        EasyBind.listen(exportPreferences.exportSaveOrderProperty(), (obs, oldValue, newValue) -&gt; storeExportSaveOrder(newValue));</span>
<span class="nc" id="L2271">        exportPreferences.getCustomExporters().addListener((InvalidationListener) c -&gt; storeCustomExportFormats(exportPreferences.getCustomExporters()));</span>

<span class="nc" id="L2273">        return exportPreferences;</span>
    }

    private SaveOrder getExportSaveOrder() {
<span class="nc" id="L2277">        List&lt;SaveOrder.SortCriterion&gt; sortCriteria = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L2279" title="All 2 branches missed.">        if (!&quot;&quot;.equals(get(EXPORT_PRIMARY_SORT_FIELD))) {</span>
<span class="nc" id="L2280">            sortCriteria.add(new SaveOrder.SortCriterion(FieldFactory.parseField(get(EXPORT_PRIMARY_SORT_FIELD)), getBoolean(EXPORT_PRIMARY_SORT_DESCENDING)));</span>
        }
<span class="nc bnc" id="L2282" title="All 2 branches missed.">        if (!&quot;&quot;.equals(get(EXPORT_SECONDARY_SORT_FIELD))) {</span>
<span class="nc" id="L2283">            sortCriteria.add(new SaveOrder.SortCriterion(FieldFactory.parseField(get(EXPORT_SECONDARY_SORT_FIELD)), getBoolean(EXPORT_SECONDARY_SORT_DESCENDING)));</span>
        }
<span class="nc bnc" id="L2285" title="All 2 branches missed.">        if (!&quot;&quot;.equals(get(EXPORT_TERTIARY_SORT_FIELD))) {</span>
<span class="nc" id="L2286">            sortCriteria.add(new SaveOrder.SortCriterion(FieldFactory.parseField(get(EXPORT_TERTIARY_SORT_FIELD)), getBoolean(EXPORT_TERTIARY_SORT_DESCENDING)));</span>
        }

<span class="nc" id="L2289">        return new SaveOrder(</span>
<span class="nc" id="L2290">                SaveOrder.OrderType.fromBooleans(getBoolean(EXPORT_IN_SPECIFIED_ORDER), getBoolean(EXPORT_IN_ORIGINAL_ORDER)),</span>
                sortCriteria
        );
    }

    private void storeExportSaveOrder(SaveOrder saveOrder) {
<span class="nc bnc" id="L2296" title="All 2 branches missed.">        putBoolean(EXPORT_IN_ORIGINAL_ORDER, saveOrder.getOrderType() == SaveOrder.OrderType.ORIGINAL);</span>
<span class="nc bnc" id="L2297" title="All 2 branches missed.">        putBoolean(EXPORT_IN_SPECIFIED_ORDER, saveOrder.getOrderType() == SaveOrder.OrderType.SPECIFIED);</span>

<span class="nc" id="L2299">        long saveOrderCount = saveOrder.getSortCriteria().size();</span>
<span class="nc bnc" id="L2300" title="All 2 branches missed.">        if (saveOrderCount &gt;= 1) {</span>
<span class="nc" id="L2301">            put(EXPORT_PRIMARY_SORT_FIELD, saveOrder.getSortCriteria().getFirst().field.getName());</span>
<span class="nc" id="L2302">            putBoolean(EXPORT_PRIMARY_SORT_DESCENDING, saveOrder.getSortCriteria().getFirst().descending);</span>
        } else {
<span class="nc" id="L2304">            put(EXPORT_PRIMARY_SORT_FIELD, &quot;&quot;);</span>
<span class="nc" id="L2305">            putBoolean(EXPORT_PRIMARY_SORT_DESCENDING, false);</span>
        }
<span class="nc bnc" id="L2307" title="All 2 branches missed.">        if (saveOrderCount &gt;= 2) {</span>
<span class="nc" id="L2308">            put(EXPORT_SECONDARY_SORT_FIELD, saveOrder.getSortCriteria().get(1).field.getName());</span>
<span class="nc" id="L2309">            putBoolean(EXPORT_SECONDARY_SORT_DESCENDING, saveOrder.getSortCriteria().get(1).descending);</span>
        } else {
<span class="nc" id="L2311">            put(EXPORT_SECONDARY_SORT_FIELD, &quot;&quot;);</span>
<span class="nc" id="L2312">            putBoolean(EXPORT_SECONDARY_SORT_DESCENDING, false);</span>
        }
<span class="nc bnc" id="L2314" title="All 2 branches missed.">        if (saveOrderCount &gt;= 3) {</span>
<span class="nc" id="L2315">            put(EXPORT_TERTIARY_SORT_FIELD, saveOrder.getSortCriteria().get(2).field.getName());</span>
<span class="nc" id="L2316">            putBoolean(EXPORT_TERTIARY_SORT_DESCENDING, saveOrder.getSortCriteria().get(2).descending);</span>
        } else {
<span class="nc" id="L2318">            put(EXPORT_TERTIARY_SORT_FIELD, &quot;&quot;);</span>
<span class="nc" id="L2319">            putBoolean(EXPORT_TERTIARY_SORT_DESCENDING, false);</span>
        }
<span class="nc" id="L2321">    }</span>

    /**
     * For the export configuration, generates the SelfContainedSaveOrder having the reference to TABLE resolved.
     */
    public SelfContainedSaveOrder getSelfContainedTableSaveOrder() {
<span class="nc" id="L2327">        List&lt;MainTableColumnModel&gt; sortOrder = getMainTableColumnPreferences().getColumnSortOrder();</span>
<span class="nc" id="L2328">        return new SelfContainedSaveOrder(</span>
                SaveOrder.OrderType.SPECIFIED,
<span class="nc" id="L2330">                sortOrder.stream().flatMap(model -&gt; model.getSortCriteria().stream()).toList());</span>
    }

    @Override
    public SelfContainedSaveConfiguration getSelfContainedExportConfiguration() {
<span class="nc" id="L2335">        SaveOrder exportSaveOrder = getExportSaveOrder();</span>
<span class="nc bnc" id="L2336" title="All 4 branches missed.">        SelfContainedSaveOrder saveOrder = switch (exportSaveOrder.getOrderType()) {</span>
            case TABLE -&gt;
<span class="nc" id="L2338">                    this.getSelfContainedTableSaveOrder();</span>
            case SPECIFIED -&gt;
<span class="nc" id="L2340">                    SelfContainedSaveOrder.of(exportSaveOrder);</span>
            case ORIGINAL -&gt;
<span class="nc" id="L2342">                    SaveOrder.getDefaultSaveOrder();</span>
        };

<span class="nc" id="L2345">        return new SelfContainedSaveConfiguration(</span>
<span class="nc" id="L2346">                saveOrder, false, BibDatabaseWriter.SaveType.WITH_JABREF_META_DATA, getLibraryPreferences()</span>
<span class="nc" id="L2347">                .shouldAlwaysReformatOnSave());</span>
    }

    private List&lt;TemplateExporter&gt; getCustomExportFormats() {
<span class="nc" id="L2351">        LayoutFormatterPreferences layoutPreferences = getLayoutFormatterPreferences();</span>
<span class="nc" id="L2352">        SelfContainedSaveConfiguration saveConfiguration = getSelfContainedExportConfiguration();</span>
<span class="nc" id="L2353">        List&lt;TemplateExporter&gt; formats = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L2355" title="All 2 branches missed.">        for (String toImport : getSeries(CUSTOM_EXPORT_FORMAT)) {</span>
<span class="nc" id="L2356">            List&lt;String&gt; formatData = convertStringToList(toImport);</span>
<span class="nc" id="L2357">            TemplateExporter format = new TemplateExporter(</span>
<span class="nc" id="L2358">                    formatData.getFirst(),</span>
<span class="nc" id="L2359">                    formatData.get(EXPORTER_FILENAME_INDEX),</span>
<span class="nc" id="L2360">                    formatData.get(EXPORTER_EXTENSION_INDEX),</span>
                    layoutPreferences,
<span class="nc" id="L2362">                    saveConfiguration.getSelfContainedSaveOrder());</span>
<span class="nc" id="L2363">            format.setCustomExport(true);</span>
<span class="nc" id="L2364">            formats.add(format);</span>
<span class="nc" id="L2365">        }</span>
<span class="nc" id="L2366">        return formats;</span>
    }

    private void storeCustomExportFormats(List&lt;TemplateExporter&gt; exporters) {
<span class="nc bnc" id="L2370" title="All 2 branches missed.">        if (exporters.isEmpty()) {</span>
<span class="nc" id="L2371">            purgeSeries(CUSTOM_EXPORT_FORMAT, 0);</span>
        } else {
<span class="nc bnc" id="L2373" title="All 2 branches missed.">            for (int i = 0; i &lt; exporters.size(); i++) {</span>
<span class="nc" id="L2374">                List&lt;String&gt; exporterData = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2375">                exporterData.addFirst(exporters.get(i).getName());</span>
<span class="nc" id="L2376">                exporterData.add(EXPORTER_FILENAME_INDEX, exporters.get(i).getLayoutFileName());</span>
                // Only stores the first extension associated with FileType
<span class="nc" id="L2378">                exporterData.add(EXPORTER_EXTENSION_INDEX, exporters.get(i).getFileType().getExtensions().getFirst());</span>
<span class="nc" id="L2379">                putStringList(CUSTOM_EXPORT_FORMAT + i, exporterData);</span>
            }
<span class="nc" id="L2381">            purgeSeries(CUSTOM_EXPORT_FORMAT, exporters.size());</span>
        }
<span class="nc" id="L2383">    }</span>

    //*************************************************************************************************************
    // Preview preferences
    //*************************************************************************************************************

    @Override
    public PreviewPreferences getPreviewPreferences() {
<span class="nc bnc" id="L2391" title="All 2 branches missed.">        if (previewPreferences != null) {</span>
<span class="nc" id="L2392">            return previewPreferences;</span>
        }

<span class="nc" id="L2395">        String style = get(PREVIEW_STYLE);</span>
<span class="nc" id="L2396">        List&lt;PreviewLayout&gt; layouts = getPreviewLayouts(style);</span>

<span class="nc" id="L2398">        this.previewPreferences = new PreviewPreferences(</span>
                layouts,
<span class="nc" id="L2400">                getPreviewCyclePosition(layouts),</span>
<span class="nc" id="L2401">                new TextBasedPreviewLayout(style, getLayoutFormatterPreferences(), Globals.journalAbbreviationRepository),</span>
<span class="nc" id="L2402">                (String) defaults.get(PREVIEW_STYLE),</span>
<span class="nc" id="L2403">                getBoolean(PREVIEW_AS_TAB));</span>

<span class="nc" id="L2405">        previewPreferences.getLayoutCycle().addListener((InvalidationListener) c -&gt; storePreviewLayouts(previewPreferences.getLayoutCycle()));</span>
<span class="nc" id="L2406">        EasyBind.listen(previewPreferences.layoutCyclePositionProperty(), (obs, oldValue, newValue) -&gt; putInt(CYCLE_PREVIEW_POS, newValue));</span>
<span class="nc" id="L2407">        EasyBind.listen(previewPreferences.customPreviewLayoutProperty(), (obs, oldValue, newValue) -&gt; put(PREVIEW_STYLE, newValue.getText()));</span>
<span class="nc" id="L2408">        EasyBind.listen(previewPreferences.showPreviewAsExtraTabProperty(), (obs, oldValue, newValue) -&gt; putBoolean(PREVIEW_AS_TAB, newValue));</span>

<span class="nc" id="L2410">        return this.previewPreferences;</span>
    }

    private List&lt;PreviewLayout&gt; getPreviewLayouts(String style) {
<span class="nc" id="L2414">        List&lt;String&gt; cycle = getStringList(CYCLE_PREVIEW);</span>

        // For backwards compatibility always add at least the default preview to the cycle
<span class="nc bnc" id="L2417" title="All 2 branches missed.">        if (cycle.isEmpty()) {</span>
<span class="nc" id="L2418">            cycle.add(&quot;Preview&quot;);</span>
        }

<span class="nc" id="L2421">        return cycle.stream()</span>
<span class="nc" id="L2422">                    .map(layout -&gt; {</span>
<span class="nc bnc" id="L2423" title="All 2 branches missed.">                        if (CitationStyle.isCitationStyleFile(layout)) {</span>
<span class="nc" id="L2424">                            return CitationStyle.createCitationStyleFromFile(layout)</span>
<span class="nc" id="L2425">                                                .map(file -&gt; (PreviewLayout) new CitationStylePreviewLayout(file, Globals.entryTypesManager))</span>
<span class="nc" id="L2426">                                                .orElse(null);</span>
                        } else {
<span class="nc" id="L2428">                            return new TextBasedPreviewLayout(style, getLayoutFormatterPreferences(), Globals.journalAbbreviationRepository);</span>
                        }
                    })
<span class="nc" id="L2431">                    .filter(Objects::nonNull)</span>
<span class="nc" id="L2432">                    .collect(Collectors.toList());</span>
    }

    private void storePreviewLayouts(ObservableList&lt;PreviewLayout&gt; previewCycle) {
<span class="nc" id="L2436">        putStringList(CYCLE_PREVIEW, previewCycle.stream()</span>
<span class="nc" id="L2437">                                                 .map(layout -&gt; {</span>
<span class="nc bnc" id="L2438" title="All 2 branches missed.">                                                     if (layout instanceof CitationStylePreviewLayout citationStyleLayout) {</span>
<span class="nc" id="L2439">                                                         return citationStyleLayout.getFilePath();</span>
                                                     } else {
<span class="nc" id="L2441">                                                         return layout.getDisplayName();</span>
                                                     }
<span class="nc" id="L2443">                                                 }).collect(Collectors.toList())</span>
        );
<span class="nc" id="L2445">    }</span>

    private int getPreviewCyclePosition(List&lt;PreviewLayout&gt; layouts) {
<span class="nc" id="L2448">        int storedCyclePos = getInt(CYCLE_PREVIEW_POS);</span>
<span class="nc bnc" id="L2449" title="All 2 branches missed.">        if (storedCyclePos &lt; layouts.size()) {</span>
<span class="nc" id="L2450">            return storedCyclePos;</span>
        } else {
<span class="nc" id="L2452">            return 0; // fallback if stored position is no longer valid</span>
        }
    }

    //*************************************************************************************************************
    // SidePanePreferences
    //*************************************************************************************************************

    @Override
    public SidePanePreferences getSidePanePreferences() {
<span class="nc bnc" id="L2462" title="All 2 branches missed.">        if (sidePanePreferences != null) {</span>
<span class="nc" id="L2463">            return sidePanePreferences;</span>
        }

<span class="nc" id="L2466">        sidePanePreferences = new SidePanePreferences(</span>
<span class="nc" id="L2467">                getVisibleSidePanes(),</span>
<span class="nc" id="L2468">                getSidePanePreferredPositions(),</span>
<span class="nc" id="L2469">                getInt(SELECTED_FETCHER_INDEX));</span>

<span class="nc" id="L2471">        sidePanePreferences.visiblePanes().addListener((InvalidationListener) listener -&gt;</span>
<span class="nc" id="L2472">                storeVisibleSidePanes(sidePanePreferences.visiblePanes()));</span>
<span class="nc" id="L2473">        sidePanePreferences.getPreferredPositions().addListener((InvalidationListener) listener -&gt;</span>
<span class="nc" id="L2474">                storeSidePanePreferredPositions(sidePanePreferences.getPreferredPositions()));</span>
<span class="nc" id="L2475">        EasyBind.listen(sidePanePreferences.webSearchFetcherSelectedProperty(), (obs, oldValue, newValue) -&gt; putInt(SELECTED_FETCHER_INDEX, newValue));</span>

<span class="nc" id="L2477">        return sidePanePreferences;</span>
    }

    private Set&lt;SidePaneType&gt; getVisibleSidePanes() {
<span class="nc" id="L2481">        HashSet&lt;SidePaneType&gt; visiblePanes = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L2482" title="All 2 branches missed.">        if (getBoolean(WEB_SEARCH_VISIBLE)) {</span>
<span class="nc" id="L2483">            visiblePanes.add(SidePaneType.WEB_SEARCH);</span>
        }
<span class="nc bnc" id="L2485" title="All 2 branches missed.">        if (getBoolean(GROUP_SIDEPANE_VISIBLE)) {</span>
<span class="nc" id="L2486">            visiblePanes.add(SidePaneType.GROUPS);</span>
        }
<span class="nc bnc" id="L2488" title="All 2 branches missed.">        if (getBoolean(OO_SHOW_PANEL)) {</span>
<span class="nc" id="L2489">            visiblePanes.add(SidePaneType.OPEN_OFFICE);</span>
        }
<span class="nc" id="L2491">        return visiblePanes;</span>
    }

    private void storeVisibleSidePanes(Set&lt;SidePaneType&gt; visiblePanes) {
<span class="nc" id="L2495">        putBoolean(WEB_SEARCH_VISIBLE, visiblePanes.contains(SidePaneType.WEB_SEARCH));</span>
<span class="nc" id="L2496">        putBoolean(GROUP_SIDEPANE_VISIBLE, visiblePanes.contains(SidePaneType.GROUPS));</span>
<span class="nc" id="L2497">        putBoolean(OO_SHOW_PANEL, visiblePanes.contains(SidePaneType.OPEN_OFFICE));</span>
<span class="nc" id="L2498">    }</span>

    private Map&lt;SidePaneType, Integer&gt; getSidePanePreferredPositions() {
<span class="nc" id="L2501">        Map&lt;SidePaneType, Integer&gt; preferredPositions = new HashMap&lt;&gt;();</span>

<span class="nc" id="L2503">        List&lt;String&gt; componentNames = getStringList(SIDE_PANE_COMPONENT_NAMES);</span>
<span class="nc" id="L2504">        List&lt;String&gt; componentPositions = getStringList(SIDE_PANE_COMPONENT_PREFERRED_POSITIONS);</span>

<span class="nc bnc" id="L2506" title="All 2 branches missed.">        for (int i = 0; i &lt; componentNames.size(); ++i) {</span>
<span class="nc" id="L2507">            String name = componentNames.get(i);</span>
            try {
<span class="nc" id="L2509">                SidePaneType type = Enum.valueOf(SidePaneType.class, name);</span>
<span class="nc" id="L2510">                preferredPositions.put(type, Integer.parseInt(componentPositions.get(i)));</span>
<span class="nc" id="L2511">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L2512">                LOGGER.debug(&quot;Invalid number format for side pane component '&quot; + name + &quot;'&quot;, e);</span>
<span class="nc" id="L2513">            } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L2514">                LOGGER.debug(&quot;Following component is not a side pane: '&quot; + name + &quot;'&quot;, e);</span>
<span class="nc" id="L2515">            }</span>
        }

<span class="nc" id="L2518">        return preferredPositions;</span>
    }

    private void storeSidePanePreferredPositions(Map&lt;SidePaneType, Integer&gt; preferredPositions) {
        // Split the map into a pair of parallel String lists suitable for storage
<span class="nc" id="L2523">        List&lt;String&gt; names = preferredPositions.keySet().stream()</span>
<span class="nc" id="L2524">                                               .map(Enum::toString)</span>
<span class="nc" id="L2525">                                               .collect(Collectors.toList());</span>

<span class="nc" id="L2527">        List&lt;String&gt; positions = preferredPositions.values().stream()</span>
<span class="nc" id="L2528">                                                   .map(integer -&gt; Integer.toString(integer))</span>
<span class="nc" id="L2529">                                                   .collect(Collectors.toList());</span>

<span class="nc" id="L2531">        putStringList(SIDE_PANE_COMPONENT_NAMES, names);</span>
<span class="nc" id="L2532">        putStringList(SIDE_PANE_COMPONENT_PREFERRED_POSITIONS, positions);</span>
<span class="nc" id="L2533">    }</span>

    //*************************************************************************************************************
    // Cleanup preferences
    //*************************************************************************************************************

    @Override
    public CleanupPreferences getCleanupPreferences() {
<span class="nc bnc" id="L2541" title="All 2 branches missed.">        if (cleanupPreferences != null) {</span>
<span class="nc" id="L2542">            return cleanupPreferences;</span>
        }

<span class="nc" id="L2545">        cleanupPreferences = new CleanupPreferences(</span>
<span class="nc" id="L2546">                EnumSet.copyOf(getStringList(CLEANUP_JOBS).stream()</span>
<span class="nc" id="L2547">                                                          .map(CleanupPreferences.CleanupStep::valueOf)</span>
<span class="nc" id="L2548">                                                          .collect(Collectors.toSet())),</span>
<span class="nc" id="L2549">                new FieldFormatterCleanups(getBoolean(CLEANUP_FIELD_FORMATTERS_ENABLED),</span>
<span class="nc" id="L2550">                        FieldFormatterCleanups.parse(StringUtil.unifyLineBreaks(get(CLEANUP_FIELD_FORMATTERS), &quot;&quot;))));</span>

<span class="nc" id="L2552">        cleanupPreferences.getObservableActiveJobs().addListener((SetChangeListener&lt;CleanupPreferences.CleanupStep&gt;) c -&gt;</span>
<span class="nc" id="L2553">                putStringList(CLEANUP_JOBS, cleanupPreferences.getActiveJobs().stream().map(Enum::name).collect(Collectors.toList())));</span>

<span class="nc" id="L2555">        EasyBind.listen(cleanupPreferences.fieldFormatterCleanupsProperty(), (fieldFormatters, oldValue, newValue) -&gt; {</span>
<span class="nc" id="L2556">            putBoolean(CLEANUP_FIELD_FORMATTERS_ENABLED, newValue.isEnabled());</span>
<span class="nc" id="L2557">            put(CLEANUP_FIELD_FORMATTERS, FieldFormatterCleanups.getMetaDataString(newValue.getConfiguredActions(), OS.NEWLINE));</span>
<span class="nc" id="L2558">        });</span>

<span class="nc" id="L2560">        return cleanupPreferences;</span>
    }

    @Override
    public CleanupPreferences getDefaultCleanupPreset() {
<span class="nc" id="L2565">        return new CleanupPreferences(</span>
<span class="nc" id="L2566">                getDefaultCleanupJobs(),</span>
                new FieldFormatterCleanups(
<span class="nc" id="L2568">                        (Boolean) defaults.get(CLEANUP_FIELD_FORMATTERS_ENABLED),</span>
<span class="nc" id="L2569">                        FieldFormatterCleanups.parse((String) defaults.get(CLEANUP_FIELD_FORMATTERS))));</span>
    }

    private static EnumSet&lt;CleanupPreferences.CleanupStep&gt; getDefaultCleanupJobs() {
<span class="nc" id="L2573">        EnumSet&lt;CleanupPreferences.CleanupStep&gt; activeJobs = EnumSet.allOf(CleanupPreferences.CleanupStep.class);</span>
<span class="nc" id="L2574">        activeJobs.removeAll(EnumSet.of(</span>
                CleanupPreferences.CleanupStep.CLEAN_UP_UPGRADE_EXTERNAL_LINKS,
                CleanupPreferences.CleanupStep.MOVE_PDF,
                CleanupPreferences.CleanupStep.RENAME_PDF_ONLY_RELATIVE_PATHS,
                CleanupPreferences.CleanupStep.CONVERT_TO_BIBLATEX,
                CleanupPreferences.CleanupStep.CONVERT_TO_BIBTEX));
<span class="nc" id="L2580">        return activeJobs;</span>
    }

    //*************************************************************************************************************
    // GUI preferences
    //*************************************************************************************************************

    @Override
    public GuiPreferences getGuiPreferences() {
<span class="nc bnc" id="L2589" title="All 2 branches missed.">        if (guiPreferences != null) {</span>
<span class="nc" id="L2590">            return guiPreferences;</span>
        }

<span class="nc" id="L2593">        guiPreferences = new GuiPreferences(</span>
<span class="nc" id="L2594">                getDouble(POS_X),</span>
<span class="nc" id="L2595">                getDouble(POS_Y),</span>
<span class="nc" id="L2596">                getDouble(SIZE_X),</span>
<span class="nc" id="L2597">                getDouble(SIZE_Y),</span>
<span class="nc" id="L2598">                getBoolean(WINDOW_MAXIMISED),</span>
<span class="nc" id="L2599">                getBoolean(WINDOW_FULLSCREEN),</span>
<span class="nc" id="L2600">                getStringList(LAST_EDITED).stream()</span>
<span class="nc" id="L2601">                                          .map(Path::of)</span>
<span class="nc" id="L2602">                                          .collect(Collectors.toList()),</span>
<span class="nc" id="L2603">                Path.of(get(LAST_FOCUSED)),</span>
<span class="nc" id="L2604">                getFileHistory(),</span>
<span class="nc" id="L2605">                get(ID_ENTRY_GENERATOR),</span>
<span class="nc" id="L2606">                getDouble(SIDE_PANE_WIDTH));</span>

<span class="nc" id="L2608">        EasyBind.listen(guiPreferences.positionXProperty(), (obs, oldValue, newValue) -&gt; putDouble(POS_X, newValue.doubleValue()));</span>
<span class="nc" id="L2609">        EasyBind.listen(guiPreferences.positionYProperty(), (obs, oldValue, newValue) -&gt; putDouble(POS_Y, newValue.doubleValue()));</span>
<span class="nc" id="L2610">        EasyBind.listen(guiPreferences.sizeXProperty(), (obs, oldValue, newValue) -&gt; putDouble(SIZE_X, newValue.doubleValue()));</span>
<span class="nc" id="L2611">        EasyBind.listen(guiPreferences.sizeYProperty(), (obs, oldValue, newValue) -&gt; putDouble(SIZE_Y, newValue.doubleValue()));</span>
<span class="nc" id="L2612">        EasyBind.listen(guiPreferences.windowMaximisedProperty(), (obs, oldValue, newValue) -&gt; putBoolean(WINDOW_MAXIMISED, newValue));</span>
<span class="nc" id="L2613">        EasyBind.listen(guiPreferences.windowFullScreenProperty(), (obs, oldValue, newValue) -&gt; putBoolean(WINDOW_FULLSCREEN, newValue));</span>
<span class="nc" id="L2614">        guiPreferences.getLastFilesOpened().addListener((ListChangeListener&lt;Path&gt;) change -&gt; {</span>
<span class="nc bnc" id="L2615" title="All 2 branches missed.">            if (change.getList().isEmpty()) {</span>
<span class="nc" id="L2616">                prefs.remove(LAST_EDITED);</span>
            } else {
<span class="nc" id="L2618">                putStringList(LAST_EDITED, guiPreferences.getLastFilesOpened().stream()</span>
<span class="nc" id="L2619">                                                         .map(Path::toAbsolutePath)</span>
<span class="nc" id="L2620">                                                         .map(Path::toString)</span>
<span class="nc" id="L2621">                                                         .collect(Collectors.toList()));</span>
            }
<span class="nc" id="L2623">        });</span>
<span class="nc" id="L2624">        EasyBind.listen(guiPreferences.lastFocusedFileProperty(), (obs, oldValue, newValue) -&gt; {</span>
<span class="nc bnc" id="L2625" title="All 2 branches missed.">            if (newValue != null) {</span>
<span class="nc" id="L2626">                put(LAST_FOCUSED, newValue.toAbsolutePath().toString());</span>
            } else {
<span class="nc" id="L2628">                remove(LAST_FOCUSED);</span>
            }
<span class="nc" id="L2630">        });</span>
<span class="nc" id="L2631">        guiPreferences.getFileHistory().addListener((InvalidationListener) change -&gt; storeFileHistory(guiPreferences.getFileHistory()));</span>
<span class="nc" id="L2632">        EasyBind.listen(guiPreferences.lastSelectedIdBasedFetcherProperty(), (obs, oldValue, newValue) -&gt; put(ID_ENTRY_GENERATOR, newValue));</span>
<span class="nc" id="L2633">        EasyBind.listen(guiPreferences.sidePaneWidthProperty(), (obs, oldValue, newValue) -&gt; putDouble(SIDE_PANE_WIDTH, newValue.doubleValue()));</span>

<span class="nc" id="L2635">        return guiPreferences;</span>
    }

    private FileHistory getFileHistory() {
<span class="nc" id="L2639">        return FileHistory.of(getStringList(RECENT_DATABASES).stream()</span>
<span class="nc" id="L2640">                                                             .map(Path::of)</span>
<span class="nc" id="L2641">                                                             .toList());</span>
    }

    private void storeFileHistory(FileHistory history) {
<span class="nc" id="L2645">        putStringList(RECENT_DATABASES, history.stream()</span>
<span class="nc" id="L2646">                                               .map(Path::toAbsolutePath)</span>
<span class="nc" id="L2647">                                               .map(Path::toString)</span>
<span class="nc" id="L2648">                                               .toList());</span>
<span class="nc" id="L2649">    }</span>

    @Override
    public MergeDialogPreferences getMergeDialogPreferences() {
<span class="nc bnc" id="L2653" title="All 2 branches missed.">        if (mergeDialogPreferences != null) {</span>
<span class="nc" id="L2654">            return mergeDialogPreferences;</span>
        }

<span class="nc" id="L2657">        mergeDialogPreferences = new MergeDialogPreferences(</span>
<span class="nc" id="L2658">                DiffMode.parse(get(MERGE_ENTRIES_DIFF_MODE)),</span>
<span class="nc" id="L2659">                getBoolean(MERGE_ENTRIES_SHOULD_SHOW_DIFF),</span>
<span class="nc" id="L2660">                getBoolean(MERGE_ENTRIES_SHOULD_SHOW_UNIFIED_DIFF),</span>
<span class="nc" id="L2661">                getBoolean(MERGE_ENTRIES_HIGHLIGHT_WORDS),</span>
<span class="nc" id="L2662">                getBoolean(MERGE_SHOW_ONLY_CHANGED_FIELDS),</span>
<span class="nc" id="L2663">                getBoolean(MERGE_APPLY_TO_ALL_ENTRIES),</span>
<span class="nc" id="L2664">                DuplicateResolverDialog.DuplicateResolverResult.parse(get(DUPLICATE_RESOLVER_DECISION_RESULT_ALL_ENTRIES))</span>
        );

<span class="nc" id="L2667">        EasyBind.listen(mergeDialogPreferences.mergeDiffModeProperty(), (obs, oldValue, newValue) -&gt; put(MERGE_ENTRIES_DIFF_MODE, newValue.name()));</span>
<span class="nc" id="L2668">        EasyBind.listen(mergeDialogPreferences.mergeShouldShowDiffProperty(), (obs, oldValue, newValue) -&gt; putBoolean(MERGE_ENTRIES_SHOULD_SHOW_DIFF, newValue));</span>
<span class="nc" id="L2669">        EasyBind.listen(mergeDialogPreferences.mergeShouldShowUnifiedDiffProperty(), (obs, oldValue, newValue) -&gt; putBoolean(MERGE_ENTRIES_SHOULD_SHOW_UNIFIED_DIFF, newValue));</span>
<span class="nc" id="L2670">        EasyBind.listen(mergeDialogPreferences.mergeHighlightWordsProperty(), (obs, oldValue, newValue) -&gt; putBoolean(MERGE_ENTRIES_HIGHLIGHT_WORDS, newValue));</span>
<span class="nc" id="L2671">        EasyBind.listen(mergeDialogPreferences.mergeShowChangedFieldOnlyProperty(), (obs, oldValue, newValue) -&gt; putBoolean(MERGE_SHOW_ONLY_CHANGED_FIELDS, newValue));</span>
<span class="nc" id="L2672">        EasyBind.listen(mergeDialogPreferences.mergeApplyToAllEntriesProperty(), (obs, oldValue, newValue) -&gt; putBoolean(MERGE_APPLY_TO_ALL_ENTRIES, newValue));</span>
<span class="nc" id="L2673">        EasyBind.listen(mergeDialogPreferences.allEntriesDuplicateResolverDecisionProperty(), (obs, oldValue, newValue) -&gt; put(DUPLICATE_RESOLVER_DECISION_RESULT_ALL_ENTRIES, newValue.name()));</span>

<span class="nc" id="L2675">        return mergeDialogPreferences;</span>
    }

    //*************************************************************************************************************
    // Misc preferences
    //*************************************************************************************************************

    @Override
    public SearchPreferences getSearchPreferences() {
<span class="nc bnc" id="L2684" title="All 2 branches missed.">        if (searchPreferences != null) {</span>
<span class="nc" id="L2685">            return searchPreferences;</span>
        }

        SearchDisplayMode searchDisplayMode;
        try {
<span class="nc" id="L2690">            searchDisplayMode = SearchDisplayMode.valueOf(get(SEARCH_DISPLAY_MODE));</span>
<span class="nc" id="L2691">        } catch (IllegalArgumentException ex) {</span>
            // Should only occur when the searchmode is set directly via preferences.put and the enum was not used
<span class="nc" id="L2693">            searchDisplayMode = SearchDisplayMode.valueOf((String) defaults.get(SEARCH_DISPLAY_MODE));</span>
<span class="nc" id="L2694">        }</span>

<span class="nc" id="L2696">        searchPreferences = new SearchPreferences(</span>
                searchDisplayMode,
<span class="nc" id="L2698">                getBoolean(SEARCH_CASE_SENSITIVE),</span>
<span class="nc" id="L2699">                getBoolean(SEARCH_REG_EXP),</span>
<span class="nc" id="L2700">                getBoolean(SEARCH_FULLTEXT),</span>
<span class="nc" id="L2701">                getBoolean(SEARCH_KEEP_SEARCH_STRING),</span>
<span class="nc" id="L2702">                getBoolean(SEARCH_KEEP_GLOBAL_WINDOW_ON_TOP),</span>
<span class="nc" id="L2703">                getDouble(SEARCH_WINDOW_HEIGHT),</span>
<span class="nc" id="L2704">                getDouble(SEARCH_WINDOW_WIDTH));</span>

<span class="nc" id="L2706">        EasyBind.listen(searchPreferences.searchDisplayModeProperty(), (obs, oldValue, newValue) -&gt; put(SEARCH_DISPLAY_MODE, Objects.requireNonNull(searchPreferences.getSearchDisplayMode()).toString()));</span>
<span class="nc" id="L2707">        searchPreferences.getObservableSearchFlags().addListener((SetChangeListener&lt;SearchRules.SearchFlags&gt;) c -&gt; {</span>
<span class="nc" id="L2708">            putBoolean(SEARCH_CASE_SENSITIVE, searchPreferences.getObservableSearchFlags().contains(SearchRules.SearchFlags.CASE_SENSITIVE));</span>
<span class="nc" id="L2709">            putBoolean(SEARCH_REG_EXP, searchPreferences.getObservableSearchFlags().contains(SearchRules.SearchFlags.REGULAR_EXPRESSION));</span>
<span class="nc" id="L2710">            putBoolean(SEARCH_FULLTEXT, searchPreferences.getObservableSearchFlags().contains(SearchRules.SearchFlags.FULLTEXT));</span>
<span class="nc" id="L2711">            putBoolean(SEARCH_KEEP_SEARCH_STRING, searchPreferences.getObservableSearchFlags().contains(SearchRules.SearchFlags.KEEP_SEARCH_STRING));</span>
<span class="nc" id="L2712">        });</span>
<span class="nc" id="L2713">        EasyBind.listen(searchPreferences.keepWindowOnTopProperty(), (obs, oldValue, newValue) -&gt; putBoolean(SEARCH_KEEP_GLOBAL_WINDOW_ON_TOP, searchPreferences.shouldKeepWindowOnTop()));</span>
<span class="nc" id="L2714">        EasyBind.listen(searchPreferences.getSearchWindowHeightProperty(), (obs, oldValue, newValue) -&gt; putDouble(SEARCH_WINDOW_HEIGHT, searchPreferences.getSearchWindowHeight()));</span>
<span class="nc" id="L2715">        EasyBind.listen(searchPreferences.getSearchWindowWidthProperty(), (obs, oldValue, newValue) -&gt; putDouble(SEARCH_WINDOW_WIDTH, searchPreferences.getSearchWindowWidth()));</span>

<span class="nc" id="L2717">        return searchPreferences;</span>
    }

    @Override
    public XmpPreferences getXmpPreferences() {
<span class="nc bnc" id="L2722" title="All 2 branches missed.">        if (xmpPreferences != null) {</span>
<span class="nc" id="L2723">            return xmpPreferences;</span>
        }

<span class="nc" id="L2726">        xmpPreferences = new XmpPreferences(</span>
<span class="nc" id="L2727">                getBoolean(USE_XMP_PRIVACY_FILTER),</span>
<span class="nc" id="L2728">                getStringList(XMP_PRIVACY_FILTERS).stream().map(FieldFactory::parseField).collect(Collectors.toSet()),</span>
<span class="nc" id="L2729">                getBibEntryPreferences().keywordSeparatorProperty());</span>

<span class="nc" id="L2731">        EasyBind.listen(xmpPreferences.useXmpPrivacyFilterProperty(),</span>
<span class="nc" id="L2732">                (obs, oldValue, newValue) -&gt; putBoolean(USE_XMP_PRIVACY_FILTER, newValue));</span>
<span class="nc" id="L2733">        xmpPreferences.getXmpPrivacyFilter().addListener((SetChangeListener&lt;Field&gt;) c -&gt;</span>
<span class="nc" id="L2734">                putStringList(XMP_PRIVACY_FILTERS, xmpPreferences.getXmpPrivacyFilter().stream()</span>
<span class="nc" id="L2735">                                                                 .map(Field::getName)</span>
<span class="nc" id="L2736">                                                                 .collect(Collectors.toList())));</span>

<span class="nc" id="L2738">        return xmpPreferences;</span>
    }

    @Override
    public NameFormatterPreferences getNameFormatterPreferences() {
<span class="nc bnc" id="L2743" title="All 2 branches missed.">        if (nameFormatterPreferences != null) {</span>
<span class="nc" id="L2744">            return nameFormatterPreferences;</span>
        }

<span class="nc" id="L2747">        nameFormatterPreferences = new NameFormatterPreferences(</span>
<span class="nc" id="L2748">                getStringList(NAME_FORMATER_KEY),</span>
<span class="nc" id="L2749">                getStringList(NAME_FORMATTER_VALUE));</span>

<span class="nc" id="L2751">        nameFormatterPreferences.getNameFormatterKey().addListener((InvalidationListener) change -&gt;</span>
<span class="nc" id="L2752">                putStringList(NAME_FORMATER_KEY, nameFormatterPreferences.getNameFormatterKey()));</span>
<span class="nc" id="L2753">        nameFormatterPreferences.getNameFormatterValue().addListener((InvalidationListener) change -&gt;</span>
<span class="nc" id="L2754">                putStringList(NAME_FORMATTER_VALUE, nameFormatterPreferences.getNameFormatterValue()));</span>

<span class="nc" id="L2756">        return nameFormatterPreferences;</span>
    }

    @Override
    public AutoCompletePreferences getAutoCompletePreferences() {
<span class="nc bnc" id="L2761" title="All 2 branches missed.">        if (autoCompletePreferences != null) {</span>
<span class="nc" id="L2762">            return autoCompletePreferences;</span>
        }

<span class="nc" id="L2765">        AutoCompletePreferences.NameFormat nameFormat = AutoCompletePreferences.NameFormat.BOTH;</span>
<span class="nc bnc" id="L2766" title="All 2 branches missed.">        if (getBoolean(AUTOCOMPLETER_LAST_FIRST)) {</span>
<span class="nc" id="L2767">            nameFormat = AutoCompletePreferences.NameFormat.LAST_FIRST;</span>
<span class="nc bnc" id="L2768" title="All 2 branches missed.">        } else if (getBoolean(AUTOCOMPLETER_FIRST_LAST)) {</span>
<span class="nc" id="L2769">            nameFormat = AutoCompletePreferences.NameFormat.FIRST_LAST;</span>
        }

<span class="nc" id="L2772">        autoCompletePreferences = new AutoCompletePreferences(</span>
<span class="nc" id="L2773">                getBoolean(AUTO_COMPLETE),</span>
<span class="nc" id="L2774">                AutoCompleteFirstNameMode.parse(get(AUTOCOMPLETER_FIRSTNAME_MODE)),</span>
                nameFormat,
<span class="nc" id="L2776">                getStringList(AUTOCOMPLETER_COMPLETE_FIELDS).stream().map(FieldFactory::parseField).collect(Collectors.toSet())</span>
        );

<span class="nc" id="L2779">        EasyBind.listen(autoCompletePreferences.autoCompleteProperty(), (obs, oldValue, newValue) -&gt; putBoolean(AUTO_COMPLETE, newValue));</span>
<span class="nc" id="L2780">        EasyBind.listen(autoCompletePreferences.firstNameModeProperty(), (obs, oldValue, newValue) -&gt; put(AUTOCOMPLETER_FIRSTNAME_MODE, newValue.name()));</span>
<span class="nc" id="L2781">        autoCompletePreferences.getCompleteFields().addListener((SetChangeListener&lt;Field&gt;) c -&gt;</span>
<span class="nc" id="L2782">                putStringList(AUTOCOMPLETER_COMPLETE_FIELDS, autoCompletePreferences.getCompleteFields().stream()</span>
<span class="nc" id="L2783">                                                                                    .map(Field::getName)</span>
<span class="nc" id="L2784">                                                                                    .collect(Collectors.toList())));</span>
<span class="nc" id="L2785">        EasyBind.listen(autoCompletePreferences.nameFormatProperty(), (obs, oldValue, newValue) -&gt; {</span>
<span class="nc bnc" id="L2786" title="All 2 branches missed.">            if (autoCompletePreferences.getNameFormat() == AutoCompletePreferences.NameFormat.BOTH) {</span>
<span class="nc" id="L2787">                putBoolean(AUTOCOMPLETER_LAST_FIRST, false);</span>
<span class="nc" id="L2788">                putBoolean(AUTOCOMPLETER_FIRST_LAST, false);</span>
<span class="nc bnc" id="L2789" title="All 2 branches missed.">            } else if (autoCompletePreferences.getNameFormat() == AutoCompletePreferences.NameFormat.LAST_FIRST) {</span>
<span class="nc" id="L2790">                putBoolean(AUTOCOMPLETER_LAST_FIRST, true);</span>
<span class="nc" id="L2791">                putBoolean(AUTOCOMPLETER_FIRST_LAST, false);</span>
            } else {
<span class="nc" id="L2793">                putBoolean(AUTOCOMPLETER_LAST_FIRST, false);</span>
<span class="nc" id="L2794">                putBoolean(AUTOCOMPLETER_FIRST_LAST, true);</span>
            }
<span class="nc" id="L2796">        });</span>

<span class="nc" id="L2798">        return autoCompletePreferences;</span>
    }

    @Override
    public SpecialFieldsPreferences getSpecialFieldsPreferences() {
<span class="nc bnc" id="L2803" title="All 2 branches missed.">        if (specialFieldsPreferences != null) {</span>
<span class="nc" id="L2804">            return specialFieldsPreferences;</span>
        }

<span class="nc" id="L2807">        specialFieldsPreferences = new SpecialFieldsPreferences(getBoolean(SPECIALFIELDSENABLED));</span>

<span class="nc" id="L2809">        EasyBind.listen(specialFieldsPreferences.specialFieldsEnabledProperty(), (obs, oldValue, newValue) -&gt; putBoolean(SPECIALFIELDSENABLED, newValue));</span>

<span class="nc" id="L2811">        return specialFieldsPreferences;</span>
    }

    @Override
    public MrDlibPreferences getMrDlibPreferences() {
<span class="nc bnc" id="L2816" title="All 2 branches missed.">        if (mrDlibPreferences != null) {</span>
<span class="nc" id="L2817">            return mrDlibPreferences;</span>
        }

<span class="nc" id="L2820">        mrDlibPreferences = new MrDlibPreferences(</span>
<span class="nc" id="L2821">                getBoolean(ACCEPT_RECOMMENDATIONS),</span>
<span class="nc" id="L2822">                getBoolean(SEND_LANGUAGE_DATA),</span>
<span class="nc" id="L2823">                getBoolean(SEND_OS_DATA),</span>
<span class="nc" id="L2824">                getBoolean(SEND_TIMEZONE_DATA));</span>

<span class="nc" id="L2826">        EasyBind.listen(mrDlibPreferences.acceptRecommendationsProperty(), (obs, oldValue, newValue) -&gt; putBoolean(ACCEPT_RECOMMENDATIONS, newValue));</span>
<span class="nc" id="L2827">        EasyBind.listen(mrDlibPreferences.sendLanguageProperty(), (obs, oldValue, newValue) -&gt; putBoolean(SEND_LANGUAGE_DATA, newValue));</span>
<span class="nc" id="L2828">        EasyBind.listen(mrDlibPreferences.sendOsProperty(), (obs, oldValue, newValue) -&gt; putBoolean(SEND_OS_DATA, newValue));</span>
<span class="nc" id="L2829">        EasyBind.listen(mrDlibPreferences.sendTimezoneProperty(), (obs, oldValue, newValue) -&gt; putBoolean(SEND_TIMEZONE_DATA, newValue));</span>

<span class="nc" id="L2831">        return mrDlibPreferences;</span>
    }

    @Override
    public ProtectedTermsPreferences getProtectedTermsPreferences() {
<span class="nc bnc" id="L2836" title="All 2 branches missed.">        if (protectedTermsPreferences != null) {</span>
<span class="nc" id="L2837">            return protectedTermsPreferences;</span>
        }

<span class="nc" id="L2840">        protectedTermsPreferences = new ProtectedTermsPreferences(</span>
<span class="nc" id="L2841">                getStringList(PROTECTED_TERMS_ENABLED_INTERNAL),</span>
<span class="nc" id="L2842">                getStringList(PROTECTED_TERMS_ENABLED_EXTERNAL),</span>
<span class="nc" id="L2843">                getStringList(PROTECTED_TERMS_DISABLED_INTERNAL),</span>
<span class="nc" id="L2844">                getStringList(PROTECTED_TERMS_DISABLED_EXTERNAL)</span>
        );

<span class="nc" id="L2847">        protectedTermsPreferences.getEnabledExternalTermLists().addListener((InvalidationListener) change -&gt;</span>
<span class="nc" id="L2848">                putStringList(PROTECTED_TERMS_ENABLED_EXTERNAL, protectedTermsPreferences.getEnabledExternalTermLists()));</span>
<span class="nc" id="L2849">        protectedTermsPreferences.getDisabledExternalTermLists().addListener((InvalidationListener) change -&gt;</span>
<span class="nc" id="L2850">                putStringList(PROTECTED_TERMS_DISABLED_EXTERNAL, protectedTermsPreferences.getDisabledExternalTermLists()));</span>
<span class="nc" id="L2851">        protectedTermsPreferences.getEnabledInternalTermLists().addListener((InvalidationListener) change -&gt;</span>
<span class="nc" id="L2852">                putStringList(PROTECTED_TERMS_ENABLED_INTERNAL, protectedTermsPreferences.getEnabledInternalTermLists()));</span>
<span class="nc" id="L2853">        protectedTermsPreferences.getDisabledInternalTermLists().addListener((InvalidationListener) change -&gt;</span>
<span class="nc" id="L2854">                putStringList(PROTECTED_TERMS_DISABLED_INTERNAL, protectedTermsPreferences.getDisabledInternalTermLists()));</span>

<span class="nc" id="L2856">        return protectedTermsPreferences;</span>
    }

    //*************************************************************************************************************
    // Importer preferences
    //*************************************************************************************************************

    @Override
    public ImporterPreferences getImporterPreferences() {
<span class="nc bnc" id="L2865" title="All 2 branches missed.">        if (importerPreferences != null) {</span>
<span class="nc" id="L2866">            return importerPreferences;</span>
        }

<span class="nc" id="L2869">        importerPreferences = new ImporterPreferences(</span>
<span class="nc" id="L2870">                getBoolean(IMPORTERS_ENABLED),</span>
<span class="nc" id="L2871">                getBoolean(GENERATE_KEY_ON_IMPORT),</span>
<span class="nc" id="L2872">                Path.of(get(IMPORT_WORKING_DIRECTORY)),</span>
<span class="nc" id="L2873">                getBoolean(WARN_ABOUT_DUPLICATES_IN_INSPECTION),</span>
<span class="nc" id="L2874">                getCustomImportFormats(),</span>
<span class="nc" id="L2875">                getFetcherKeys(),</span>
<span class="nc" id="L2876">                getBoolean(FETCHER_CUSTOM_KEY_PERSIST),</span>
<span class="nc" id="L2877">                getStringList(SEARCH_CATALOGS));</span>

<span class="nc" id="L2879">        EasyBind.listen(importerPreferences.importerEnabledProperty(), (obs, oldValue, newValue) -&gt; putBoolean(IMPORTERS_ENABLED, newValue));</span>
<span class="nc" id="L2880">        EasyBind.listen(importerPreferences.generateNewKeyOnImportProperty(), (obs, oldValue, newValue) -&gt; putBoolean(GENERATE_KEY_ON_IMPORT, newValue));</span>
<span class="nc" id="L2881">        EasyBind.listen(importerPreferences.importWorkingDirectoryProperty(), (obs, oldValue, newValue) -&gt; put(IMPORT_WORKING_DIRECTORY, newValue.toString()));</span>
<span class="nc" id="L2882">        EasyBind.listen(importerPreferences.warnAboutDuplicatesOnImportProperty(), (obs, oldValue, newValue) -&gt; putBoolean(WARN_ABOUT_DUPLICATES_IN_INSPECTION, newValue));</span>
<span class="nc" id="L2883">        EasyBind.listen(importerPreferences.persistCustomKeysProperty(), (obs, oldValue, newValue) -&gt; putBoolean(FETCHER_CUSTOM_KEY_PERSIST, newValue));</span>
<span class="nc" id="L2884">        importerPreferences.getApiKeys().addListener((InvalidationListener) c -&gt; storeFetcherKeys(importerPreferences.getApiKeys()));</span>
<span class="nc" id="L2885">        importerPreferences.getCustomImporters().addListener((InvalidationListener) c -&gt; storeCustomImportFormats(importerPreferences.getCustomImporters()));</span>
<span class="nc" id="L2886">        importerPreferences.getCatalogs().addListener((InvalidationListener) c -&gt; putStringList(SEARCH_CATALOGS, importerPreferences.getCatalogs()));</span>

<span class="nc" id="L2888">        return importerPreferences;</span>
    }

    private Set&lt;CustomImporter&gt; getCustomImportFormats() {
<span class="nc" id="L2892">        Set&lt;CustomImporter&gt; importers = new TreeSet&lt;&gt;();</span>

<span class="nc bnc" id="L2894" title="All 2 branches missed.">        for (String toImport : getSeries(CUSTOM_IMPORT_FORMAT)) {</span>
<span class="nc" id="L2895">            List&lt;String&gt; importerString = convertStringToList(toImport);</span>
            try {
<span class="nc bnc" id="L2897" title="All 2 branches missed.">                if (importerString.size() == 2) {</span>
                    // New format: basePath, className
<span class="nc" id="L2899">                    importers.add(new CustomImporter(importerString.getFirst(), importerString.get(1)));</span>
                } else {
                    // Old format: name, cliId, className, basePath
<span class="nc" id="L2902">                    importers.add(new CustomImporter(importerString.get(3), importerString.get(2)));</span>
                }
<span class="nc" id="L2904">            } catch (Exception e) {</span>
<span class="nc" id="L2905">                LOGGER.warn(&quot;Could not load {} from preferences. Will ignore.&quot;, importerString.getFirst(), e);</span>
<span class="nc" id="L2906">            }</span>
<span class="nc" id="L2907">        }</span>

<span class="nc" id="L2909">        return importers;</span>
    }

    private void storeCustomImportFormats(Set&lt;CustomImporter&gt; importers) {
<span class="nc" id="L2913">        purgeSeries(CUSTOM_IMPORT_FORMAT, 0);</span>
<span class="nc" id="L2914">        CustomImporter[] importersArray = importers.toArray(new CustomImporter[0]);</span>
<span class="nc bnc" id="L2915" title="All 2 branches missed.">        for (int i = 0; i &lt; importersArray.length; i++) {</span>
<span class="nc" id="L2916">            putStringList(CUSTOM_IMPORT_FORMAT + i, importersArray[i].getAsStringList());</span>
        }
<span class="nc" id="L2918">    }</span>

    private Set&lt;FetcherApiKey&gt; getFetcherKeys() {
<span class="nc" id="L2921">        Set&lt;FetcherApiKey&gt; fetcherApiKeys = new HashSet&lt;&gt;();</span>

<span class="nc" id="L2923">        List&lt;String&gt; names = getStringList(FETCHER_CUSTOM_KEY_NAMES);</span>
<span class="nc" id="L2924">        List&lt;String&gt; uses = getStringList(FETCHER_CUSTOM_KEY_USES);</span>
<span class="nc" id="L2925">        List&lt;String&gt; keys = getFetcherKeysFromKeyring(names);</span>

<span class="nc bnc" id="L2927" title="All 2 branches missed.">        for (int i = 0; i &lt; names.size(); i++) {</span>
<span class="nc" id="L2928">            fetcherApiKeys.add(new FetcherApiKey(</span>
<span class="nc" id="L2929">                    names.get(i),</span>
                    // i &lt; uses.size() ? Boolean.parseBoolean(uses.get(i)) : false
<span class="nc bnc" id="L2931" title="All 4 branches missed.">                    (i &lt; uses.size()) &amp;&amp; Boolean.parseBoolean(uses.get(i)),</span>
<span class="nc bnc" id="L2932" title="All 2 branches missed.">                    i &lt; keys.size() ? keys.get(i) : &quot;&quot;));</span>
        }

<span class="nc" id="L2935">        return fetcherApiKeys;</span>
    }

    private List&lt;String&gt; getFetcherKeysFromKeyring(List&lt;String&gt; names) {
<span class="nc" id="L2939">        List&lt;String&gt; keys = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L2941">        try (final Keyring keyring = Keyring.create()) {</span>
<span class="nc bnc" id="L2942" title="All 2 branches missed.">            for (String fetcher : names) {</span>
                try {
<span class="nc" id="L2944">                    keys.add(new Password(</span>
<span class="nc" id="L2945">                            keyring.getPassword(&quot;org.jabref.customapikeys&quot;, fetcher),</span>
<span class="nc" id="L2946">                            getInternalPreferences().getUserAndHost())</span>
<span class="nc" id="L2947">                            .decrypt());</span>
<span class="nc" id="L2948">                } catch (PasswordAccessException ex) {</span>
<span class="nc" id="L2949">                    LOGGER.debug(&quot;No api key stored for {} fetcher&quot;, fetcher);</span>
<span class="nc" id="L2950">                    keys.add(&quot;&quot;);</span>
<span class="nc" id="L2951">                }</span>
<span class="nc" id="L2952">            }</span>
<span class="nc" id="L2953">        } catch (Exception ex) {</span>
<span class="nc" id="L2954">            LOGGER.warn(&quot;JabRef could not open the key store&quot;);</span>
<span class="nc" id="L2955">        }</span>

<span class="nc" id="L2957">        return keys;</span>
    }

    private void storeFetcherKeys(Set&lt;FetcherApiKey&gt; fetcherApiKeys) {
<span class="nc" id="L2961">        List&lt;String&gt; names = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2962">        List&lt;String&gt; uses = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2963">        List&lt;String&gt; keys = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L2965" title="All 2 branches missed.">        for (FetcherApiKey apiKey : fetcherApiKeys) {</span>
<span class="nc" id="L2966">            names.add(apiKey.getName());</span>
<span class="nc" id="L2967">            uses.add(String.valueOf(apiKey.shouldUse()));</span>
<span class="nc" id="L2968">            keys.add(apiKey.getKey());</span>
<span class="nc" id="L2969">        }</span>

<span class="nc" id="L2971">        putStringList(FETCHER_CUSTOM_KEY_NAMES, names);</span>
<span class="nc" id="L2972">        putStringList(FETCHER_CUSTOM_KEY_USES, uses);</span>

<span class="nc bnc" id="L2974" title="All 2 branches missed.">        if (getBoolean(FETCHER_CUSTOM_KEY_PERSIST)) {</span>
<span class="nc" id="L2975">            storeFetcherKeysToKeyring(names, keys);</span>
        } else {
<span class="nc" id="L2977">            clearCustomFetcherKeys();</span>
        }
<span class="nc" id="L2979">    }</span>

    private void storeFetcherKeysToKeyring(List&lt;String&gt; names, List&lt;String&gt; keys) {
<span class="nc" id="L2982">        try (final Keyring keyring = Keyring.create()) {</span>
<span class="nc bnc" id="L2983" title="All 2 branches missed.">            for (int i = 0; i &lt; names.size(); i++) {</span>
<span class="nc bnc" id="L2984" title="All 2 branches missed.">                if (StringUtil.isNullOrEmpty(keys.get(i))) {</span>
                    try {
<span class="nc" id="L2986">                        keyring.deletePassword(&quot;org.jabref.customapikeys&quot;, names.get(i));</span>
<span class="nc" id="L2987">                    } catch (PasswordAccessException ex) {</span>
                        // Already removed
<span class="nc" id="L2989">                    }</span>
                } else {
<span class="nc" id="L2991">                    keyring.setPassword(&quot;org.jabref.customapikeys&quot;, names.get(i), new Password(</span>
<span class="nc" id="L2992">                            keys.get(i),</span>
<span class="nc" id="L2993">                            getInternalPreferences().getUserAndHost())</span>
<span class="nc" id="L2994">                            .encrypt());</span>
                }
            }
<span class="nc" id="L2997">        } catch (Exception ex) {</span>
<span class="nc" id="L2998">            LOGGER.error(&quot;Unable to open key store&quot;);</span>
<span class="nc" id="L2999">        }</span>
<span class="nc" id="L3000">    }</span>

    private void clearCustomFetcherKeys() {
<span class="nc" id="L3003">        List&lt;String&gt; names = getStringList(FETCHER_CUSTOM_KEY_NAMES);</span>
<span class="nc" id="L3004">        try (final Keyring keyring = Keyring.create()) {</span>
<span class="nc bnc" id="L3005" title="All 2 branches missed.">            for (String name : names) {</span>
<span class="nc" id="L3006">                keyring.deletePassword(&quot;org.jabref.customapikeys&quot;, name);</span>
<span class="nc" id="L3007">            }</span>
<span class="nc" id="L3008">        } catch (Exception ex) {</span>
<span class="nc" id="L3009">            LOGGER.error(&quot;Unable to open key store&quot;);</span>
<span class="nc" id="L3010">        }</span>
<span class="nc" id="L3011">    }</span>

    @Override
    public GrobidPreferences getGrobidPreferences() {
<span class="nc bnc" id="L3015" title="All 2 branches missed.">        if (grobidPreferences != null) {</span>
<span class="nc" id="L3016">            return grobidPreferences;</span>
        }

<span class="nc" id="L3019">        grobidPreferences = new GrobidPreferences(</span>
<span class="nc" id="L3020">                getBoolean(GROBID_ENABLED),</span>
<span class="nc" id="L3021">                getBoolean(GROBID_OPT_OUT),</span>
<span class="nc" id="L3022">                get(GROBID_URL));</span>

<span class="nc" id="L3024">        EasyBind.listen(grobidPreferences.grobidEnabledProperty(), (obs, oldValue, newValue) -&gt; putBoolean(GROBID_ENABLED, newValue));</span>
<span class="nc" id="L3025">        EasyBind.listen(grobidPreferences.grobidOptOutProperty(), (obs, oldValue, newValue) -&gt; putBoolean(GROBID_OPT_OUT, newValue));</span>
<span class="nc" id="L3026">        EasyBind.listen(grobidPreferences.grobidURLProperty(), (obs, oldValue, newValue) -&gt; put(GROBID_URL, newValue));</span>

<span class="nc" id="L3028">        return grobidPreferences;</span>
    }

    @Override
    public ImportFormatPreferences getImportFormatPreferences() {
<span class="nc" id="L3033">        return new ImportFormatPreferences(</span>
<span class="nc" id="L3034">                getBibEntryPreferences(),</span>
<span class="nc" id="L3035">                getCitationKeyPatternPreferences(),</span>
<span class="nc" id="L3036">                getFieldPreferences(),</span>
<span class="nc" id="L3037">                getXmpPreferences(),</span>
<span class="nc" id="L3038">                getDOIPreferences(),</span>
<span class="nc" id="L3039">                getGrobidPreferences());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>